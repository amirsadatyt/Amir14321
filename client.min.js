/**
 * Minified by jsDelivr using Terser v5.39.0.
 * Original file: /npm/bittorrent-dht@11.0.10/client.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import{EventEmitter}from"events";import bencode from"bencode";import Debug from"debug";import KBucket from"k-bucket";import krpc from"k-rpc";import low from"last-one-wins";import LRU from"lru";import randombytes from"randombytes";import records from"record-cache";import crypto from"crypto";const debug=Debug("bittorrent-dht"),ROTATE_INTERVAL=3e5,BUCKET_OUTDATED_TIMESPAN=9e5;class DHT extends EventEmitter{constructor(e={}){super(),this._tables=new LRU({maxAge:3e5,max:e.maxTables||1e3}),this._values=new LRU(e.maxValues||1e3),this._peers=records({maxAge:e.maxAge||0,maxSize:e.maxPeers||1e4}),this._secrets=null,this._hash=e.hash||sha1,this._hashLength=this._hash(Buffer.from("")).length,this._rpc=e.krpc||krpc(Object.assign({idLength:this._hashLength},e)),this._rpc.on("query",(function(e,t){s._onquery(e,t)})),this._rpc.on("node",(function(e){s.emit("node",e)})),this._rpc.on("warning",(function(e){s.emit("warning",e)})),this._rpc.on("error",(function(e){s.emit("error",e)})),this._rpc.on("listening",(function(){s.listening=!0,s._debug("listening %d",s.address().port),s.updateBucketTimestamp(),s._setBucketCheckInterval(),s.emit("listening")})),this._rotateSecrets(),this._verify=e.verify||null,this._host=e.host||null,this._interval=setInterval((function(){s._rotateSecrets()}),3e5),this._runningBucketCheck=!1,this._bucketCheckTimeout=null,this._bucketOutdatedTimeSpan=e.timeBucketOutdated||9e5,this.listening=!1,this.destroyed=!1,this.nodeId=this._rpc.id,this.nodes=this._rpc.nodes;const t=low((function(e,t){const r=e.older,n=e.swap;s._debug("received ping",r),s._checkNodes(r,!1,((e,r)=>{if(r)return s._debug("swaping dead node with newer",r),n(r),t();s._debug("no node added, all other nodes ok"),t()}))}));this._rpc.on("ping",((e,s)=>{t({older:e,swap:s})})),process.nextTick((function(){s.destroyed||s._bootstrap(!1!==e.bootstrap)})),this._debug("new DHT %s",this.nodeId);const s=this}_setBucketCheckInterval(){const e=this;function t(){if(Date.now()-e._rpc.nodes.metadata.lastChange<e._bucketOutdatedTimeSpan)return s();e._pingAll((()=>{e.destroyed||(e.nodes.toArray().length<1&&e._bootstrap(!0),s())}))}function s(){if(!e._runningBucketCheck||e.destroyed)return;const s=Math.floor(6e4*Math.random()+3e4);e._bucketCheckTimeout=setTimeout(t,s)}this._runningBucketCheck=!0,s()}_pingAll(e){this._checkAndRemoveNodes(this.nodes.toArray(),e)}removeBucketCheckInterval(){this._runningBucketCheck=!1,clearTimeout(this._bucketCheckTimeout)}updateBucketTimestamp(){this._rpc.nodes.metadata.lastChange=Date.now()}_checkAndRemoveNodes(e,t){const s=this;this._checkNodes(e,!0,((e,r)=>{r&&s.removeNode(r.id),t(null,r)}))}_checkNodes(e,t,s){const r=this;!function e(n){let i=null;for(;n.length&&(i=n.pop(),i.id&&!t)&&!(Date.now()-(i.seen||0)>1e4);)i=null;if(!i)return s(null);r._sendPing(i,(t=>{if(!t)return r.updateBucketTimestamp(),e(n);s(null,i)}))}(e)}addNode(e){const t=this;if(e.id){e.id=toBuffer(e.id);const t=!!this._rpc.nodes.get(e.id);return this._rpc.nodes.add(e),void(t||(this.emit("node",e),this.updateBucketTimestamp()))}this._sendPing(e,((e,s)=>{s&&t.addNode(s)}))}removeNode(e){this._rpc.nodes.remove(toBuffer(e))}_sendPing(e,t){const s=this,r=e.id;this._rpc.query(e,{q:"ping"},((e,n,i)=>e?t(e):n.r&&n.r.id&&Buffer.isBuffer(n.r.id)&&n.r.id.length===s._hashLength?Buffer.isBuffer(r)&&!r.equals(n.r.id)?t(new Error("Unexpected node id")):(s.updateBucketTimestamp(),void t(null,{id:n.r.id,host:i.host||i.address,port:i.port})):t(new Error("Bad reply"))))}toJSON(){const e=this,t={};return Object.keys(this._values.cache).forEach((s=>{const r=e._values.cache[s].value;t[s]={v:r.v.toString("hex"),id:r.id.toString("hex")},null!=r.seq&&(t[s].seq=r.seq),null!=r.sig&&(t[s].sig=r.sig.toString("hex")),null!=r.k&&(t[s].k=r.k.toString("hex"))})),{nodes:this._rpc.nodes.toArray().map(toNode),values:t}}put(e,t){(Buffer.isBuffer(e)||"string"==typeof e)&&(e={v:e});const s=!!e.k;if(void 0===e.v)throw new Error("opts.v not given");if(e.v.length>=1e3)throw new Error("v must be less than 1000 bytes in put()");if(s&&void 0!==e.cas&&"number"!=typeof e.cas)throw new Error("opts.cas must be an integer if provided");if(s&&32!==e.k.length)throw new Error("opts.k ed25519 public key must be 32 bytes");if(s&&"function"!=typeof e.sign&&!Buffer.isBuffer(e.sig))throw new Error("opts.sign function or options.sig signature is required for mutable put");if(s&&e.salt&&e.salt.length>64)throw new Error("opts.salt is > 64 bytes long");if(s&&void 0===e.seq)throw new Error("opts.seq not provided for a mutable update");if(s&&"number"!=typeof e.seq)throw new Error("opts.seq not an integer");return this._put(e,t)}_put(e,t){t||(t=noop);const s=!!e.k,r="string"==typeof e.v?Buffer.from(e.v):e.v,n=s?this._hash(e.salt?Buffer.concat([e.k,e.salt]):e.k):this._hash(bencode.encode(r)),i=this._tables.get(n.toString("hex"));if(!i)return this._preput(n,e,t);const o={q:"put",a:{id:this._rpc.id,token:null,v:r}};return s?("number"==typeof e.cas&&(o.a.cas=e.cas),e.salt&&(o.a.salt=e.salt),o.a.k=e.k,o.a.seq=e.seq,"function"==typeof e.sign?o.a.sig=e.sign(encodeSigData(o.a)):Buffer.isBuffer(e.sig)&&(o.a.sig=e.sig)):this._values.set(n.toString("hex"),o.a),this._rpc.queryAll(i.closest(n),o,null,((e,s)=>{if(e)return t(e,n,s);t(null,n,s)})),n}_preput(e,t,s){const r=this;return this._closest(e,{q:"get",a:{id:this._rpc.id,target:e}},null,((e,n)=>{if(e)return s(e);r.put(t,s)})),e}get(e,t,s){e=toBuffer(e),"function"==typeof t&&(s=t,t=null),t||(t={});const r=t.verify||this._verify,n=this._hash;let i=this._values.get(e.toString("hex"))||null;if(i&&!1!==t.cache)return i=createGetResponse(this._rpc.id,null,i),process.nextTick(o);function o(e){if(e)return s(e);s(null,i)}this._closest(e,{q:"get",a:{id:this._rpc.id,target:e}},(function(s){const o=s.r;if(!o||!o.v)return!0;const h=o.k||o.sig;t.salt&&(o.salt=Buffer.from(t.salt));if(h){if(!r||!o.sig||!o.k)return!0;if(!r(o.sig,encodeSigData(o),o.k))return!0;n(o.salt?Buffer.concat([o.k,o.salt]):o.k).equals(e)&&(!i||o.seq>i.seq)&&(i=o)}else if(n(bencode.encode(o.v)).equals(e))return i=o,!1;return!0}),o)}announce(e,t,s){if("function"==typeof t)return this.announce(e,0,t);e=toBuffer(e),s||(s=noop);const r=this._tables.get(e.toString("hex"));if(!r)return this._preannounce(e,t,s);if(this._host){const s=this.listening?this.address().port:0;this._addPeer({host:this._host,port:t||s},e,{host:this._host,port:s})}const n={q:"announce_peer",a:{id:this._rpc.id,token:null,info_hash:e,port:t,implied_port:t?0:1}};this._debug("announce %s %d",e,t),this._rpc.queryAll(r.closest(e),n,null,s)}_preannounce(e,t,s){const r=this;this.lookup(e,(n=>r.destroyed?s(new Error("dht is destroyed")):n?s(n):void r.announce(e,t,s)))}lookup(e,t){e=toBuffer(e),t||(t=noop);const s=this;let r=!1;function n(t,r){t||(t=s._peers.get(e.toString("hex"),100));const n=decodePeers(t);for(let t=0;t<n.length;t++)s.emit("peer",n[t],e,r||null)}return this._debug("lookup %s",e),process.nextTick(n),this._closest(e,{q:"get_peers",a:{id:this._rpc.id,info_hash:e}},(function(e,t){if(r)return!1;e.r.values&&n(e.r.values,t)}),t),function(){r=!0}}address(){return this._rpc.address()}listen(...e){this._rpc.bind(...e)}destroy(e){if(this.destroyed)return void(e&&process.nextTick(e));this.destroyed=!0;const t=this;clearInterval(this._interval),this.removeBucketCheckInterval(),this._peers.destroy(),this._debug("destroying"),this._rpc.destroy((()=>{t.emit("close"),e&&e()}))}_onquery(e,t){if(void 0===e.q||null===e.q)return;const s=e.q.toString();if(this._debug("received %s query from %s:%d",s,t.address,t.port),e.a)switch(s){case"ping":return this._rpc.response(t,e,{id:this._rpc.id});case"find_node":return this._onfindnode(e,t);case"get_peers":return this._ongetpeers(e,t);case"announce_peer":return this._onannouncepeer(e,t);case"get":return this._onget(e,t);case"put":return this._onput(e,t)}}_onfindnode(e,t){const s=e.a.target;if(!s)return this._rpc.error(t,e,[203,"`find_node` missing required `a.target` field"]);this.emit("find_node",s);const r=this._rpc.nodes.closest(s);this._rpc.response(t,e,{id:this._rpc.id},r)}_ongetpeers(e,t){const s=t.address||t.host,r=e.a.info_hash;if(!r)return this._rpc.error(t,e,[203,"`get_peers` missing required `a.info_hash` field"]);this.emit("get_peers",r);const n={id:this._rpc.id,token:this._generateToken(s)},i=this._peers.get(r.toString("hex"));i.length?(n.values=i,this._rpc.response(t,e,n)):this._rpc.response(t,e,n,this._rpc.nodes.closest(r))}_onannouncepeer(e,t){const s=t.address||t.host,r=e.a.implied_port?t.port:e.a.port;if(!r||"number"!=typeof r||r<=0||r>65535)return;const n=e.a.info_hash,i=e.a.token;if(n&&i){if(!this._validateToken(s,i))return this._rpc.error(t,e,[203,"cannot `announce_peer` with bad token"]);this.emit("announce_peer",n,{host:s,port:t.port}),this._addPeer({host:s,port:r},n,{host:s,port:t.port}),this._rpc.response(t,e,{id:this._rpc.id})}}_addPeer(e,t,s){this._peers.add(t.toString("hex"),encodePeer(e.host,e.port)),this.emit("announce",e,t,s)}_onget(e,t){const s=t.address||t.host,r=e.a.target;if(!r)return;const n=this._generateToken(s),i=this._values.get(r.toString("hex"));if(this.emit("get",r,i),i)this._rpc.response(t,e,createGetResponse(this._rpc.id,n,i));else{const s=this._rpc.nodes.closest(r);this._rpc.response(t,e,{id:this._rpc.id,token:n},s)}}_onput(e,t){const s=t.address||t.host,r=e.a;if(!r)return;const n=e.a.v;if(!n)return;const i=e.a.id;if(!i)return;const o=r.token;if(!o)return;if(!this._validateToken(s,o))return this._rpc.error(t,e,[203,"cannot `put` with bad token"]);if(n.length>1e3)return this._rpc.error(t,e,[205,"data payload too large"]);const h=!(!r.k&&!r.sig);if(h&&!r.k&&!r.sig)return;const c=h?this._hash(r.salt?Buffer.concat([r.k,r.salt]):r.k):this._hash(bencode.encode(n)),u=c.toString("hex");if(this.emit("put",c,n),h){if(!this._verify)return this._rpc.error(t,e,[400,"verification not supported"]);if(!this._verify(r.sig,encodeSigData(r),r.k))return;const s=this._values.get(u);if(s&&"number"==typeof r.cas&&s.seq!==r.cas)return this._rpc.error(t,e,[301,"CAS mismatch, re-read and try again"]);if(s&&"number"==typeof s.seq&&!(r.seq>s.seq))return this._rpc.error(t,e,[302,"sequence number less than current"]);this._values.set(u,{v:n,k:r.k,salt:r.salt,sig:r.sig,seq:r.seq,id:i})}else this._values.set(u,{v:n,id:i});this._rpc.response(t,e,{id:this._rpc.id})}_bootstrap(e){const t=this;if(!e)return process.nextTick(s);function s(){t.ready||(t._debug("emit ready"),t.ready=!0,t.emit("ready"))}this._rpc.populate(t._rpc.id,{q:"find_node",a:{id:t._rpc.id,target:t._rpc.id}},s)}_closest(e,t,s,r){const n=this,i=new KBucket({localNodeId:e,numberOfNodesPerKBucket:this._rpc.k});this._rpc.closest(e,t,(function(t,r){if(!t.r)return!0;t.r.token&&t.r.id&&Buffer.isBuffer(t.r.id)&&t.r.id.length===n._hashLength&&(n._debug("found node %s (target: %s)",t.r.id,e),i.add({id:t.r.id,host:r.host||r.address,port:r.port,token:t.r.token}));return!s||s(t,r)}),(function(t,s){if(t)return r(t);n._tables.set(e.toString("hex"),i),n._debug("visited %d nodes",s),r(null,s)}))}_debug(){if(!debug.enabled)return;const e=[].slice.call(arguments);e[0]=`[${this.nodeId.toString("hex").substring(0,7)}] ${e[0]}`;for(let t=1;t<e.length;t++)Buffer.isBuffer(e[t])&&(e[t]=e[t].toString("hex"));debug(...e)}_validateToken(e,t){const s=this._generateToken(e,this._secrets[0]),r=this._generateToken(e,this._secrets[1]);return t.equals(s)||t.equals(r)}_generateToken(e,t){return t||(t=this._secrets[0]),this._hash(Buffer.concat([Buffer.from(e),t]))}_rotateSecrets(){this._secrets?(this._secrets[1]=this._secrets[0],this._secrets[0]=randombytes(this._hashLength)):this._secrets=[randombytes(this._hashLength),randombytes(this._hashLength)]}}function noop(){}function sha1(e){return crypto.createHash("sha1").update(e).digest()}function createGetResponse(e,t,s){const r={id:e,token:t,v:s.v};return s.sig&&(r.sig=s.sig,r.k=s.k,"number"==typeof s.seq&&(r.seq=s.seq)),r}function encodePeer(e,t){const s=Buffer.allocUnsafe(6),r=e.split(".");for(let e=0;e<4;e++)s[e]=parseInt(r[e]||0,10);return s.writeUInt16BE(t,4),s}function decodePeers(e){const t=[];try{for(let s=0;s<e.length;s++){const r=e[s].readUInt16BE(4);r&&t.push({host:parseIp(e[s],0),port:r})}}catch(e){}return t}function parseIp(e,t){return`${e[t++]}.${e[t++]}.${e[t++]}.${e[t++]}`}function encodeSigData(e){const t={seq:e.seq||0,v:e.v};return e.salt&&(t.salt=e.salt),bencode.encode(t).slice(1,-1)}function toNode(e){return{host:e.host,port:e.port}}function toBuffer(e){if(Buffer.isBuffer(e))return e;if(ArrayBuffer.isView(e))return Buffer.from(e.buffer,e.byteOffset,e.byteLength);if("string"==typeof e)return Buffer.from(e,"hex");throw new Error("Pass a buffer or a string")}export default DHT;
//# sourceMappingURL=/sm/51e8d20d77437d73227b5c31a9cf43844c4b506ce2109f3be604d3cb806cc0bc.map