<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>محفظة سادات للعملات الرقمية</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&family=Roboto+Mono:wght@700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
</head>
<style>
    :root { --primary-font: 'Tajawal', 'Segoe UI', sans-serif; --mono-font: 'Roboto Mono', monospace; --dark-bg: #1a101a; --medium-bg: #2e1a2e; --light-bg: #3e2a3e; --accent-color-1: #00e676; --accent-color-2: #40c4ff; --text-color: #e0e0e0; --text-muted: #a0a0c0; --success-color: #00e676; --error-color: #ff5252; --info-color: #40c4ff; --warning-color: #ffab40; --border-color: rgba(0, 230, 118, 0.2); }
    body { margin: 0; font-family: var(--primary-font); background-color: var(--dark-bg); color: var(--text-color); text-align: center; padding: 24px; }
    .container { max-width: 800px; margin: 0 auto; background: rgba(46, 26, 46, 0.7); backdrop-filter: blur(12px); padding: 24px; border-radius: 24px; border: 1px solid var(--border-color); }
    h1 { font-size: 2.5rem; font-weight: 700; color: #fff; margin: 0 0 8px 0; background: linear-gradient(90deg, var(--accent-color-1), var(--accent-color-2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    button, label.button { padding: 14px 22px; font-size: 16px; border-radius: 12px; margin: 8px 5px; border: 1px solid var(--border-color); background: var(--medium-bg); color: #fff; transition: all 0.3s ease; cursor: pointer; outline: none; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
    button.primary { font-weight: 700; background: linear-gradient(90deg, var(--accent-color-1), var(--accent-color-2)); border: none; }
    button:hover, label.button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 230, 118, 0.2); }
    .section { background: rgba(26, 16, 26, 0.5); padding: 20px; margin-top: 30px; border-radius: 16px; border: 1px solid var(--border-color); }
    h2 { font-size: 1.5rem; margin-top: 0; }
    .status-box { margin-top: 20px; font-size: 14px; min-height: 50px; line-height: 1.6; text-align: right; background: var(--dark-bg); padding: 15px 20px; border-radius: 12px; white-space: pre-wrap; font-family: var(--mono-font); border: 1px solid var(--border-color); }
    .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.85); align-items: center; justify-content: center; flex-direction: column; }
    .modal-content { background-color: var(--medium-bg); padding: 30px; border: 1px solid var(--border-color); width: 90%; max-width: 500px; border-radius: 16px; text-align: center; }
    #qr-display { margin: 20px auto; background: white; padding: 15px; border-radius: 8px; width: fit-content; }
    .hidden { display: none; }
    .valid { color: var(--success-color); } .invalid { color: var(--error-color); } .info { color: var(--info-color); } .warning { color: var(--warning-color); }
    #video-scanner { display: none; width: 100%; max-width: 400px; border-radius: 8px; margin: 15px auto; border: 1px solid var(--border-color); }
</style>
<body>
<div class="container">
    <h1>محفظة العملات الرقمية</h1>
    <p>SADAT DIGITAL BANKNOTE</p>

    <div class="section" id="wallet-setup">
        <h2>إعداد المحفظة</h2>
        <label for="load-note-image" class="button">١. تحميل صورة العملة (png.)</label>
        <input type="file" id="load-note-image" class="hidden" accept="image/png">
        <label for="load-spend-key" class="button">٢. تحميل مفتاح الإنفاق (json.)</label>
        <input type="file" id="load-spend-key" class="hidden" accept="application/json">
        <div id="setup-status" class="status-box warning">⚠️ يرجى تحميل صورة العملة ومفتاح الإنفاق الخاص بها.</div>
    </div>

    <div class="section hidden" id="wallet-main">
        <h2>تفاصيل العملة</h2>
        <p>الرقم التسلسلي: <strong id="note-serial"></strong></p>
        <p style="font-size: 2rem; font-family: var(--mono-font);">المبلغ: <strong id="note-amount"></strong></p>
        <hr style="border-color: var(--border-color); margin: 20px 0;">
        <button id="send-btn" class="primary">💸 إرسال</button>
        <button id="receive-btn" class="primary">💰 استقبال</button>
        <div id="tx-status" class="status-box info">ℹ️ المحفظة جاهزة للمعاملات.</div>
    </div>
</div>

<div id="tx-modal" class="modal">
    <div class="modal-content">
        <h2 id="modal-title"></h2>
        <p id="modal-instruction"></p>
        
        <video id="video-scanner"></video>
        <div id="qr-display"></div>

        <div id="modal-input-area"></div>
        <div id="modal-actions" style="margin-top: 20px;"></div>

        <button id="modal-cancel-btn" style="margin-top: 15px;">إلغاء</button>
    </div>
</div>

<script type="module">
// --- DEPENDENCIES (Keep these locally for full offline use) ---
import pqcSignFalcon1024 from './pqc-sign-falcon-1024.min.js';
import { shake256, sha3_256 } from 'https://cdn.skypack.dev/js-sha3';

// --- Global State ---
const state = {
    falconApi: null,
    noteData: null,
    spendPrivateKey: null,
    videoStream: null,
};

// --- CONSTANTS ---
const Constants = {
    VALIDATION_PREFIX: "SADAT_V3_PART",
    NUM_QR_CODES: 9
};

// --- DOM Elements ---
const DOMElements = {
    // ... (previous DOM elements are the same)
    loadNoteImage: document.getElementById('load-note-image'),
    loadSpendKey: document.getElementById('load-spend-key'),
    setupStatus: document.getElementById('setup-status'),
    walletSetup: document.getElementById('wallet-setup'),
    walletMain: document.getElementById('wallet-main'),
    noteSerial: document.getElementById('note-serial'),
    noteAmount: document.getElementById('note-amount'),
    sendBtn: document.getElementById('send-btn'),
    receiveBtn: document.getElementById('receive-btn'),
    txStatus: document.getElementById('tx-status'),
    txModal: document.getElementById('tx-modal'),
    modalTitle: document.getElementById('modal-title'),
    modalInstruction: document.getElementById('modal-instruction'),
    qrDisplay: document.getElementById('qr-display'),
    modalInputArea: document.getElementById('modal-input-area'),
    modalActions: document.getElementById('modal-actions'),
    modalCancelBtn: document.getElementById('modal-cancel-btn'),
    videoScanner: document.getElementById('video-scanner'),
};

// --- Utility and Crypto Functions ---
const Utils = {
    // ... (previous Utils functions are the same)
    arrayBufferToBase64: (buffer) => btoa(String.fromCharCode(...new Uint8Array(buffer))),
    base64ToUint8Array: (base64) => Uint8Array.from(atob(base64), c => c.charCodeAt(0)),
    hexToUint8Array: (hex) => new Uint8Array(hex.match(/.{1,2}/g).map(byte => parseInt(byte, 16))),
    updateStatus: (element, message, type = 'info') => {
        element.innerHTML = `<span class="${type}">${message}</span>`;
    },
    async createQrCodeImage(payload) {
        const qr = qrcode(0, 'M');
        qr.addData(payload);
        qr.make();
        const dataUrl = qr.createDataURL(8, 4);
        const img = new Image();
        img.src = dataUrl;
        await new Promise(resolve => { img.onload = resolve; });
        return {img, dataUrl};
    },
    // New function to start QR scanner
    async startQrScanner(onQrCode) {
        if (state.videoStream) {
            state.videoStream.getTracks().forEach(track => track.stop());
        }
        DOMElements.videoScanner.style.display = 'block';
        state.videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        DOMElements.videoScanner.srcObject = state.videoStream;
        DOMElements.videoScanner.play();

        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        
        const scan = () => {
            if (DOMElements.videoScanner.readyState === DOMElements.videoScanner.HAVE_ENOUGH_DATA) {
                canvas.width = DOMElements.videoScanner.videoWidth;
                canvas.height = DOMElements.videoScanner.videoHeight;
                ctx.drawImage(DOMElements.videoScanner, 0, 0, canvas.width, canvas.height);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);
                if (code) {
                    onQrCode(code.data);
                    this.stopQrScanner();
                    return;
                }
            }
            if (state.videoStream) {
                requestAnimationFrame(scan);
            }
        };
        requestAnimationFrame(scan);
    },
    stopQrScanner() {
        if (state.videoStream) {
            state.videoStream.getTracks().forEach(track => track.stop());
            state.videoStream = null;
        }
        DOMElements.videoScanner.style.display = 'none';
    },
    async decodeQrCodeFromImage(file) {
      return new Promise((resolve, reject) => {
        // ... (same as before)
         const reader = new FileReader();
        reader.onload = (event) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = img.width; canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);
                if (code) resolve(code.data); else reject(new Error("لم يتم العثور على رمز QR."));
            };
            img.src = event.target.result;
        };
        reader.readAsDataURL(file);
      });
    }
};

const BankCrypto = (() => {
    // ... (BankCrypto remains the same)
    function hash(message) { return new Uint8Array(sha3_256.arrayBuffer(message)); }
    function hashForSigning(message) { return Utils.hexToUint8Array(shake256(message, 1536)); }

    return {
        hash,
        generateNewKeyPair: () => state.falconApi.keypair(),
        signData: async (data, privateKey) => {
            const dataHash = hashForSigning(data);
            const { signature } = await state.falconApi.sign(dataHash, privateKey);
            return signature;
        },
        verifySignature: (signature, data, publicKey) => {
            const dataHash = hashForSigning(data);
            return state.falconApi.verify(signature, dataHash, publicKey);
        },
        // Decryption placeholder
        async decrypt(encryptedPayload, privateKey) {
             console.warn("Decryption is a placeholder.");
            return new Uint8Array(0); // return empty
        }
    };
})();

// --- Wallet Logic ---
const Wallet = (() => {

    async function loadNote() {
        // ... (logic is same)
        try {
            const file = DOMElements.loadNoteImage.files[0];
            if (!file) return;

            const banknoteImage = new Image();
            banknoteImage.src = URL.createObjectURL(file);
            await new Promise(r => banknoteImage.onload = r);

            const canvas = document.createElement('canvas');
            canvas.width = banknoteImage.width;
            canvas.height = banknoteImage.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(banknoteImage, 0, 0);

            const qrSize = 250, xSpacing = 20, ySpacing = 20;
            const grid = {
                startX: Math.round((canvas.width - ((qrSize * 3) + (xSpacing * 2))) / 2),
                startY: Math.round((canvas.height - ((qrSize * 3) + (ySpacing * 2))) / 2)
            };
            
            const receivedParts = {};
            let foundCount = 0;
            for (let i = 0; i < Constants.NUM_QR_CODES; i++) {
                const row = Math.floor(i / 3), col = i % 3;
                const regionX = grid.startX + col * (qrSize + xSpacing);
                const regionY = grid.startY + row * (qrSize + ySpacing);
                const imageData = ctx.getImageData(regionX, regionY, qrSize, qrSize);
                const code = jsQR(imageData.data, imageData.width, imageData.height);
                if (code && code.data.startsWith(Constants.VALIDATION_PREFIX)) {
                    const match = code.data.substring(Constants.VALIDATION_PREFIX.length).match(/^(\d+)\/(\d+):(.*)$/s);
                    if (match) {
                        receivedParts[parseInt(match[1], 10)] = match[3];
                        foundCount++;
                    }
                }
            }
             if (foundCount < Constants.NUM_QR_CODES) throw new Error("لم يتم قراءة جميع أكواد QR من العملة.");

            let fullPayloadString = '';
            for (let i = 1; i <= Constants.NUM_QR_CODES; i++) {
                fullPayloadString += receivedParts[i];
            }
            
            const compressedData = Utils.base64ToUint8Array(fullPayloadString);
            const jsonString = pako.inflate(compressedData, { to: 'string' });
            state.noteData = JSON.parse(jsonString);

            checkReadyState();

        } catch (e) {
            Utils.updateStatus(DOMElements.setupStatus, `❌ خطأ في تحميل العملة: ${e.message}`, 'error');
            state.noteData = null;
        }
    }

    async function loadKey() {
        // ... (logic is same)
        try {
            const file = DOMElements.loadSpendKey.files[0];
            if (!file) return;
            const keyData = JSON.parse(await file.text());
            if (state.noteData && state.noteData.serial !== keyData.serial) {
                throw new Error("مفتاح الإنفاق لا يطابق الرقم التسلسلي للعملة المحملة.");
            }
            state.spendPrivateKey = Utils.base64ToUint8Array(keyData.spendPrivateKey_b64);
            checkReadyState();
        } catch(e) {
            Utils.updateStatus(DOMElements.setupStatus, `❌ خطأ في تحميل المفتاح: ${e.message}`, 'error');
            state.spendPrivateKey = null;
        }
    }

    function checkReadyState() {
        // ... (logic is same)
        let noteLoaded = !!state.noteData;
        let keyLoaded = !!state.spendPrivateKey;
        Utils.updateStatus(DOMElements.setupStatus, `تم تحميل العملة: ${noteLoaded ? '✅' : '❌'}\nتم تحميل مفتاح الإنفاق: ${keyLoaded ? '✅' : '❌'}`, noteLoaded && keyLoaded ? 'success' : 'warning');
        
        if (noteLoaded && keyLoaded) {
            DOMElements.walletSetup.classList.add('hidden');
            DOMElements.walletMain.classList.remove('hidden');
            DOMElements.noteSerial.textContent = state.noteData.serial;
            DOMElements.noteAmount.textContent = state.noteData.amount.toLocaleString('ar-EG', { style: 'currency', currency: 'EGP' });
        }
    }

    // --- RECEIVE FLOW ---
    async function startReceive() {
        DOMElements.modalTitle.textContent = "استقبال دفعة";
        DOMElements.modalInstruction.textContent = "اعرض هذا الرمز للمرسل لإتمام المعاملة.";
        DOMElements.qrDisplay.innerHTML = '';
        DOMElements.modalInputArea.innerHTML = '';
        DOMElements.modalActions.innerHTML = '';
        DOMElements.txModal.style.display = 'flex';

        const challengeNonce = crypto.randomUUID();
        const challengePayload = JSON.stringify({ nonce: challengeNonce });

        const {img, dataUrl} = await Utils.createQrCodeImage(challengePayload);
        DOMElements.qrDisplay.appendChild(img);

        DOMElements.modalActions.innerHTML = `
            <button id="download-qr-btn">📥 تنزيل الرمز</button>
            <button id="nfc-receive-btn">NFC 📡</button>
        `;
        document.getElementById('download-qr-btn').onclick = () => {
            const a = document.createElement('a');
            a.href = dataUrl;
            a.download = `sadat-receive-qr-${Date.now()}.png`;
            a.click();
        };

        // ... NFC/Bluetooth logic would be added here
        
        DOMElements.modalInputArea.innerHTML = `<hr><p>بعد أن يمسح المرسل الرمز أعلاه، قم بمسح الرمز الذي يعطيك إياه لإتمام العملية:</p>
            <button id="scan-transfer-btn" class="primary">📷 مسح رمز التحويل</button>
            <label for="upload-transfer-qr" class="button">📤 أو رفع صورة الرمز</label>
            <input type="file" id="upload-transfer-qr" class="hidden" accept="image/png">`;

        document.getElementById('scan-transfer-btn').onclick = () => {
             Utils.startQrScanner(data => completeReceive(data, challengeNonce));
        };
        document.getElementById('upload-transfer-qr').onchange = async (e) => {
            const data = await Utils.decodeQrCodeFromImage(e.target.files[0]);
            completeReceive(data, challengeNonce);
        };
    }
    
    async function completeReceive(transferQrData, challengeNonce) {
        try {
            const transferData = JSON.parse(transferQrData);

            if (transferData.nonce !== challengeNonce) {
                throw new Error("رمز غير متطابق! قد تكون هذه المعاملة لشخص آخر أو قديمة.");
            }

            const currentSpendPublicKey = Utils.base64ToUint8Array(state.noteData.spendPublicKey_b64);
            const signedData = JSON.stringify({ transfer: true, nonce: transferData.nonce });
            const signature = Utils.base64ToUint8Array(transferData.signature_b64);
            const isSignatureValid = await BankCrypto.verifySignature(signature, signedData, currentSpendPublicKey);

            if (!isSignatureValid) {
                throw new Error("توقيع المرسل غير صالح!");
            }
            
            // NOTE: This is the simplified part. In a real scenario, this private key would be encrypted.
            const newSpendKey_b64 = transferData.newSpendPrivateKey_b64; 
            if (!newSpendKey_b64) throw new Error("لم يتم استلام مفتاح الإنفاق الجديد من المرسل.");

            state.noteData.spendPublicKey_b64 = transferData.newSpendPublicKey_b64;
            state.noteData.history = state.noteData.history || [];
            state.noteData.history.push({ timestamp: Date.now(), nonce: transferData.nonce });
            state.spendPrivateKey = Utils.base64ToUint8Array(newSpendKey_b64);

            alert("✅ تمت المعاملة بنجاح! لقد أصبحت مالك هذه العملة. تذكر أن تحفظ صورة العملة الجديدة ومفتاح الإنفاق الجديد.");
            resetWallet();

        } catch(err) {
            alert(`❌ فشلت المعاملة: ${err.message}`);
        } finally {
            closeModal();
        }
    }

    // --- SEND FLOW ---
    async function startSend() {
        DOMElements.modalTitle.textContent = "إرسال دفعة";
        DOMElements.modalInstruction.textContent = "امسح رمز الاستجابة السريعة الخاص بالمستلم لبدء التحويل.";
        DOMElements.qrDisplay.innerHTML = '';
        DOMElements.modalInputArea.innerHTML = '';
        DOMElements.modalActions.innerHTML = `
            <button id="scan-challenge-btn" class="primary">📷 مسح رمز المستلم</button>
            <label for="upload-challenge-qr" class="button">📤 أو رفع صورة الرمز</label>
            <input type="file" id="upload-challenge-qr" class="hidden" accept="image/png">
            <button id="nfc-send-btn">NFC 📡</button>
        `;
        DOMElements.txModal.style.display = 'flex';

        document.getElementById('scan-challenge-btn').onclick = () => {
            Utils.startQrScanner(data => completeSend(data));
        };
        document.getElementById('upload-challenge-qr').onchange = async (e) => {
            const data = await Utils.decodeQrCodeFromImage(e.target.files[0]);
            completeSend(data);
        };
        // ... NFC/Bluetooth logic for sending
    }

    async function completeSend(challengeQrData) {
        try {
            const challengeData = JSON.parse(challengeQrData);
            const nonce = challengeData.nonce;

            const newSpendKeyPair = await BankCrypto.generateNewKeyPair();
            const signedData = JSON.stringify({ transfer: true, nonce: nonce });
            const signature = await BankCrypto.signData(signedData, state.spendPrivateKey);
            
            const transferPayload = {
                nonce: nonce,
                signature_b64: Utils.arrayBufferToBase64(signature),
                newSpendPublicKey_b64: Utils.arrayBufferToBase64(newSpendKeyPair.publicKey),
                // INNOVATION: Sending the private key directly for prototype simplicity.
                // In production, this MUST be encrypted using receiver's public key.
                newSpendPrivateKey_b64: Utils.arrayBufferToBase64(newSpendKeyPair.privateKey),
            };

            DOMElements.modalInstruction.textContent = "اطلب من المستلم مسح هذا الرمز لإكمال التحويل.";
            DOMElements.modalActions.innerHTML = ''; // Clear action buttons
            const {img, dataUrl} = await Utils.createQrCodeImage(JSON.stringify(transferPayload));
            DOMElements.qrDisplay.innerHTML = '';
            DOMElements.qrDisplay.appendChild(img);
            DOMElements.modalInputArea.innerHTML = `<button id="download-final-qr-btn">📥 تنزيل رمز التحويل</button>`;
            document.getElementById('download-final-qr-btn').onclick = () => {
                const a = document.createElement('a');
                a.href = dataUrl;
                a.download = `sadat-transfer-qr-${Date.now()}.png`;
                a.click();
            };
            
            // This alert signifies the point of no return for the sender.
            alert("تم إنشاء رمز التحويل. بمجرد أن يمسحه المستلم، ستفقد ملكية هذه العملة.");
            resetWalletOnSuccess(); // The wallet resets, assuming the receiver will complete the action.

        } catch (err) {
            alert(`❌ فشلت المعاملة: ${err.message}`);
            closeModal();
        }
    }
    
    function closeModal() {
        Utils.stopQrScanner();
        DOMElements.txModal.style.display = 'none';
    }

    function resetWallet() {
        state.noteData = null;
        state.spendPrivateKey = null;
        DOMElements.walletMain.classList.add('hidden');
        DOMElements.walletSetup.classList.remove('hidden');
        Utils.updateStatus(DOMElements.setupStatus, `⚠️ يرجى تحميل عملة ومفتاح إنفاق.`, 'warning');
        DOMElements.loadNoteImage.value = '';
        DOMElements.loadSpendKey.value = '';
    }
    
    // A slightly different reset for the sender
    function resetWalletOnSuccess() {
        state.noteData = null;
        state.spendPrivateKey = null;
        DOMElements.walletMain.classList.add('hidden');
        DOMElements.walletSetup.classList.remove('hidden');
        Utils.updateStatus(DOMElements.setupStatus, `✅ تم الإرسال بنجاح. المحفظة فارغة الآن.`, 'success');
        DOMElements.loadNoteImage.value = '';
        DOMElements.loadSpendKey.value = '';
        // We leave the modal open for the receiver to scan.
    }

    return { loadNote, loadKey, startReceive, startSend, resetWallet };
})();

// --- Main Application Setup ---
async function main() {
    Utils.updateStatus(DOMElements.setupStatus, '⏳ جاري تحميل وحدة التشفير Falcon-1024...', 'info');
    try {
        // You MUST host pqc-sign-falcon-1024.min.js on the same server or use a valid CORS policy.
        // For local testing, you can place it in the same folder as your index.html
        state.falconApi = await pqcSignFalcon1024();
        Utils.updateStatus(DOMElements.setupStatus, '✅ المحفظة جاهزة. يرجى تحميل العملة.', 'success');
    } catch (e) {
        Utils.updateStatus(DOMElements.setupStatus, `❌ خطأ فادح: تعذر تحميل وحدات التشفير. تأكد من تشغيل الصفحة عبر خادم HTTPS.`, 'error');
        console.error(e);
        return;
    }

    DOMElements.loadNoteImage.addEventListener('change', Wallet.loadNote);
    DOMElements.loadSpendKey.addEventListener('change', Wallet.loadKey);
    DOMElements.sendBtn.addEventListener('click', Wallet.startSend);
    DOMElements.receiveBtn.addEventListener('click', Wallet.startReceive);
    DOMElements.modalCancelBtn.addEventListener('click', () => {
        Utils.stopQrScanner();
        DOMElements.txModal.style.display = 'none';
        // If the wallet was reset pending a send, restore the main view
        if (!state.noteData) Wallet.resetWallet();
    });
}

main();
</script>
</body>
</html>
