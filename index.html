<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>کیف پول دیجیتال سادات (نسخه نهایی کامل)</title>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; direction: rtl; }
        .view { display: none; }
        .view.active { display: block; }
        .card { background-color: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); width: 350px; text-align: center; }
        input[type="text"], input[type="password"], input[type="file"] { width: calc(100% - 22px); padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; }
        button { width: 100%; padding: 12px; background: linear-gradient(90deg, #4b6cb7, #182848); color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; transition: transform 0.2s; }
        button:hover { transform: translateY(-2px); }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .back-button { background: #6c757d; margin-top: 20px; }
        #validation-status .error, #key-status .error { color: #d93025; font-weight: bold; }
        #validation-status .success, #key-status .success { color: #1e8e3e; font-weight: bold; }
        #validation-status .info { color: #007bff; }
        .upload-step { margin-bottom: 20px; padding: 15px; border: 1px solid #eee; border-radius: 8px; }
        .upload-step h3 { margin-top: 0; color: #333; }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
</head>
<body>

    <div id="login-view" class="view active"><div class="card"><h1>ورود به کیف پول</h1><input type="text" id="uid-input" value="ABCDEFGHIJ"><input type="password" id="password-input" value="12345"><button id="login-button">ورود</button><p id="login-error" class="error-message"></p></div></div>
    <div id="wallet-view" class="view"><div class="card"><h2>کیف پول شما</h2><p>موجودی:</p><h1 id="balance-display">۰ تومان</h1><div class="button-group"><button id="show-charge-view-button">شارژ کیف پول</button><button id="show-send-view-button">ارسال وجه</button><button id="show-receive-view-button">دریافت وجه</button></div></div></div>
    <div id="charge-view" class="view"><div class="card"><h2>شارژ کیف پول</h2><div class="upload-step"><h3>مرحله ۱: بارگذاری کلید عمومی</h3><input type="file" id="public-key-input" accept=".json"><div id="key-status"></div></div><div class="upload-step"><h3>مرحله ۲: اعتبارسنجی اسکناس</h3><input type="file" id="banknote-image-input" accept="image/*" disabled><div id="validation-status"></div></div><div id="charge-confirmation" style="display:none;"><p>اسکناس معتبر است. مبلغ: <b id="validated-amount"></b></p><button id="confirm-charge-button">افزودن به موجودی</button></div><button class="back-button">بازگشت</button></div></div>
    <div id="send-view" class="view"><div class="card"><h2>ارسال وجه</h2><p>این بخش در حال توسعه است.</p><button class="back-button">بازگشت</button></div></div>
    <div id="receive-view" class="view"><div class="card"><h2>دریافت وجه</h2><p>این QR Code را برای فرستنده ارسال کنید.</p><div id="my-qr-code"></div><a id="download-qr-link" download="My-Wallet-QR.png"><button>دانلود QR Code</button></a><button class="back-button">بازگشت</button></div></div>

    <script type="module">
        import pqcSignFalcon1024 from './pqc-sign-falcon-1024.min.js';
        import { shake256 } from 'https://cdn.skypack.dev/js-sha3';

        const Constants = {
            VALIDATION_PREFIX: "SADAT_V2_PART",
            MAX_IMAGE_DIMENSION: 2000,
            NUM_QR_CODES: 9
        };

        const Utils = {
            base64ToUint8Array: (base64) => {
                const binaryString = atob(base64);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                return bytes;
            },
            preprocessImage: (dataUrl) => new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width; canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.filter = 'grayscale(1) contrast(2.5) brightness(1.1)';
                    ctx.drawImage(img, 0, 0);
                    resolve(canvas.toDataURL('image/jpeg'));
                };
                img.onerror = reject;
                img.src = dataUrl;
            }),
            resizeImage: (file, maxSize) => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let { width, height } = img;
                        if (width > height) {
                            if (width > maxSize) { height *= maxSize / width; width = maxSize; }
                        } else {
                            if (height > maxSize) { width *= maxSize / height; height = maxSize; }
                        }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg'));
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            }),
        };
        
        const BankCrypto = (() => {
            const hash = (message) => new Uint8Array(shake256.digest(message));
            return {
                async verifySignature(signature, data, publicKey, falconApi) {
                    const dataHash = hash(data);
                    return falconApi.verify(signature, dataHash, publicKey);
                }
            };
        })();
        
        const getStandardizedDataForSigning = (d) => JSON.stringify({t:d.timestamp, s:d.serial},['t','s']);
        const getStandardizedDataForMasterSig = (d) => {
            const t = {e:btoa(String.fromCharCode.apply(null, d.ephemeralPublicKey)), s:btoa(String.fromCharCode.apply(null, d.signatureOne))};
            return JSON.stringify(t, Object.keys(t).sort());
        };
        const parseUnifiedVerificationPayload = (b64) => {
            const compressed = Utils.base64ToUint8Array(b64);
            const jsonString = pako.inflate(compressed, { to: 'string' });
            const p = JSON.parse(jsonString);
            return {a:p.a, s:p.s, t:p.t, epk:Utils.base64ToUint8Array(p.epk), s1:Utils.base64ToUint8Array(p.s1), s2:Utils.base64ToUint8Array(p.s2)};
        };

        function getQrGridLayout(imageWidth) {
            const originalSize = 790;
            const scale = imageWidth / originalSize;
            return {
                qrSize: Math.round(250 * scale),
                xSpacing: Math.round(20 * scale),
                ySpacing: Math.round(20 * scale),
            };
        }

        async function decodeQrGrid(imageData, statusElement) {
            const layout = getQrGridLayout(imageData.width);
            const foundParts = {};
            let uniqueCodes = 0;
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = imageData.width;
            tempCanvas.height = imageData.height;
            tempCtx.putImageData(imageData, 0, 0);

            for (let i = 0; i < Constants.NUM_QR_CODES; i++) {
                statusElement.innerHTML = `<span class="info">⏳ در حال اسکن ناحیه ${i + 1} از ${Constants.NUM_QR_CODES}...</span>`;
                await new Promise(r => setTimeout(r, 10));

                const row = Math.floor(i / 3);
                const col = i % 3;

                const regionX = col * (layout.qrSize + layout.xSpacing);
                const regionY = row * (layout.qrSize + layout.ySpacing);
                
                const regionImageData = tempCtx.getImageData(regionX, regionY, layout.qrSize, layout.qrSize);
                const code = jsQR(regionImageData.data, regionImageData.width, regionImageData.height);

                if (code && code.data.startsWith(Constants.VALIDATION_PREFIX)) {
                    const payload = code.data.substring(Constants.VALIDATION_PREFIX.length);
                    const match = payload.match(/^(\d+)\/(\d+):(.*)$/s);
                    if (match) {
                        const partNum = parseInt(match[1], 10);
                        if (!foundParts[partNum]) {
                            foundParts[partNum] = match[3];
                            uniqueCodes++;
                        }
                    }
                }
            }

            if (uniqueCodes < Constants.NUM_QR_CODES) {
                throw new Error(`اسکن کامل نشد. ${uniqueCodes} از ${Constants.NUM_QR_CODES} بخش پیدا شد. لطفاً از یک عکس صاف و با نور خوب استفاده کنید.`);
            }

            let fullPayloadString = '';
            for (let i = 1; i <= Constants.NUM_QR_CODES; i++) {
                fullPayloadString += foundParts[i];
            }
            return fullPayloadString;
        }

        const state = { falconApi: null, masterPublicKey: null, currentUser: null, balance: 0 };
        const DOMElements = {
            views: document.querySelectorAll('.view'),
            loginButton: document.getElementById('login-button'),
            loginError: document.getElementById('login-error'),
            balanceDisplay: document.getElementById('balance-display'),
            showChargeViewButton: document.getElementById('show-charge-view-button'),
            showSendViewButton: document.getElementById('show-send-view-button'),
            showReceiveViewButton: document.getElementById('show-receive-view-button'),
            publicKeyInput: document.getElementById('public-key-input'),
            keyStatus: document.getElementById('key-status'),
            banknoteImageInput: document.getElementById('banknote-image-input'),
            validationStatus: document.getElementById('validation-status'),
            chargeConfirmation: document.getElementById('charge-confirmation'),
            validatedAmount: document.getElementById('validated-amount'),
            confirmChargeButton: document.getElementById('confirm-charge-button'),
            myQrCodeContainer: document.getElementById('my-qr-code'),
            downloadQrLink: document.getElementById('download-qr-link'),
            backButtons: document.querySelectorAll('.back-button'),
        };

        function setupEventListeners() {
            DOMElements.loginButton.addEventListener('click', handleLogin);
            DOMElements.showChargeViewButton.addEventListener('click', () => showView('charge-view'));
            DOMElements.showSendViewButton.addEventListener('click', () => showView('send-view'));
            DOMElements.showReceiveViewButton.addEventListener('click', () => {
                generateReceiveQrCode();
                showView('receive-view');
            });
            DOMElements.publicKeyInput.addEventListener('change', handlePublicKeyUpload);
            DOMElements.banknoteImageInput.addEventListener('change', handleBanknoteValidation);
            DOMElements.confirmChargeButton.addEventListener('click', confirmCharge);
            DOMElements.backButtons.forEach(button => {
                button.addEventListener('click', () => {
                    resetChargeView();
                    showView('wallet-view');
                });
            });
        }

        async function initializeApp() {
            try {
                state.falconApi = await pqcSignFalcon1024();
                console.log("سیستم با موفقیت راه‌اندازی شد.");
                setupEventListeners();
            } catch (e) {
                alert("خطای حیاتی در راه‌اندازی برنامه: " + e.message);
                console.error(e);
            }
        }
        
        function showView(id) { DOMElements.views.forEach(v => v.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        function updateBalanceDisplay() { DOMElements.balanceDisplay.textContent = `${state.balance.toLocaleString('fa-IR')} تومان`; }
        function resetChargeView() {
            DOMElements.keyStatus.innerHTML = '';
            DOMElements.validationStatus.innerHTML = '';
            DOMElements.publicKeyInput.value = '';
            DOMElements.banknoteImageInput.value = '';
            DOMElements.banknoteImageInput.disabled = true;
            DOMElements.chargeConfirmation.style.display = 'none';
            state.masterPublicKey = null;
        }

        function handleLogin() {
            const uid = document.getElementById('uid-input').value;
            const password = document.getElementById('password-input').value;
            if (uid === 'ABCDEFGHIJ' && password === '12345') {
                state.currentUser = { uid: uid };
                updateBalanceDisplay();
                showView('wallet-view');
            } else {
                DOMElements.loginError.textContent = 'شناسه کاربری یا رمز عبور اشتباه است.';
            }
        }

        async function handlePublicKeyUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            DOMElements.keyStatus.textContent = '⏳ در حال پردازش کلید...';
            DOMElements.banknoteImageInput.disabled = true;
            state.masterPublicKey = null;
            try {
                const keyData = JSON.parse(await file.text());
                if (!keyData.masterPublicKey) throw new Error("فایل JSON فاقد کلید masterPublicKey است.");
                state.masterPublicKey = Utils.base64ToUint8Array(keyData.masterPublicKey);
                DOMElements.keyStatus.innerHTML = '<span class="success">✅ کلید عمومی بارگذاری شد.</span>';
                DOMElements.banknoteImageInput.disabled = false;
            } catch (err) {
                DOMElements.keyStatus.innerHTML = `<span class="error">❌ خطا: ${err.message}</span>`;
            }
        }

        async function handleBanknoteValidation(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (!state.masterPublicKey) {
                DOMElements.validationStatus.innerHTML = '<span class="error">❌ لطفاً ابتدا کلید عمومی را آپلود کنید.</span>';
                return;
            }
            DOMElements.validationStatus.innerHTML = '<span class="info">⏳ در حال آماده‌سازی تصویر...</span>';
            DOMElements.chargeConfirmation.style.display = 'none';
            try {
                const resizedDataUrl = await Utils.resizeImage(file, Constants.MAX_IMAGE_DIMENSION);
                const processedDataUrl = await Utils.preprocessImage(resizedDataUrl);
                const imageData = await new Promise((resolve, reject) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width; canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        resolve(ctx.getImageData(0, 0, img.width, img.height));
                    };
                    img.onerror = reject;
                    img.src = processedDataUrl;
                });
                const payload = await decodeQrGrid(imageData, DOMElements.validationStatus);
                DOMElements.validationStatus.innerHTML = '<span class="success">✅ تمام بخش‌ها اسکن شد. در حال اعتبارسنجی نهایی...</span>';
                const banknoteData = parseUnifiedVerificationPayload(payload);
                const isSigOneValid = await BankCrypto.verifySignature(banknoteData.s1, getStandardizedDataForSigning(banknoteData), banknoteData.epk, state.falconApi);
                if (!isSigOneValid) throw new Error("امضای اول نامعتبر است.");
                const isSigTwoValid = await BankCrypto.verifySignature(banknoteData.s2, getStandardizedDataForMasterSig(banknoteData), state.masterPublicKey, state.falconApi);
                if (!isSigTwoValid) throw new Error("امضای اصلی نامعتبر است.");
                DOMElements.validationStatus.innerHTML = '<span class="success">✅ اسکناس معتبر است!</span>';
                DOMElements.validatedAmount.textContent = `${banknoteData.a.toLocaleString('fa-IR')} تومان`;
                DOMElements.chargeConfirmation.dataset.amount = banknoteData.a;
                DOMElements.chargeConfirmation.style.display = 'block';
            } catch (err) {
                DOMElements.validationStatus.innerHTML = `<span class="error">❌ خطا: ${err.message}</span>`;
            } finally {
                event.target.value = '';
            }
        }

        function confirmCharge() {
            const amount = parseInt(DOMElements.chargeConfirmation.dataset.amount, 10);
            if(amount > 0) {
                state.balance += amount;
                updateBalanceDisplay();
                alert(`مبلغ ${amount.toLocaleString('fa-IR')} تومان با موفقیت اضافه شد.`);
                resetChargeView();
                showView('wallet-view');
            }
        }
        
        function generateReceiveQrCode() {
            DOMElements.myQrCodeContainer.innerHTML = '';
            const payload = JSON.stringify({type:"SADAT_WALLET_ADDRESS", uid:state.currentUser.uid});
            const qr = qrcode(0,'L');
            qr.addData(payload);
            qr.make();
            DOMElements.myQrCodeContainer.innerHTML = qr.createImgTag(6, 10);
            const img = DOMElements.myQrCodeContainer.querySelector('img');
            const canvas = document.createElement('canvas');
            canvas.width=img.width; canvas.height=img.height;
            canvas.getContext('2d').drawImage(img, 0, 0);
            DOMElements.downloadQrLink.href = canvas.toDataURL('image/png');
        }

        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
