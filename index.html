<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Aura Wallet (Pinata Ledger)</title>
    <style>
        /* CSS styles remain unchanged from the previous version */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');
        :root { --primary-color: #4b6cb7; --secondary-color: #182848; --danger-color: #d9534f; --light-gray: #f0f2f5; --dark-gray: #6c757d; }
        body { font-family: 'Roboto', sans-serif; background-color: var(--light-gray); display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .view { display: none; }
        .view.active { display: block; }
        .card { background-color: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 380px; text-align: center; border-top: 5px solid var(--primary-color); }
        input, textarea { width: calc(100% - 22px); padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; text-align: center; font-family: 'Roboto', sans-serif; }
        textarea { resize: vertical; height: 80px; }
        button { width: 100%; padding: 12px; background: linear-gradient(90deg, var(--primary-color), var(--secondary-color)); color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; transition: all 0.2s; }
        button:hover { opacity: 0.9; transform: translateY(-2px); }
        button:disabled { background: #999; cursor: not-allowed; transform: translateY(0); }
        .back-button { background: var(--dark-gray); margin-top: 10px; }
        .logout-button { background: var(--danger-color); margin-top: 10px; }
        .link-button { background: none; border: none; color: var(--primary-color); text-decoration: underline; cursor: pointer; padding: 5px; width: auto; }
        .status-box { font-weight: bold; min-height: 20px; margin-top: 10px; word-wrap: break-word; }
        .error { color: #d93025; } .success { color: #1e8e3e; } .info { color: #007bff; }
        .seed-phrase-box { padding: 15px; border: 1px dashed var(--danger-color); border-radius: 8px; margin: 20px 0; background-color: #fff8f8; color: #333; font-size: 18px; letter-spacing: 1px; }
        #my-qr-code img, #qr-display-box img { margin: 15px auto; display: block; border: 5px solid #eee; border-radius: 5px; }
        label.qr-upload-label { cursor: pointer; display: block; margin: 15px; padding: 10px; border: 2px dashed #ccc; border-radius: 8px; }
        label.qr-upload-label:hover { background-color: #f9f9f9; }
        input[type="file"] { display: none; }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid var(--primary-color); width: 20px; height: 20px; -webkit-animation: spin 1s linear infinite; animation: spin 1s linear infinite; margin: 10px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="onboarding-view" class="view active"><div class="card"><h1>Aura Wallet</h1><p>A new generation of asset security and control</p><button id="go-to-create-wallet">Create a New Wallet</button><button id="go-to-restore-wallet" class="back-button">Restore Wallet</button></div></div>
    <div id="create-wallet-view" class="view">...</div>
    <div id="seed-phrase-view" class="view">...</div>
    <div id="restore-wallet-view" class="view">...</div>
    <div id="login-view" class="view">...</div>
    
    <div id="wallet-view" class="view"><div class="card">
        <h2>Your Wallet</h2>
        <div id="wallet-status" class="status-box" style="min-height: 10px; margin-bottom: 15px;"></div>
        <p>Balance:</p>
        <h1 id="balance-display">$0.00</h1>
        <button id="check-payments-button">Check for Incoming Payments</button>
        <button id="show-charge-view-button" style="margin-top:10px;">Charge with Banknote</button>
        <button id="show-send-view-button" style="margin-top:10px;">Send</button>
        <button id="show-receive-view-button" style="margin-top:10px;">Receive</button>
        <button id="logout-button" class="logout-button">Logout (Lock Wallet)</button>
    </div></div>
    
    <div id="charge-view" class="view">...</div>
    
    <div id="send-view" class="view"><div class="card">
        <h2>Send Funds</h2>
        <p>Scan the recipient's Payment Request QR code.</p>
        <label for="scan-send-qr-input" class="qr-upload-label">Scan QR Code</label>
        <input type="file" id="scan-send-qr-input" accept="image/*">
        <div id="send-status" class="status-box">Awaiting QR code...</div>
        <button class="back-button" id="back-from-send">Back to Wallet</button>
    </div></div>

    <div id="receive-view" class="view"><div class="card">
        <h2>Receive Funds</h2>
        <p>Enter an amount to generate a Payment Request QR code.</p>
        <input type="number" id="receive-amount-input" placeholder="Amount to Request">
        <button id="generate-receive-qr-btn">Generate Request QR</button>
        <div id="receive-qr-display" style="margin-top: 15px;"></div>
        <p style="font-size: 12px; color: #666;">Show this QR code to the sender.</p>
        <button class="back-button" id="back-from-receive">Back to Wallet</button>
    </div></div>
    
    <div id="payment-confirm-modal" class="view" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); justify-content: center; align-items: center;">
        <div class="card">
            <h2>Confirm Payment</h2>
            <p>You are about to send:</p>
            <h1 id="confirm-payment-amount" style="color: var(--primary-color);"></h1>
            <p>To address:</p>
            <p id="confirm-payment-address" style="font-size: 12px; word-wrap: break-word;"></p>
            <button id="confirm-payment-btn">Confirm & Send</button>
            <button id="cancel-payment-btn" class="back-button">Cancel</button>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    
    <script type="module">
        import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@6.13.1/dist/ethers.min.js";
        import pqcSignFalcon1024 from './pqc-sign-falcon-1024.min.js';
        import { shake256 } from 'https://cdn.skypack.dev/js-sha3';

        // CoreLogic remains unchanged...
        // ...

        // PinataLedger (Supabase Interaction) is EXTENDED for the new flow
        const PinataLedger = (() => {
            const SUPABASE_URL = 'https://hoppdalxbmktxexylbkl.supabase.co/functions/v1/quick-responder';
            // ... (handleApiError, recordSpentIdentifier, hasBeenSpent remain the same) ...

            // NEW function to post a signed transaction to the server
            const postTransaction = async (signedTx) => {
                try {
                    const response = await fetch(SUPABASE_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'post_tx', payload: signedTx })
                    });
                    if (!response.ok) throw new Error(await handleApiError(response));
                    return true;
                } catch (error) {
                    alert(`Transaction Post Error: ${error.message}`);
                    return false;
                }
            };

            // NEW function to fetch transactions for a specific address
            const fetchTransactionsFor = async (address) => {
                try {
                    const url = new URL(SUPABASE_URL);
                    url.searchParams.append('action', 'get_tx');
                    url.searchParams.append('address', address);
                    const response = await fetch(url.toString());
                    if (!response.ok) throw new Error(await handleApiError(response));
                    return await response.json(); // Expects an array of signed transactions
                } catch (error) {
                    alert(`Fetch Payments Error: ${error.message}`);
                    return [];
                }
            };
            
            return { recordSpentIdentifier, hasBeenSpent, postTransaction, fetchTransactionsFor };
        })();
        
        // WalletLogic is updated for the new flow
        const WalletLogic = {
            // ... (createWallet, restoreWallet, login, logout, etc. remain the same) ...

            // NEW function to create and sign a transaction payload
            createSignedTransaction: async (to, amount) => {
                // Add to local chain first to get a hash
                const localTx = WalletLogic.addToChain({ 
                    type: 'send', 
                    from: state.userStore.address,
                    to: to,
                    amount: amount,
                    status: 'completed' // Sender considers it completed immediately
                });

                // Create the signed payload to send to the server
                const txPayload = {
                    from: localTx.from,
                    to: localTx.to,
                    amount: localTx.amount,
                    hash: localTx.hash,
                    timestamp: localTx.timestamp
                };

                const signature = await state.wallet.signMessage(JSON.stringify(txPayload));
                
                return { tx: txPayload, signature };
            }
        };

        // ... (Helper functions like showView, updateBalanceDisplay, etc. remain) ...
        
        async function initializeApp() {
            // ... (remains the same) ...
        }

        function setupEventListeners() {
            // ... (Onboarding, Login, Restore listeners remain the same) ...

            // --- UPDATED MAIN NAVIGATION ---
            document.getElementById('show-charge-view-button').addEventListener('click', () => showView('charge-view'));
            document.getElementById('show-send-view-button').addEventListener('click', () => showView('send-view'));
            document.getElementById('show-receive-view-button').addEventListener('click', () => showView('receive-view'));

            document.getElementById('back-from-charge').addEventListener('click', () => showView('wallet-view'));
            document.getElementById('back-from-send').addEventListener('click', () => showView('wallet-view'));
            document.getElementById('back-from-receive').addEventListener('click', () => showView('wallet-view'));

            // --- RECEIVE VIEW LOGIC ---
            document.getElementById('generate-receive-qr-btn').addEventListener('click', () => {
                const amount = parseFloat(document.getElementById('receive-amount-input').value);
                if (isNaN(amount) || amount <= 0) { alert("Please enter a valid amount."); return; }
                const requestPayload = {
                    type: "AURA_PAYMENT_REQUEST",
                    address: state.userStore.address,
                    amount: amount
                };
                generateQrCode(requestPayload, 'receive-qr-display');
            });

            // --- SEND VIEW LOGIC ---
            document.getElementById('scan-send-qr-input').addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const statusEl = document.getElementById('send-status');
                statusEl.innerHTML = `<span class="info">Processing QR code...</span>`;
                try {
                    const decoded = await decodeQrFromFile(file);
                    if (decoded.type !== "AURA_PAYMENT_REQUEST") throw new Error("This is not a valid Payment Request QR code.");
                    
                    if (WalletLogic.calculateBalance() < decoded.amount) {
                        throw new Error("Insufficient funds.");
                    }
                    // Populate and show the confirmation modal
                    document.getElementById('confirm-payment-amount').textContent = `$${decoded.amount.toFixed(2)}`;
                    document.getElementById('confirm-payment-address').textContent = decoded.address;
                    const confirmBtn = document.getElementById('confirm-payment-btn');
                    confirmBtn.dataset.address = decoded.address;
                    confirmBtn.dataset.amount = decoded.amount;
                    showView('payment-confirm-modal');

                } catch (err) {
                    statusEl.innerHTML = `<span class="error">${err.message}</span>`;
                } finally {
                    event.target.value = '';
                }
            });

            // --- CONFIRM & SEND LOGIC (IN MODAL) ---
            document.getElementById('confirm-payment-btn').addEventListener('click', async (event) => {
                const { address, amount } = event.target.dataset;
                const statusEl = document.getElementById('send-status');
                showView('send-view'); // Go back to send view to show status
                statusEl.innerHTML = '<span class="info">Signing transaction...</span>';
                
                // 1. Create and sign the transaction
                const signedTx = await WalletLogic.createSignedTransaction(address, parseFloat(amount));
                
                // 2. Post it to the central server for the recipient to fetch
                statusEl.innerHTML = '<span class="info">Sending transaction to the network...</span>';
                const success = await PinataLedger.postTransaction(signedTx);

                if (success) {
                    await WalletLogic.backupUserStore();
                    updateBalanceDisplay();
                    statusEl.innerHTML = '<span class="success">Transaction sent successfully!</span>';
                    setTimeout(() => showView('wallet-view'), 2000);
                } else {
                    statusEl.innerHTML = '<span class="error">Failed to send transaction. Please try again.</span>';
                    // Optional: Here you could implement logic to revert the local transaction
                }
            });

            document.getElementById('cancel-payment-btn').addEventListener('click', () => {
                showView('send-view');
            });

            // --- CHECK FOR PAYMENTS LOGIC ---
            document.getElementById('check-payments-button').addEventListener('click', async (event) => {
                const button = event.target;
                const statusEl = document.getElementById('wallet-status');
                button.disabled = true;
                statusEl.innerHTML = '<span class="info">Checking for incoming payments...</span>';
                
                const newTransactions = await PinataLedger.fetchTransactionsFor(state.userStore.address);
                let receivedCount = 0;

                for (const signedTx of newTransactions) {
                    try {
                        const { tx, signature } = signedTx;
                        // Check if we already have this transaction
                        if (state.userStore.chain.find(localTx => localTx.hash === tx.hash)) {
                            continue; // Skip already processed transaction
                        }

                        // Verify signature
                        const signerAddress = ethers.verifyMessage(JSON.stringify(tx), signature);
                        if (signerAddress !== tx.from) {
                            console.warn("Invalid signature on incoming transaction:", tx.hash);
                            continue;
                        }

                        // Add to chain
                        WalletLogic.addToChain({ ...tx, type: 'receive', status: 'completed' });
                        receivedCount++;
                    } catch (e) {
                        console.error("Error processing incoming transaction:", e);
                    }
                }

                if (receivedCount > 0) {
                    await WalletLogic.backupUserStore();
                    updateBalanceDisplay();
                    statusEl.innerHTML = `<span class="success">You received ${receivedCount} new payment(s)!</span>`;
                } else {
                    statusEl.innerHTML = '<span class="info">No new payments found.</span>';
                }
                
                setTimeout(() => { statusEl.innerHTML = ''; button.disabled = false; }, 3000);
            });
        }
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
