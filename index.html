<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>کیف پول دیجیتال چندکاربره سادات</title>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap');
        body { font-family: 'Vazirmatn', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .view { display: none; }
        .view.active { display: block; }
        .card { background-color: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); width: 380px; text-align: center; }
        input[type="text"], input[type="password"], input[type="file"], input[type="number"] { width: calc(100% - 22px); padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; text-align: center; }
        button { width: 100%; padding: 12px; background: linear-gradient(90deg, #4b6cb7, #182848); color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; transition: transform 0.2s; }
        button:hover { transform: translateY(-2px); }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .back-button { background: #6c757d; margin-top: 20px; }
        .logout-button { background: #d9534f; margin-top: 10px; }
        .link-button { background: none; border: none; color: #007bff; text-decoration: underline; cursor: pointer; padding: 5px; width: auto; }
        .status-box { font-weight: bold; min-height: 20px; margin-top: 10px; }
        .status-box .error { color: #d93025; }
        .status-box .success { color: #1e8e3e; }
        .status-box .info { color: #007bff; }
        .upload-step { margin-bottom: 20px; padding: 15px; border: 1px solid #eee; border-radius: 8px; }
        .upload-step h3 { margin-top: 0; color: #333; }
        #my-qr-code img { margin: 15px auto; display: block; border: 5px solid #eee; border-radius: 5px; }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
</head>
<body>

    <div id="login-view" class="view active"><div class="card"><h1>کیف پول دیجیتال</h1><p>برای ادامه وارد شوید.</p><input type="text" id="uid-input" placeholder="نام کاربری"><input type="password" id="password-input" placeholder="رمز عبور"><button id="login-button">ورود</button><div id="login-status" class="status-box"></div><p style="margin-top:20px;">حساب کاربری ندارید؟ <button class="link-button" id="show-register-link">ثبت‌نام کنید</button></p></div></div>
    
    <div id="register-view" class="view"><div class="card"><h1>ایجاد حساب جدید</h1><p>یک نام کاربری و رمز عبور انتخاب کنید.</p><input type="text" id="register-uid-input" placeholder="نام کاربری جدید"><input type="password" id="register-password-input" placeholder="رمز عبور"><button id="register-button">ثبت‌نام</button><div id="register-status" class="status-box"></div><p style="margin-top:20px;">قبلاً ثبت‌نام کرده‌اید؟ <button class="link-button" id="show-login-link">وارد شوید</button></p></div></div>
    
    <div id="wallet-view" class="view"><div class="card"><h2 id="welcome-message">کیف پول من</h2><p>موجودی فعلی:</p><h1 id="balance-display">$0.00</h1><div class="button-group" style="margin-top:20px;"><button id="show-charge-view-button">شارژ کیف پول</button><button id="show-send-view-button" style="margin-top:10px;">ارسال وجه</button><button id="show-receive-view-button" style="margin-top:10px;">دریافت وجه</button><button id="logout-button" class="logout-button">خروج از حساب</button></div></div></div>
    
    <div id="charge-view" class="view"><div class="card"><h2>شارژ کیف پول</h2><div class="upload-step"><h3>مرحله ۱: بارگذاری کلید عمومی</h3><input type="file" id="public-key-input" accept=".json"><div id="key-status" class="status-box"></div></div><div class="upload-step"><h3>مرحله ۲: اعتبارسنجی اسکناس</h3><input type="file" id="banknote-image-input" accept="image/*" disabled><div id="validation-status" class="status-box"></div></div><div id="charge-confirmation" style="display:none; margin-top: 20px;"><p>اعتبارسنجی موفق بود. مبلغ: <b id="validated-amount"></b></p><button id="confirm-charge-button">افزودن به موجودی</button></div><button class="back-button">بازگشت به کیف پول</button></div></div>
    <div id="send-view" class="view"><div class="card"><h2>ارسال وجه</h2><input type="number" id="send-amount-input" placeholder="مبلغ ارسالی"><label for="recipient-qr-input" style="cursor: pointer; display: block; margin-bottom: 15px; text-decoration: underline; color: #007bff;">بارگذاری کد QR گیرنده</label><input type="file" id="recipient-qr-input" accept=".png, .jpg, .jpeg" style="display: none;"><div id="recipient-info" style="min-height: 20px; margin-bottom: 15px;"></div><button id="send-funds-button">ارسال</button><div id="send-status" class="status-box"></div><button class="back-button">بازگشت به کیف پول</button></div></div>
    <div id="receive-view" class="view"><div class="card"><h2>دریافت وجه</h2><p>این کد QR را با فرستنده به اشتراک بگذارید.</p><div id="my-qr-code"></div><a id="download-qr-link"><button>دانلود کد QR (PNG)</button></a><button class="back-button">بازگشت به کیف پول</button></div></div>

    <script type="module">
        import pqcSignFalcon1024 from './pqc-sign-falcon-1024.min.js';
        import { shake256 } from 'https://cdn.skypack.dev/js-sha3';

        // ===================================================================================
        // CORE LOGIC (Unmodified)
        // ===================================================================================
        const CoreLogic = (() => {
            const Constants = { VALIDATION_PREFIX: "SADAT_V2_PART", MAX_IMAGE_DIMENSION: 2000, NUM_QR_CODES: 9 };
            const Utils = {
                arrayBufferToBase64: (b) => btoa(String.fromCharCode(...new Uint8Array(b))),
                base64ToUint8Array: (s) => { const bs=atob(s); const b=new Uint8Array(bs.length); for(let i=0;i<bs.length;i++)b[i]=bs.charCodeAt(i); return b; },
                hexToUint8Array: (h) => new Uint8Array(h.match(/.{1,2}/g).map(b => parseInt(b, 16))),
                preprocessImage: (d) => new Promise((res, rej) => { const i=new Image(); i.onload=()=>{ const c=document.createElement('canvas'); c.width=i.width; c.height=i.height; const x=c.getContext('2d'); x.filter='grayscale(1) contrast(2.5) brightness(1.1)'; x.drawImage(i,0,0); res(c.toDataURL('image/jpeg')); }; i.onerror=rej; i.src=d; }),
                resizeImage: (f, m) => new Promise((res, rej) => { const r=new FileReader();r.onload=e=>{const i=new Image();i.onload=()=>{const c=document.createElement('canvas');let{width:w,height:h}=i;if(w>h){if(w>m){h*=m/w;w=m;}}else{if(h>m){w*=m/h;h=m;}}c.width=w;c.height=h;c.getContext('2d').drawImage(i,0,0,w,h);res(c.toDataURL('image/jpeg'));};i.onerror=rej;i.src=e.target.result;};r.onerror=rej;r.readAsDataURL(f);}),
                decodeQrFromImage: (f) => new Promise((res, rej) => { const r=new FileReader();r.onload=e=>{const i=new Image();i.onload=()=>{const c=document.createElement('canvas');c.width=i.width;c.height=i.height;const x=c.getContext('2d');x.drawImage(i,0,0);const d=x.getImageData(0,0,c.width,c.height);const code=jsQR(d.data,d.width,d.height);if(code){res(code.data);}else{rej(new Error("کد QR یافت نشد."));}};i.onerror=rej;i.src=e.target.result;};r.onerror=rej;r.readAsDataURL(f);})
            };
            const Crypto = {
                hashMessageForSigning: (m) => Utils.hexToUint8Array(shake256(m, 1536)),
                async verifySignature(sig, data, pk, api) { const h=this.hashMessageForSigning(data); return api.verify(sig, h, pk); }
            };
            const Banknote = {
                getStandardizedDataForSigning: (d) => JSON.stringify({timestamp:d.timestamp,serial:d.serial},['timestamp','serial']),
                getStandardizedDataForMasterSig: (d) => { const t={ephemeralPublicKey:Utils.arrayBufferToBase64(d.ephemeralPublicKey),signatureOne:Utils.arrayBufferToBase64(d.signatureOne)}; return JSON.stringify(t, Object.keys(t).sort()); },
                parsePayload: (b64) => { const c=Utils.base64ToUint8Array(b64); const j=pako.inflate(c,{to:'string'}); const p=JSON.parse(j); return {amount:p.a,serial:p.s,timestamp:p.t,ephemeralPublicKey:Utils.base64ToUint8Array(p.epk),signatureOne:Utils.base64ToUint8Array(p.s1),signatureTwo:Utils.base64ToUint8Array(p.s2)}; },
                getLayout: (w) => { const s=790; const c=w/s; return {qrSize:Math.round(250*c),xSpacing:Math.round(20*c),ySpacing:Math.round(20*c)}; },
                decodeQrGrid: async (imgData, statusEl) => {
                    const l=Banknote.getLayout(imgData.width); const parts={}; let count=0; const c=document.createElement('canvas'); const x=c.getContext('2d'); c.width=imgData.width;c.height=imgData.height;x.putImageData(imgData,0,0);
                    for(let i=0;i<Constants.NUM_QR_CODES;i++){
                        statusEl.innerHTML=`<span class="info">در حال اسکن بخش ${i+1}/${Constants.NUM_QR_CODES}...</span>`; await new Promise(r=>setTimeout(r,5));
                        const row=Math.floor(i/3),col=i%3,rX=col*(l.qrSize+l.xSpacing),rY=row*(l.qrSize+l.ySpacing),d=x.getImageData(rX,rY,l.qrSize,l.qrSize); const code=jsQR(d.data,d.width,d.height);
                        if(code&&code.data.startsWith(Constants.VALIDATION_PREFIX)){const m=code.data.substring(Constants.VALIDATION_PREFIX.length).match(/^(\d+)\/(\d+):(.*)$/s); if(m){const pN=parseInt(m[1],10);if(!parts[pN]){parts[pN]=m[3];count++;}}}
                    }
                    if(count<Constants.NUM_QR_CODES){throw new Error(`اسکن ناموفق بود. ${count}/${Constants.NUM_QR_CODES} بخش پیدا شد.`);}
                    let payload=''; for(let i=1;i<=Constants.NUM_QR_CODES;i++){payload+=parts[i];} return payload;
                }
            };
            return { Constants, Utils, Crypto, Banknote };
        })();
        
        // ===================================================================================
        // NEW MULTI-WALLET APPLICATION LOGIC
        // ===================================================================================
        let walletDatabase = {};
        const state = { falconApi: null, masterPublicKey: null, currentUser: null };

        const DOMElements = {
            views: document.querySelectorAll('.view'),
            // Login View
            loginButton: document.getElementById('login-button'), loginStatus: document.getElementById('login-status'),
            showRegisterLink: document.getElementById('show-register-link'),
            // Register View
            registerButton: document.getElementById('register-button'), registerStatus: document.getElementById('register-status'),
            showLoginLink: document.getElementById('show-login-link'),
            // Wallet View
            welcomeMessage: document.getElementById('welcome-message'),
            balanceDisplay: document.getElementById('balance-display'),
            showChargeViewButton: document.getElementById('show-charge-view-button'), showSendViewButton: document.getElementById('show-send-view-button'), showReceiveViewButton: document.getElementById('show-receive-view-button'),
            logoutButton: document.getElementById('logout-button'),
            // Charge View
            publicKeyInput: document.getElementById('public-key-input'), keyStatus: document.getElementById('key-status'),
            banknoteImageInput: document.getElementById('banknote-image-input'), validationStatus: document.getElementById('validation-status'),
            chargeConfirmation: document.getElementById('charge-confirmation'), validatedAmount: document.getElementById('validated-amount'), confirmChargeButton: document.getElementById('confirm-charge-button'),
            // Send View
            sendAmountInput: document.getElementById('send-amount-input'), recipientQrInput: document.getElementById('recipient-qr-input'),
            recipientInfo: document.getElementById('recipient-info'), sendFundsButton: document.getElementById('send-funds-button'), sendStatus: document.getElementById('send-status'),
            // Receive View
            myQrCodeContainer: document.getElementById('my-qr-code'), downloadQrLink: document.getElementById('download-qr-link'),
            backButtons: document.querySelectorAll('.back-button'),
        };

        // --- Data Persistence ---
        function loadWallets() {
            const data = localStorage.getItem('sadatDigitalWallets');
            walletDatabase = data ? JSON.parse(data) : {};
        }

        function saveWallets() {
            localStorage.setItem('sadatDigitalWallets', JSON.stringify(walletDatabase));
        }

        // --- Core App Functions ---
        async function initializeApp() {
            try {
                state.falconApi = await pqcSignFalcon1024();
                loadWallets();
                console.log("System Initialized.");
                setupEventListeners();
            } catch (e) {
                alert(`خطای حیاتی در راه‌اندازی: ${e.message}`);
            }
        }
        
        function setupEventListeners() {
            // Navigation
            DOMElements.showRegisterLink.addEventListener('click', () => showView('register-view'));
            DOMElements.showLoginLink.addEventListener('click', () => showView('login-view'));
            DOMElements.logoutButton.addEventListener('click', handleLogout);
            DOMElements.backButtons.forEach(b => { b.addEventListener('click', () => { resetSubViews(); showView('wallet-view'); }); });

            // Actions
            DOMElements.loginButton.addEventListener('click', handleLogin);
            DOMElements.registerButton.addEventListener('click', handleRegister);
            DOMElements.showChargeViewButton.addEventListener('click', () => showView('charge-view'));
            DOMElements.showSendViewButton.addEventListener('click', () => showView('send-view'));
            DOMElements.showReceiveViewButton.addEventListener('click', () => { generateReceiveQrCode(); showView('receive-view'); });
            DOMElements.publicKeyInput.addEventListener('change', handlePublicKeyUpload);
            DOMElements.banknoteImageInput.addEventListener('change', handleBanknoteValidation);
            DOMElements.recipientQrInput.addEventListener('change', handleRecipientQrUpload);
            DOMElements.sendFundsButton.addEventListener('click', handleSendFunds);
            DOMElements.confirmChargeButton.addEventListener('click', confirmCharge);
        }
        
        function showView(id) {
            DOMElements.views.forEach(v => v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function updateBalanceDisplay() {
            if (state.currentUser) {
                DOMElements.balanceDisplay.textContent = `$${state.currentUser.balance.toFixed(2)}`;
                DOMElements.welcomeMessage.textContent = `کیف پول: ${state.currentUser.uid}`;
            }
        }
        
        function resetSubViews() {
            DOMElements.keyStatus.innerHTML = ''; DOMElements.validationStatus.innerHTML = '';
            DOMElements.publicKeyInput.value = ''; DOMElements.banknoteImageInput.value = '';
            DOMElements.banknoteImageInput.disabled = true; DOMElements.chargeConfirmation.style.display = 'none';
            state.masterPublicKey = null;
            DOMElements.sendStatus.innerHTML = ''; DOMElements.recipientInfo.innerHTML = '';
            DOMElements.recipientQrInput.value = ''; DOMElements.sendAmountInput.value = '';
        }

        // --- User Management ---
        function handleRegister() {
            const uidInput = document.getElementById('register-uid-input');
            const passwordInput = document.getElementById('register-password-input');
            const uid = uidInput.value.trim();
            const password = passwordInput.value;
            DOMElements.registerStatus.innerHTML = '';

            if (!uid || !password) {
                DOMElements.registerStatus.innerHTML = `<span class="error">نام کاربری و رمز عبور نمی‌توانند خالی باشند.</span>`;
                return;
            }
            if (walletDatabase[uid]) {
                DOMElements.registerStatus.innerHTML = `<span class="error">این نام کاربری قبلاً استفاده شده است.</span>`;
                return;
            }

            walletDatabase[uid] = { password: password, balance: 0 };
            saveWallets();
            DOMElements.registerStatus.innerHTML = `<span class="success">حساب با موفقیت ایجاد شد! اکنون وارد شوید.</span>`;
            uidInput.value = ''; passwordInput.value = '';
            setTimeout(() => showView('login-view'), 1500);
        }

        function handleLogin() {
            const uid = document.getElementById('uid-input').value;
            const password = document.getElementById('password-input').value;
            DOMElements.loginStatus.innerHTML = '';
            
            const user = walletDatabase[uid];
            if (user && user.password === password) {
                state.currentUser = { uid: uid, balance: user.balance };
                updateBalanceDisplay();
                showView('wallet-view');
            } else {
                DOMElements.loginStatus.innerHTML = `<span class="error">نام کاربری یا رمز عبور نامعتبر است.</span>`;
            }
        }

        function handleLogout() {
            state.currentUser = null;
            resetSubViews();
            document.getElementById('uid-input').value = '';
            document.getElementById('password-input').value = '';
            DOMElements.loginStatus.innerHTML = '';
            showView('login-view');
        }

        // --- Wallet Actions (Modified for Persistence) ---
        function confirmCharge() {
            const amount = parseFloat(DOMElements.chargeConfirmation.dataset.amount);
            if (amount > 0 && state.currentUser) {
                state.currentUser.balance += amount;
                walletDatabase[state.currentUser.uid].balance = state.currentUser.balance; // Update database
                saveWallets(); // Persist change
                updateBalanceDisplay();
                alert(`$${amount.toFixed(2)} با موفقیت به موجودی شما اضافه شد.`);
                resetSubViews(); showView('wallet-view');
            }
        }

        function handleSendFunds() {
            const amount = parseFloat(DOMElements.sendAmountInput.value);
            const recipientUID = DOMElements.recipientInfo.dataset.uid;
            
            if (isNaN(amount) || amount <= 0) { DOMElements.sendStatus.innerHTML = '<span class="error">لطفاً یک مبلغ معتبر وارد کنید.</span>'; return; }
            if (!recipientUID) { DOMElements.sendStatus.innerHTML = '<span class="error">لطفاً کد QR گیرنده را بارگذاری کنید.</span>'; return; }
            if (amount > state.currentUser.balance) { DOMElements.sendStatus.innerHTML = '<span class="error">موجودی کافی نیست.</span>'; return; }
            
            // Update sender's balance
            state.currentUser.balance -= amount;
            walletDatabase[state.currentUser.uid].balance = state.currentUser.balance;

            // Update recipient's balance if they exist in our database
            if (walletDatabase[recipientUID]) {
                walletDatabase[recipientUID].balance += amount;
            }
            
            saveWallets(); // Save all changes
            updateBalanceDisplay();
            DOMElements.sendStatus.innerHTML = `<span class="success">مبلغ $${amount.toFixed(2)} به ${recipientUID} ارسال شد.</span>`;
            setTimeout(() => { DOMElements.sendAmountInput.value=''; DOMElements.recipientInfo.innerHTML=''; DOMElements.recipientInfo.dataset.uid=''; DOMElements.recipientQrInput.value=''; DOMElements.sendStatus.innerHTML = '';}, 2500);
        }

        // --- Unchanged Handlers ---
        async function handlePublicKeyUpload(event) {
            const file = event.target.files[0]; if (!file) return;
            DOMElements.keyStatus.textContent = 'در حال پردازش کلید...'; DOMElements.banknoteImageInput.disabled = true; state.masterPublicKey = null;
            try {
                const keyData = JSON.parse(await file.text());
                if (!keyData.masterPublicKey) throw new Error("فایل JSON فاقد 'masterPublicKey' است.");
                state.masterPublicKey = CoreLogic.Utils.base64ToUint8Array(keyData.masterPublicKey);
                DOMElements.keyStatus.innerHTML = '<span class="success">کلید عمومی بارگذاری شد.</span>';
                DOMElements.banknoteImageInput.disabled = false;
            } catch (err) { DOMElements.keyStatus.innerHTML = `<span class="error">خطا: ${err.message}</span>`; }
        }

        async function handleBanknoteValidation(event) {
            const file = event.target.files[0]; if (!file) return;
            if (!state.masterPublicKey) { DOMElements.validationStatus.innerHTML = '<span class="error">لطفاً ابتدا کلید عمومی را بارگذاری کنید.</span>'; return; }
            DOMElements.validationStatus.innerHTML = '<span class="info">در حال آماده‌سازی تصویر...</span>';
            DOMElements.chargeConfirmation.style.display = 'none';
            try {
                const resizedDataUrl = await CoreLogic.Utils.resizeImage(file, CoreLogic.Constants.MAX_IMAGE_DIMENSION);
                const processedDataUrl = await CoreLogic.Utils.preprocessImage(resizedDataUrl);
                const imageData = await new Promise((res, rej) => { const i=new Image(); i.onload=()=>{ const c=document.createElement('canvas');c.width=i.width;c.height=i.height;const x=c.getContext('2d');x.drawImage(i,0,0);res(x.getImageData(0,0,i.width,i.height));}; i.onerror=rej; i.src=processedDataUrl; });
                const payload = await CoreLogic.Banknote.decodeQrGrid(imageData, DOMElements.validationStatus);
                DOMElements.validationStatus.innerHTML = '<span class="success">اسکن کامل شد. در حال تایید امضاها...</span>';
                const banknoteData = CoreLogic.Banknote.parsePayload(payload);
                const isSigOneValid = await CoreLogic.Crypto.verifySignature(banknoteData.signatureOne, CoreLogic.Banknote.getStandardizedDataForSigning(banknoteData), banknoteData.ephemeralPublicKey, state.falconApi);
                if (!isSigOneValid) throw new Error("امضای ۱ نامعتبر است (جعل داخلی).");
                const isSigTwoValid = await CoreLogic.Crypto.verifySignature(banknoteData.signatureTwo, CoreLogic.Banknote.getStandardizedDataForMasterSig(banknoteData), state.masterPublicKey, state.falconApi);
                if (!isSigTwoValid) throw new Error("امضای ۲ نامعتبر است (با کلید عمومی مطابقت ندارد).");
                DOMElements.validationStatus.innerHTML = '<span class="success">اسکناس معتبر است!</span>';
                DOMElements.validatedAmount.textContent = `$${banknoteData.amount.toFixed(2)}`;
                DOMElements.chargeConfirmation.dataset.amount = banknoteData.amount;
                DOMElements.chargeConfirmation.style.display = 'block';
            } catch (err) { DOMElements.validationStatus.innerHTML = `<span class="error">خطا: ${err.message}</span>`; } 
            finally { event.target.value = ''; }
        }
        
        async function handleRecipientQrUpload(event) {
            const file = event.target.files[0]; if (!file) return;
            DOMElements.recipientInfo.innerHTML = '<span class="info">در حال رمزگشایی کد QR...</span>';
            try {
                const decodedText = await CoreLogic.Utils.decodeQrFromImage(file);
                const recipientData = JSON.parse(decodedText);
                if (recipientData.type !== 'SADAT_WALLET_ADDRESS' || !recipientData.uid) { throw new Error("کد QR کیف پول نامعتبر است."); }
                DOMElements.recipientInfo.innerHTML = `<span class="success">گیرنده یافت شد: ${recipientData.uid}</span>`;
                DOMElements.recipientInfo.dataset.uid = recipientData.uid;
            } catch (err) { DOMElements.recipientInfo.innerHTML = `<span class="error">${err.message}</span>`; DOMElements.recipientInfo.dataset.uid = ''; }
        }
        
        function generateReceiveQrCode() {
            DOMElements.myQrCodeContainer.innerHTML = '';
            const payload = JSON.stringify({type:"SADAT_WALLET_ADDRESS", uid:state.currentUser.uid});
            const qr = qrcode(0,'L');
            qr.addData(payload);
            qr.make();
            const qrDataURL = qr.createDataURL(6, 10);
            const img = new Image();
            img.onload = () => {
                const displayImg = DOMElements.myQrCodeContainer.querySelector('img');
                if (displayImg) { displayImg.src = qrDataURL; } 
                else { DOMElements.myQrCodeContainer.innerHTML = `<img src="${qrDataURL}" alt="Wallet QR Code">`; }
                const canvas = document.createElement('canvas'); const scale = 3;
                canvas.width = img.width * scale; canvas.height = img.height * scale;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#FFFFFF'; ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.imageSmoothingEnabled = false; ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                DOMElements.downloadQrLink.href = canvas.toDataURL('image/png');
                DOMElements.downloadQrLink.download = `${state.currentUser.uid}-Wallet-QR.png`;
            };
            img.src = qrDataURL;
        }

        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
