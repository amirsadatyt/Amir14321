<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <title>Sadat Digital Banknote [Fixed]</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-font: 'Poppins', 'Segoe UI', sans-serif; [cite_start]/* [cite: 1] */
            --mono-font: 'Roboto Mono', monospace; [cite_start]/* [cite: 2] */
            --dark-bg: #10101a; [cite_start]/* [cite: 2] */
            --medium-bg: #1a1a2e; [cite_start]/* [cite: 2] */
            --light-bg: #2a2a3e; [cite_start]/* [cite: 2] */
            --accent-color-1: #e040fb; [cite_start]/* [cite: 2] */
            --accent-color-2: #7c4dff; [cite_start]/* [cite: 2] */
            --text-color: #e0e0e0; [cite_start]/* [cite: 2] */
            --text-muted: #a0a0c0; [cite_start]/* [cite: 2] */
            --success-color: #00e676; [cite_start]/* [cite: 2] */
            --error-color: #ff5252; [cite_start]/* [cite: 3] */
            --info-color: #40c4ff; [cite_start]/* [cite: 3] */
            --warning-color: #ffab40; [cite_start]/* [cite: 3] */
            --border-color: rgba(124, 77, 255, 0.2); [cite_start]/* [cite: 3] */
        }
        body { margin: 0; font-family: var(--primary-font); background-color: var(--dark-bg); [cite_start]/* [cite: 4] */
            background-image: radial-gradient(at 0% 0%, hsla(253, 100%, 15%, 0.3) 0px, transparent 50%), radial-gradient(at 100% 100%, hsla(263, 100%, 20%, 0.3) 0px, transparent 50%); [cite_start]/* [cite: 5] */
            color: var(--text-color); text-align: center; padding: 24px; [cite_start]} /* [cite: 6] */
        .container { max-width: 1000px; [cite_start]/* [cite: 6] */
            margin: 0 auto; background: rgba(26, 26, 46, 0.7); backdrop-filter: blur(12px); padding: 24px; border-radius: 24px; border: 1px solid var(--border-color); [cite_start]/* [cite: 7] */
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2); [cite_start]} /* [cite: 8] */
        .header { border-bottom: 1px solid var(--border-color); [cite_start]/* [cite: 8] */
            padding-bottom: 16px; margin-bottom: 24px; [cite_start]} /* [cite: 9] */
        h1 { font-size: 2.5rem; font-weight: 600; color: #fff; [cite_start]/* [cite: 9] */
            margin: 0 0 8px 0; letter-spacing: 1px; background: linear-gradient(90deg, var(--accent-color-1), var(--accent-color-2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; [cite_start]/* [cite: 10] */
        }
        .header p { font-size: 1rem; color: var(--text-muted); margin: 0; [cite_start]/* [cite: 11] */
        }
        canvas#noteCanvas { border-radius: 16px; margin-top: 24px; background: #050508; cursor: default; [cite_start]/* [cite: 12] */
            box-shadow: 0 0 50px rgba(124, 77, 255, 0.15); width: 100%; max-width: 1000px; height: auto; border: 1px solid var(--border-color); [cite_start]/* [cite: 13] */
        }
        input, button, label { padding: 14px 22px; font-size: 16px; font-family: var(--primary-font); [cite_start]/* [cite: 14] */
            border-radius: 12px; margin: 8px 5px; border: 1px solid var(--border-color); background: var(--medium-bg); color: #fff; transition: all 0.3s ease; cursor: pointer; [cite_start]/* [cite: 15] */
            outline: none; display: inline-flex; align-items: center; justify-content: center; gap: 8px; [cite_start]/* [cite: 16] */
        }
        input[type="number"], input[type="password"] { font-family: var(--mono-font); font-weight: 700; text-align: center; width: 150px; [cite_start]/* [cite: 17] */
        }
        input:focus { border-color: var(--accent-color-2); box-shadow: 0 0 15px rgba(124, 77, 255, 0.5); [cite_start]/* [cite: 18] */
        }
        button:not([disabled]), label.button:not([disabled]) { font-weight: 600; background: linear-gradient(90deg, var(--accent-color-1), var(--accent-color-2)); border: none; [cite_start]/* [cite: 19] */
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); [cite_start]} /* [cite: 20] */
        button.sub-button, label.button.sub-button { background: var(--light-bg); [cite_start]/* [cite: 20] */
            border: 1px solid var(--border-color); [cite_start]} /* [cite: 21] */
        button[disabled], label.button[disabled] { cursor: not-allowed; opacity: 0.5; [cite_start]/* [cite: 21] */
            background: var(--light-bg); border: 1px solid var(--border-color); [cite_start]} /* [cite: 22] */
        button:hover:not([disabled]), label.button:hover:not([disabled]) { transform: translateY(-2px); [cite_start]/* [cite: 22] */
            box-shadow: 0 6px 20px rgba(124, 77, 255, 0.4); [cite_start]} /* [cite: 23] */
        .section { background: rgba(16, 16, 26, 0.5); [cite_start]/* [cite: 23] */
            padding: 20px; margin-top: 30px; border-radius: 16px; border: 1px solid var(--border-color); [cite_start]/* [cite: 24] */
        }
        h2 { font-size: 1.5rem; color: var(--text-color); margin-top: 0; margin-bottom: 20px; font-weight: 600; [cite_start]/* [cite: 25] */
            border-bottom: 1px solid var(--border-color); padding-bottom: 10px; [cite_start]} /* [cite: 26] */
        .controls-grid { display: flex; justify-content: center; [cite_start]/* [cite: 26] */
            align-items: center; flex-wrap: wrap; gap: 16px; [cite_start]} /* [cite: 27] */
        .status-box { margin-top: 20px; font-size: 13px; [cite_start]/* [cite: 27] */
            font-weight: normal; min-height: 50px; line-height: 1.6; text-align: left; background: var(--dark-bg); padding: 15px 20px; border-radius: 12px; white-space: pre-wrap; font-family: var(--mono-font); [cite_start]/* [cite: 28] */
            border: 1px solid var(--border-color); transition: all 0.3s ease; [cite_start]} /* [cite: 29] */
        .valid { color: var(--success-color); [cite_start]/* [cite: 29] */
        } .invalid { color: var(--error-color); } .info { color: var(--info-color); } .warning { color: var(--warning-color); [cite_start]/* [cite: 30] */
        }
        code { background: var(--medium-bg); padding: 2px 6px; border-radius: 4px; font-size: 1em; [cite_start]/* [cite: 31] */
        }
        .input-label { font-size: 0.9rem; color: var(--text-muted); margin-right: -10px; [cite_start]/* [cite: 32] */
        }
        .modal { position: fixed; z-index: 100; left: 0; top: 0; width: 100%; [cite_start]/* [cite: 33] */
            height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; [cite_start]/* [cite: 34] */
        }
        .modal-content { background-color: var(--medium-bg); padding: 30px; border: 1px solid var(--border-color); width: 80%; [cite_start]/* [cite: 35] */
            max-width: 500px; border-radius: 16px; text-align: center; [cite_start]} /* [cite: 36] */
        #qr-display { margin: 20px auto; [cite_start]/* [cite: 36] */
            background: white; padding: 15px; border-radius: 8px; width: fit-content; [cite_start]} /* [cite: 37] */
        #qr-display img { max-width: 100%; [cite_start]/* [cite: 37] */
            height: auto; [cite_start]} /* [cite: 38] */
        .pill { background-color: var(--border-color); color: var(--accent-color-1); padding: 5px 15px; [cite_start]/* [cite: 38] */
            border-radius: 20px; font-size: 14px; font-weight: 600; margin: 5px; display: inline-block; [cite_start]/* [cite: 39] */
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>Sadat Digital Banknote</h1>
        <p>A Quantum-Resistant, Offline, Dual-Signature Digital Currency System.</p>
    </div>

    <div class="section">
        <h2><span class="pill">Step 1</span> Guardian Setup: Create Master Keys</h2>
        <div class="controls-grid">
            <button id="generate-keys-button">üîë Generate Master Key Pair</button>
            <label for="import-public-key" class="button sub-button">
 
                [cite_start]<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg> /* [cite: 41] */
                Load Public Key
            </label>
            <input type="file" id="import-public-key" accept=".json" style="display: none;">
     
        [cite_start]</div> /* [cite: 42] */
         <div id="key-gen-status" class="status-box"><span class="info">‚ÑπÔ∏è Welcome, Guardian. [cite_start]/* [cite: 42] */
            Generate a new Master Key Pair to begin your financial ecosystem. [cite_start]/* [cite: 43] */
            [cite_start]This process is fully offline and secure.</span></div> /* [cite: 44] */
    </div>

    <div class="section">
        <h2><span class="pill">Step 2</span> Activate System: Reconstruct Private Key</h2>
        <p style="color: var(--text-muted); font-size: 0.9em; max-width: 700px; margin: -10px auto 20px auto;">To create banknotes, you must prove your identity by solving the "Three-Piece Puzzle".
            [cite_start]This ensures maximum security.</p> /* [cite: 45] */
        <div class="controls-grid">
             <label for="file-key-input" class="button sub-button">1.
                [cite_start]Upload File Key</label> /* [cite: 46] */
             <input type="file" id="file-key-input" accept=".json" style="display:none;" [cite_start]/* [cite: 46] */
             [cite_start]/> /* [cite: 47] */
             <input type="password" id="password-key-input" placeholder="2. Enter Password Key">
             <label for="visual-key-input" class="button sub-button">3.
                [cite_start]Upload Visual Key (JAB)</label> /* [cite: 48] */
             <input type="file" id="visual-key-input" accept="image/png, image/jpeg, image/svg+xml" style="display:none;" [cite_start]/* [cite: 48] */
             [cite_start]/> /* [cite: 49] */
        </div>
        <button id="reconstruct-key-button" disabled style="margin-top: 20px;">üîì Activate Master Private Key</button>
        <div id="key-reconstruction-status" class="status-box"><span class="warning">‚ö†Ô∏è Master Private Key is INACTIVE.
            [cite_start]Solve the puzzle to activate.</span></div> /* [cite: 50] */
    </div>

    <div class="section">
        <h2><span class="pill">Step 3</span> Create Wealth: Generate Banknotes</h2>
        <div class="controls-grid">
            <span class="input-label">Amount:</span>
            <input type="number" id="amount-input" value="50000">
            <span class="input-label">Quantity:</span>
            <input type="number" id="quantity-input" value="1" min="1" max="100">
      
           [cite_start]<button id="create-note-button" disabled>üé® Redesign Banknote</button> /* [cite: 51] */
            <button id="download-batch-button" disabled>üì• Download Batch</button>
        </div>
        <div id="banknote-status" class="status-box">Use the controls above to create and sign new banknotes.</div>
        <canvas id="noteCanvas" width="1350" height="750"></canvas>
    </div>

    <div class="section" id="validator-section">
        <h2><span class="pill">Step 4</span> Verify Authenticity</h2>
        <label for="validator-input" class="button">
    
            [cite_start]<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 15 17 10"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg> /* [cite: 52] */
            Select Banknote Image for Validation
        </label>
        <input type="file" id="validator-input" accept="image/png" style="display: none;">
        <div id="validation-result" class="status-box">Awaiting banknote for validation...</div>
    </div>
</div>

<div id="qr-modal" class="modal">
  <div 
 [cite_start]class="modal-content"> /* [cite: 53] */
    <h2 id="qr-modal-title">Your Visual Key</h2>
    <p>Print this JAB Code or save the image file and store it in a secure physical location.
        [cite_start]It is the third piece of your Master Key puzzle.</p> /* [cite: 54] */
    <div id="qr-display"></div>
    <button id="download-qr-button" style="margin-top: 15px;">üíæ Download JAB Code</button>
    <button onclick="document.getElementById('qr-modal').style.display='none'">Close</button>
  </div>
</div>

<script type="module">
// --- MODIFICATION: Import JAB Code and cryptographic libraries ---
import JabcodeJSInterface from './jabcodeJSLib.min.js';
import pqcSignFalcon1024 from './pqc-sign-falcon-1024.min.js'; [cite_start]/* [cite: 55] */
import { shake256 } from 'https://cdn.skypack.dev/js-sha3';
// --- MODIFICATION: Instantiate JAB Code Interface ---
const jabcode = new JabcodeJSInterface(); [cite_start]/* [cite: 56] */
// --- Global State ---
[cite_start]const state = { /* [cite: 57] */
    falconApi: null,
    masterPublicKey: null,
    masterPrivateKey: null, // This will be held temporarily only during signing
    puzzlePieces: {
        fileKey: null,
        passwordKey: null,
        visualKey: null
    }
};
// --- CONSTANTS ---
[cite_start]const Constants = { /* [cite: 58] */
    FALCON_PUBKEY_SIZE: 1793,
    EPOCH: new Date('2024-01-01T00:00:00Z').getTime()
};
// --- DOM Elements ---
[cite_start]const DOMElements = { /* [cite: 59] */
    generateKeysButton: document.getElementById('generate-keys-button'),
    importPublicKey: document.getElementById('import-public-key'),
    keyGenStatus: document.getElementById('key-gen-status'),
    fileKeyInput: document.getElementById('file-key-input'),
    passwordKeyInput: document.getElementById('password-key-input'),
    visualKeyInput: document.getElementById('visual-key-input'),
    reconstructKeyButton: document.getElementById('reconstruct-key-button'),
    keyReconstructionStatus: document.getElementById('key-reconstruction-status'),
    amountInput: document.getElementById('amount-input'),
    quantityInput: document.getElementById('quantity-input'),
    createNoteButton: document.getElementById('create-note-button'),
    downloadBatchButton: document.getElementById('download-batch-button'),
    noteCanvas: document.getElementById('noteCanvas'),
    banknoteStatus: document.getElementById('banknote-status'),
    validatorInput: document.getElementById('validator-input'),
    validationResult: document.getElementById('validation-result'),
    qrModal: document.getElementById('qr-modal'),
    qrDisplay: document.getElementById('qr-display'),
   
    [cite_start]qrModalTitle: document.getElementById('qr-modal-title'), /* [cite: 60] */
    downloadQrButton: document.getElementById('download-qr-button')
};

// --- Utility Functions ---
const Utils = {
    arrayBufferToBase64: (buffer) => btoa(String.fromCharCode(...new Uint8Array(buffer))),
    base64ToUint8Array: (base64) => {
        const binaryString = atob(base64);
        const len = binaryString.length; [cite_start]/* [cite: 61] */
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) bytes[i] = binaryString.charCodeAt(i);
        return bytes; [cite_start]/* [cite: 62] */
    },
    hexToUint8Array: (hex) => new Uint8Array(hex.match(/.{1,2}/g).map(byte => parseInt(byte, 16))),
    downloadFile: (data, filename, type) => {
        const blob = new Blob([data], { type });
        const url = URL.createObjectURL(blob); [cite_start]/* [cite: 63] */
        const a = document.createElement('a');
        a.href = url; a.download = filename;
        document.body.appendChild(a); a.click();
        document.body.removeChild(a); URL.revokeObjectURL(url);
    [cite_start]}, /* [cite: 64] */
    updateStatus: (element, message, type = 'info') => {
        element.innerHTML = `<span class="${type}">${message}</span>`;
    [cite_start]}, /* [cite: 65] */
    log: (message, type = 'info') => {
        const icon = { info: '‚ÑπÔ∏è', success: '‚úÖ', warning: '‚ö†Ô∏è', error: '‚ùå' }[type];
        console.log(`[Sadat System] ${icon} ${message}`); [cite_start]/* [cite: 66] */
    },
    // --- FIX: Add binary-to-string helpers back for compact payloads ---
    binaryToString: (binaryPayload) => {
        let str = '';
        binaryPayload.forEach(b => { str += String.fromCharCode(b); }); [cite_start]/* [cite: 67] */
        return str;
    },
    stringToBinary: (str) => {
        const binaryPayload = new Uint8Array(str.length);
        [cite_start]for (let i = 0; i < str.length; i++) { /* [cite: 68] */
            binaryPayload[i] = str.charCodeAt(i);
        [cite_start]} /* [cite: 69] */
        return binaryPayload;
    }
    // --- END FIX ---
};
// ===================================================================================
// CORE CRYPTO ENGINE
// ===================================================================================
[cite_start]const BankCrypto = (() => { /* [cite: 70] */
    const AES_ALGO = "AES-GCM";
    const PBKDF2_ITERATIONS = 100000;
    const PBKDF2_KEY_LENGTH = 32;

    async function pbkdf2DeriveKey(password, salt) {
        const passwordBuffer = new TextEncoder().encode(password);
        const importedKey = await crypto.subtle.importKey("raw",passwordBuffer,{ name: "PBKDF2" },false,["deriveKey"]);
        return await crypto.subtle.deriveKey({name: "PBKDF2",salt: salt,iterations: PBKDF2_ITERATIONS,hash: "SHA-256"},importedKey,{ name: AES_ALGO, length: PBKDF2_KEY_LENGTH * 8 },false,["encrypt", "decrypt"]);
    }
    
    
    function hashMessageForSigning(message) { return Utils.hexToUint8Array(shake256(message, 1536)); [cite_start]} /* [cite: 71] */

    return {
        async generateNewKeyPair() {
            if (!state.falconApi) throw new Error("Falcon API not initialized.");
            return state.falconApi.keypair(); [cite_start]/* [cite: 72] */
        },
        async signData(data, privateKey) {
            if (!privateKey || !state.falconApi) throw new Error("Signing prerequisites not met.");
            const dataHash = hashMessageForSigning(data); [cite_start]/* [cite: 73] */
            const { signature } = await state.falconApi.sign(dataHash, privateKey);
            return signature;
        [cite_start]}, /* [cite: 74] */
        async verifySignature(signature, data, publicKey) {
            if (!publicKey || !state.falconApi) throw new Error("Verification prerequisites not met.");
            const dataHash = hashMessageForSigning(data); [cite_start]/* [cite: 75] */
            return state.falconApi.verify(signature, dataHash, publicKey);
        },
        async encryptMasterKey(masterPrivateKeyBytes, passwordKey, visualKeySecret) {
            const visualKeySalt = crypto.getRandomValues(new Uint8Array(16));
            const visualKeyIV = crypto.getRandomValues(new Uint8Array(12)); [cite_start]/* [cite: 76] */
            const cryptoVisualKey = await pbkdf2DeriveKey(visualKeySecret, visualKeySalt);
            const encryptedWithVisual = await crypto.subtle.encrypt({ name: AES_ALGO, iv: visualKeyIV }, cryptoVisualKey, masterPrivateKeyBytes); [cite_start]/* [cite: 77] */
            [cite_start]const intermediatePayload = JSON.stringify({ /* [cite: 78] */
                encryptedKey: Utils.arrayBufferToBase64(encryptedWithVisual),
                salt: Utils.arrayBufferToBase64(visualKeySalt),
                iv: Utils.arrayBufferToBase64(visualKeyIV)
            });
            const passwordSalt = crypto.getRandomValues(new Uint8Array(16)); [cite_start]/* [cite: 79] */
            const passwordIV = crypto.getRandomValues(new Uint8Array(12));
            const cryptoPasswordKey = await pbkdf2DeriveKey(passwordKey, passwordSalt);
            const finalEncryptedKey = await crypto.subtle.encrypt({ name: AES_ALGO, iv: passwordIV }, cryptoPasswordKey, new TextEncoder().encode(intermediatePayload)); [cite_start]/* [cite: 80] */
            [cite_start]return { /* [cite: 81] */
                fileKey: {
                    cipherText: Utils.arrayBufferToBase64(finalEncryptedKey),
                    salt: Utils.arrayBufferToBase64(passwordSalt),
                    iv: Utils.arrayBufferToBase64(passwordIV)
                }
   
             }; [cite_start]/* [cite: 82] */
        [cite_start]}, /* [cite: 83] */
        async reconstructMasterKey(fileKey, passwordKey, visualKeySecret) {
            const passwordSalt = Utils.base64ToUint8Array(fileKey.salt);
            const passwordIV = Utils.base64ToUint8Array(fileKey.iv); [cite_start]/* [cite: 84] */
            const passwordCipherText = Utils.base64ToUint8Array(fileKey.cipherText);
            const cryptoPasswordKey = await pbkdf2DeriveKey(passwordKey, passwordSalt);
            const decryptedIntermediateBuffer = await crypto.subtle.decrypt({ name: AES_ALGO, iv: passwordIV }, cryptoPasswordKey, passwordCipherText); [cite_start]/* [cite: 85] */
            const intermediatePayload = JSON.parse(new TextDecoder().decode(decryptedIntermediateBuffer));
            const visualKeySalt = Utils.base64ToUint8Array(intermediatePayload.salt); [cite_start]/* [cite: 86] */
            const visualKeyIV = Utils.base64ToUint8Array(intermediatePayload.iv);
            const visualCipherText = Utils.base64ToUint8Array(intermediatePayload.encryptedKey);
            const cryptoVisualKey = await pbkdf2DeriveKey(visualKeySecret, visualKeySalt);
            const masterPrivateKeyBytes = await crypto.subtle.decrypt({ name: AES_ALGO, iv: visualKeyIV }, cryptoVisualKey, visualCipherText); [cite_start]/* [cite: 87] */
            return new Uint8Array(masterPrivateKeyBytes);
        }
    };
})(); [cite_start]/* [cite: 88] */

// ===================================================================================
// UI EVENT HANDLERS
// ===================================================================================
const UIHandlers = (() => {
    function updatePuzzleStatus() {
        const { fileKey, passwordKey, visualKey } = state.puzzlePieces;
        let statusHtml = '';
        statusHtml += fileKey ? '<span class="valid">‚úÖ File Key loaded.</span>\n' : '<span class="invalid">‚ùå File Key NOT loaded.</span>\n';
        statusHtml += passwordKey ? '<span class="valid">‚úÖ Password Key entered.</span>\n' : '<span class="invalid">‚ùå Password Key NOT entered.</span>\n';
        statusHtml += visualKey 
            [cite_start]? '<span class="valid">‚úÖ Visual Key scanned.</span>\n' : '<span class="invalid">‚ùå Visual Key NOT scanned.</span>\n'; /* [cite: 89] */
        DOMElements.keyReconstructionStatus.innerHTML = statusHtml;
        const allPiecesProvided = fileKey && passwordKey && visualKey;
        DOMElements.reconstructKeyButton.disabled = !allPiecesProvided;
        [cite_start]if (allPiecesProvided) { /* [cite: 90] */
             Utils.updateStatus(DOMElements.keyReconstructionStatus, "‚ö†Ô∏è All puzzle pieces provided. Click 'Activate' to unlock your private key.", 'warning');
        [cite_start]} /* [cite: 91] */
    }
    
    return {
        async handleGenerateAndExportKeys() {
            const password = prompt("Enter a strong password. This will be your 'Password Key' (Piece 2/3).");
            [cite_start]if (!password) { /* [cite: 92] */
                Utils.updateStatus(DOMElements.keyGenStatus, '‚ùå Key generation cancelled. Password is required.', 'error');
                return; [cite_start]/* [cite: 93] */
            }
            
            Utils.updateStatus(DOMElements.keyGenStatus, '‚è≥ Generating new Falcon-1024 key pair...', 'info'); [cite_start]/* [cite: 94] */
            try {
                const keyPair = await BankCrypto.generateNewKeyPair();
                state.masterPublicKey = keyPair.publicKey; [cite_start]/* [cite: 95] */
                Utils.log("New Master Key Pair generated.", 'success');
                Utils.updateStatus(DOMElements.keyGenStatus, '‚è≥ Creating puzzle pieces and encrypting private key...', 'info');
                const visualKeySecret = crypto.randomUUID(); [cite_start]/* [cite: 96] */
                const { fileKey } = await BankCrypto.encryptMasterKey(keyPair.privateKey, password, visualKeySecret);
                const publicKeyB64 = Utils.arrayBufferToBase64(keyPair.publicKey);
                Utils.downloadFile(JSON.stringify({ masterPublicKey: publicKeyB64 }, null, 2), 'Sadat-MASTER-PUBLIC-KEY.json', 'application/json'); [cite_start]/* [cite: 97] */
                Utils.downloadFile(JSON.stringify(fileKey, null, 2), 'Sadat-FILE-KEY.json', 'application/json');
                
                DOMElements.qrModalTitle.innerText = "Your Visual Key (Piece 3/3)";
                DOMElements.qrDisplay.innerHTML = ''; [cite_start]/* [cite: 98] */
                // --- MODIFICATION: Set lowest error correction for JAB Code ---
                const jabCodeBase64 = jabcode.encode_message(visualKeySecret, { errorCorrectionLevel: 'S' });
                const img = new Image();
                img.src = jabCodeBase64;
                DOMElements.qrDisplay.appendChild(img);
                DOMElements.qrModal.style.display = 'flex';
                Utils.updateStatus(DOMElements.keyGenStatus, `‚úÖ New key pair generated!\n- MASTER-PUBLIC-KEY.json (share this)\n- FILE-KEY.json (keep this on a USB)\n- Password (memorize this)\n- Visual Key JAB Code (print and secure this)\nThe new Public Key is now active for validation.`, 'success'); [cite_start]/* [cite: 99] */
            [cite_start]} catch (e) { /* [cite: 100] */
                Utils.log(`Key generation failed: ${e.message}`, 'error');
                Utils.updateStatus(DOMElements.keyGenStatus, `‚ùå Failed to generate keys: ${e.message}`, 'error'); [cite_start]/* [cite: 101] */
            }
        },
        handleImportPublicKey: async (event) => { const file = event.target.files[0];
            if (!file) return; try { const data = JSON.parse(await file.text()); if (!data.masterPublicKey) throw new Error("Invalid public key file format."); [cite_start]/* [cite: 102] */
            state.masterPublicKey = Utils.base64ToUint8Array(data.masterPublicKey); Utils.updateStatus(DOMElements.keyGenStatus, '‚úÖ Public key imported. Ready to validate banknotes.', 'success'); DOMElements.validatorInput.disabled = false; [cite_start]/* [cite: 103] */
            } catch (error) { Utils.updateStatus(DOMElements.keyGenStatus, `‚ùå Error importing public key: ${error.message}`, 'error'); } event.target.value = ''; [cite_start]/* [cite: 104] */
        },
        handleFileKeyInput: async (event) => { const file = event.target.files[0]; if (!file) return; [cite_start]/* [cite: 105] */
            try { state.puzzlePieces.fileKey = JSON.parse(await file.text()); Utils.log("File Key loaded.", 'success'); } catch(e) { state.puzzlePieces.fileKey = null; [cite_start]/* [cite: 106] */
            Utils.log(`Failed to load File Key: ${e.message}`, 'error'); } updatePuzzleStatus(); event.target.value = ''; [cite_start]/* [cite: 107] */
        },
        handlePasswordKeyInput: (event) => { state.puzzlePieces.passwordKey = event.target.value || null; updatePuzzleStatus(); [cite_start]/* [cite: 108] */
        },
        
        handleVisualKeyInput: (event) => {
            const file = event.target.files[0];
            if (!file) return; [cite_start]/* [cite: 110] */

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const dataUrl = e.target.result;
                    const decodedText = await jabcode.decode_message(dataUrl); [cite_start]/* [cite: 111] */
                    if (decodedText) {
                        state.puzzlePieces.visualKey = decodedText;
                        Utils.log("Visual Key loaded from file.", 'success'); [cite_start]/* [cite: 112] */
                    } else {
                         state.puzzlePieces.visualKey = null;
                         Utils.log("Failed to find a JAB code in the image.", 'error'); [cite_start]/* [cite: 113] */
                    [cite_start]} /* [cite: 114] */
                } catch (error) {
                    state.puzzlePieces.visualKey = null;
                    Utils.log(`Error decoding JAB Code: ${error.message}`, 'error'); [cite_start]/* [cite: 115] */
                    console.error(error);
                } finally {
                    updatePuzzleStatus();
                [cite_start]} /* [cite: 116] */
            };
            [cite_start]reader.onerror = () => { /* [cite: 117] */
                 state.puzzlePieces.visualKey = null;
                 Utils.log("Failed to read the image file.", 'error'); [cite_start]/* [cite: 118] */
                 updatePuzzleStatus();
            };
            reader.readAsDataURL(file);
        [cite_start]}, /* [cite: 119] */

        handleReconstructKey: async () => { 
            const { fileKey, passwordKey, visualKey } = state.puzzlePieces;
            if (!fileKey || !passwordKey || !visualKey) { Utils.updateStatus(DOMElements.keyReconstructionStatus, "‚ùå All three puzzle pieces are required.", 'error'); return; [cite_start]/* [cite: 120] */
            [cite_start]} /* [cite: 121] */
            Utils.updateStatus(DOMElements.keyReconstructionStatus, "‚è≥ Reconstructing Master Private Key...", 'info');
            [cite_start]try { /* [cite: 122] */
                state.masterPrivateKey = await BankCrypto.reconstructMasterKey(fileKey, passwordKey, visualKey);
                Utils.updateStatus(DOMElements.keyReconstructionStatus, "‚úÖ Master Private Key ACTIVE. You can now create banknotes.", 'success'); [cite_start]/* [cite: 123] */
                DOMElements.createNoteButton.disabled = false; DOMElements.downloadBatchButton.disabled = false;
            [cite_start]} catch (error) { /* [cite: 124] */
                console.error(error);
                Utils.updateStatus(DOMElements.keyReconstructionStatus, "‚ùå Failed to reconstruct key. Check puzzle pieces and password.", 'error'); [cite_start]/* [cite: 125] */
                state.masterPrivateKey = null; DOMElements.createNoteButton.disabled = true;
                DOMElements.downloadBatchButton.disabled = true; [cite_start]/* [cite: 126] */
            } 
        },
    };
})();
// ===================================================================================
// BANKNOTE LOGIC 
// ===================================================================================
[cite_start]const BanknoteLogic = (() => { /* [cite: 127] */

    const getStandardizedDataForSigning = (noteData) => JSON.stringify({
        timestamp: noteData.timestamp,
        serial: noteData.serial,
    }, ['timestamp', 'serial']);

    const getStandardizedDataForMasterSig = (noteData) => {
        // Create a temporary object with base64 strings for consistent hashing
        const tempNoteData = {
            ephemeralPublicKey: Utils.arrayBufferToBase64(noteData.ephemeralPublicKey),
      
              [cite_start]signatureOne: Utils.arrayBufferToBase64(noteData.signatureOne) /* [cite: 128] */
        };
        return JSON.stringify(tempNoteData, Object.keys(tempNoteData).sort());
    };
    
    const createNoteData = async (amount) => {
        if (!state.masterPrivateKey) throw new Error("Master Private Key is not active.");
        const ephemeralKeyPair = await BankCrypto.generateNewKeyPair();
        [cite_start]const noteData = { /* [cite: 129] */
            amount: parseInt(amount) ||
            [cite_start]0, /* [cite: 130] */
            serial: Math.random().toString(36).substring(2, 10).toUpperCase(),
            timestamp: Math.floor((Date.now() - Constants.EPOCH) / 1000),
            verificationKey: Math.random().toString(36).substring(2, 10).toUpperCase(),
            ephemeralPublicKey: ephemeralKeyPair.publicKey,
            signatureOne: null,
            signatureTwo: null
        };
        const dataForSigOne = getStandardizedDataForSigning(noteData); [cite_start]/* [cite: 131] */
        noteData.signatureOne = await BankCrypto.signData(dataForSigOne, ephemeralKeyPair.privateKey);
        
        const dataForSigTwo = getStandardizedDataForMasterSig(noteData);
        noteData.signatureTwo = await BankCrypto.signData(dataForSigTwo, state.masterPrivateKey);
        
        return noteData;
    }; [cite_start]/* [cite: 132] */
    
    // --- FIX: Re-implement compact binary payload to prevent data-too-large errors ---
    const createBinaryPayload = (noteData) => {
        const textEncoder = new TextEncoder();
        const serialBytes = textEncoder.encode(noteData.serial); [cite_start]/* [cite: 133] */

        const bufferSize = 4 + 8 + Constants.FALCON_PUBKEY_SIZE + 2 + noteData.signatureOne.length + noteData.signatureTwo.length;
        const buffer = new ArrayBuffer(bufferSize); [cite_start]/* [cite: 134] */
        const view = new DataView(buffer);
        let offset = 0;

        view.setUint32(offset, noteData.timestamp, false); offset += 4;
        new Uint8Array(buffer, offset).set(serialBytes); offset += 8; [cite_start]/* [cite: 135] */
        new Uint8Array(buffer, offset).set(noteData.ephemeralPublicKey); offset += Constants.FALCON_PUBKEY_SIZE;
        view.setUint16(offset, noteData.signatureOne.length, false); offset += 2;
        new Uint8Array(buffer, offset).set(noteData.signatureOne); offset += noteData.signatureOne.length; [cite_start]/* [cite: 136] */
        new Uint8Array(buffer, offset).set(noteData.signatureTwo);

        return Utils.binaryToString(new Uint8Array(buffer));
    }; [cite_start]/* [cite: 137] */
    const parseBinaryPayload = (binaryString) => {
        const buffer = Utils.stringToBinary(binaryString); [cite_start]/* [cite: 138] */
        const view = new DataView(buffer.buffer); [cite_start]/* [cite: 139] */
        const textDecoder = new TextDecoder();
        let offset = 0;

        const timestamp = view.getUint32(offset, false);
        offset += 4; [cite_start]/* [cite: 140] */
        const serial = textDecoder.decode(buffer.subarray(offset, offset + 8)); offset += 8;
        const ephemeralPublicKey = buffer.subarray(offset, offset + Constants.FALCON_PUBKEY_SIZE);
        offset += Constants.FALCON_PUBKEY_SIZE; [cite_start]/* [cite: 141] */
        const sigOneLength = view.getUint16(offset, false); offset += 2;
        const signatureOne = buffer.subarray(offset, offset + sigOneLength);
        offset += sigOneLength; [cite_start]/* [cite: 142] */
        const signatureTwo = buffer.subarray(offset);
        
        return { timestamp, serial, ephemeralPublicKey, signatureOne, signatureTwo };
    };
    [cite_start]// --- END FIX --- /* [cite: 143] */
    
    const handleCreateAndSignNotes = async () => {
        if (!state.masterPrivateKey) { alert("Master Private Key is not active. Please activate it in Step 2.");
            return; [cite_start]} /* [cite: 144] */
        Utils.updateStatus(DOMElements.banknoteStatus, `‚è≥ Creating and redesigning banknote...`, 'info');
        [cite_start]try { /* [cite: 145] */
            const noteData = await createNoteData(DOMElements.amountInput.value);
            const jabPayload = createBinaryPayload(noteData); [cite_start]// Use the compact binary payload /* [cite: 146] */
            await BanknoteDrawer.drawNoteOnCanvas(DOMElements.noteCanvas, noteData, jabPayload, 1350, 750);
            Utils.updateStatus(DOMElements.banknoteStatus, `‚úÖ New banknote designed and ready for download.`, 'success'); [cite_start]/* [cite: 147] */
        [cite_start]} catch (error) { /* [cite: 148] */
            Utils.updateStatus(DOMElements.banknoteStatus, `‚ùå Error: ${error.message}`, 'error');
            console.error(error); [cite_start]/* [cite: 149] */
        }
    };
    
    const handleDownloadBatch = async () => {
        if (!state.masterPrivateKey) { alert("Master Private Key is not active. Please activate it in Step 2.");
            return; [cite_start]} /* [cite: 150] */
        const quantity = parseInt(DOMElements.quantityInput.value) || 1;
        Utils.updateStatus(DOMElements.banknoteStatus, `‚è≥ Creating and downloading ${quantity} banknote(s)...`, 'info'); [cite_start]/* [cite: 151] */
        try {
            const offscreenCanvas = document.createElement('canvas');
            offscreenCanvas.width = 1350; offscreenCanvas.height = 750; [cite_start]/* [cite: 152] */
            const notesToDownload = [];
            [cite_start]for (let i = 0; i < quantity; i++) { /* [cite: 153] */
                const noteData = await createNoteData(DOMElements.amountInput.value);
                const jabPayload = createBinaryPayload(noteData); [cite_start]// Use the compact binary payload /* [cite: 154] */
                await BanknoteDrawer.drawNoteOnCanvas(offscreenCanvas, noteData, jabPayload, 1350, 750);
                const blob = await new Promise(resolve => offscreenCanvas.toBlob(resolve, 'image/png')); [cite_start]/* [cite: 155] */
                notesToDownload.push({ blob, filename: `SADAT-NOTE-${noteData.serial}.png` });
                [cite_start]if (i === quantity - 1) { /* [cite: 156] */
                    await BanknoteDrawer.drawNoteOnCanvas(DOMElements.noteCanvas, noteData, jabPayload, 1350, 750);
                [cite_start]} /* [cite: 157] */
            }
            
            if (quantity >= 1 && window.showDirectoryPicker) {
                 const dirHandle = await window.showDirectoryPicker();
                [cite_start]for (const note of notesToDownload) { /* [cite: 158] */
                    const fileHandle = await dirHandle.getFileHandle(note.filename, { create: true });
                    const writable = await fileHandle.createWritable(); [cite_start]/* [cite: 159] */
                    await writable.write(note.blob); await writable.close();
                 }
                 Utils.updateStatus(DOMElements.banknoteStatus, `‚úÖ Saved ${quantity} notes to your selected folder.`, 'success');
            [cite_start]} else { /* [cite: 160] */
                notesToDownload.forEach(note => Utils.downloadFile(note.blob, note.filename, 'image/png'));
                Utils.updateStatus(DOMElements.banknoteStatus, `‚úÖ Saved ${quantity} note(s). Check your downloads folder. Your browser may not support directory selection.`, 'success'); [cite_start]/* [cite: 161] */
            [cite_start]} /* [cite: 162] */
        } catch (error) {
            Utils.updateStatus(DOMElements.banknoteStatus, `‚ùå Error: ${error.message}`, 'error');
            console.error(error); [cite_start]/* [cite: 163] */
        } finally {
            state.masterPrivateKey = null;
            DOMElements.createNoteButton.disabled = true; [cite_start]/* [cite: 164] */
            DOMElements.downloadBatchButton.disabled = true;
            UIHandlers.handlePasswordKeyInput({target:{value:null}}); // Clear password state
            Utils.updateStatus(DOMElements.keyReconstructionStatus, "‚ö†Ô∏è Master Private Key is INACTIVE. Solve the puzzle to activate.", 'warning');
            Utils.updateStatus(DOMElements.banknoteStatus, `‚úÖ Batch download complete. For security, the Master Key has been cleared from memory. Please reactivate in Step 2 for more actions.`, 'success'); [cite_start]/* [cite: 165] */
            Utils.log("Key cleared for security after batch operation.", 'warning'); [cite_start]/* [cite: 166] */
        }
    };
    [cite_start]return { /* [cite: 167] */
        handleCreateAndSignNotes,
        handleDownloadBatch,
        handleFileSelectForValidation: async (event) => {
            const file = event.target.files[0];
            if (!file || !state.masterPublicKey) return; [cite_start]/* [cite: 168] */
            const resultDiv = DOMElements.validationResult;
            Utils.updateStatus(resultDiv, '‚è≥ Validating banknote... Please wait.', 'info');
            [cite_start]try { /* [cite: 169] */
                const decodedText = await jabcode.decode_message(file);
                [cite_start]if (!decodedText) { /* [cite: 170] */
                    Utils.updateStatus(resultDiv, '‚ùå JAB Code not found or unreadable on the banknote.', 'error');
                    return; [cite_start]/* [cite: 171] */
                }
                
                let resultHTML = '<span class="valid">‚úÖ JAB Code Found.\nVerifying signatures...</span>\n'; [cite_start]/* [cite: 172] */
                resultDiv.innerHTML = resultHTML;

                const parsedData = parseBinaryPayload(decodedText); // Use the binary parser
                
                const dataForSigOne = getStandardizedDataForSigning(parsedData);
                const isSigOneValid = await BankCrypto.verifySignature(parsedData.signatureOne, dataForSigOne, parsedData.ephemeralPublicKey); [cite_start]/* [cite: 173] */
                if (!isSigOneValid) {
                    resultHTML += '<span class="invalid">‚ùå Ephemeral Signature (Sig 1) INVALID.</span>\n<hr><span>‚ùå VERDICT: FORGERY</span>';
                    resultDiv.innerHTML = resultHTML; [cite_start]/* [cite: 174] */
                    return;
                }
                resultHTML += '<span class="valid">‚úÖ Ephemeral Signature (Sig 1) OK.</span>\n';
                const dataForSigTwo = getStandardizedDataForMasterSig(parsedData); [cite_start]/* [cite: 175] */
                const isSigTwoValid = await BankCrypto.verifySignature(parsedData.signatureTwo, dataForSigTwo, state.masterPublicKey);
                [cite_start]if (!isSigTwoValid) { /* [cite: 176] */
                    resultHTML += '<span class="invalid">‚ùå Master Signature (Sig 2) INVALID.</span>\n<hr><span>‚ùå VERDICT: FORGERY</span>';
                    resultDiv.innerHTML = resultHTML; [cite_start]/* [cite: 177] */
                    return;
                }
                resultHTML += '<span class="valid">‚úÖ Master Signature (Sig 2) OK.</span>\n<hr><span style="font-size:14px;font-weight:600;">‚úÖ VERDICT: BANKNOTE IS AUTHENTIC</span>';
                resultDiv.innerHTML = resultHTML; [cite_start]/* [cite: 178] */
            } catch (e) {
                Utils.updateStatus(resultDiv, `‚ùå Validation Error: ${e.message}. The banknote data may be corrupt.`, 'error');
                console.error(e); [cite_start]/* [cite: 179] */
            } finally {
                event.target.value = '';
            [cite_start]} /* [cite: 180] */
        }
    };
})();
// ===================================================================================
// BANKNOTE DRAWER -- PROFESSIONAL APPEARANCE MODULE
// ===================================================================================
[cite_start]const BanknoteDrawer = (() => { /* [cite: 181] */
    const H = (text, index, min, max) => min + (parseInt(text.substring(index, index + 2), 16) % (max - min + 1));
    
    return {
        drawNoteOnCanvas: async (targetCanvas, noteData, jabPayload, width, height) => {
            return new Promise((resolve, reject) => {
                const ctx = targetCanvas.getContext("2d");
  
                              [cite_start]const { amount, serial, verificationKey, signatureTwo } = noteData; /* [cite: 182] */
                const scale = width / 1350;
                const visualHash = shake256(signatureTwo, 256);

                const bgGradient = ctx.createLinearGradient(0, 0, 0, height);
               
                 const baseHue = H(visualHash, 0, 0, 360); [cite_start]/* [cite: 183] */
                bgGradient.addColorStop(0, `hsl(${baseHue}, 50%, 6%)`);
                bgGradient.addColorStop(1, `hsl(${baseHue}, 40%, 4%)`);
                ctx.fillStyle = bgGradient; ctx.fillRect(0, 0, width, height); [cite_start]/* [cite: 184] */
                
                // Drawing logic for Guilloche, Watermark, and Noise has been removed.
                ctx.shadowColor = "rgba(0,0,0,0.7)"; ctx.shadowBlur = 8 * scale; [cite_start]/* [cite: 185] */
                ctx.shadowOffsetX = 2 * scale; ctx.shadowOffsetY = 2 * scale;
                ctx.fillStyle = "#EAEAEA"; ctx.textAlign = 'left'; [cite_start]/* [cite: 186] */
                ctx.font = `bold ${80 * scale}px 'Roboto Mono'`;
                ctx.fillText(serial, 150 * scale, 160 * scale); [cite_start]/* [cite: 187] */
                ctx.fillText(verificationKey, 150 * scale, 280 * scale);
                ctx.font = `bold ${150 * scale}px 'Roboto Mono'`; ctx.textAlign = "right"; [cite_start]/* [cite: 188] */
                ctx.shadowBlur = 12 * scale;
                ctx.shadowOffsetX = 4 * scale; ctx.shadowOffsetY = 4 * scale; [cite_start]/* [cite: 189] */
                ctx.fillText(amount.toString(), width - (120 * scale), 190 * scale);
                ctx.shadowColor = "transparent"; [cite_start]/* [cite: 190] */

                try {
                    // --- MODIFICATION: Set lowest error correction for JAB Code ---
                    const jabCodeBase64 = jabcode.encode_message(jabPayload, { errorCorrectionLevel: 'S' });
                    const img = new Image(); [cite_start]/* [cite: 191] */
                    img.onload = () => {
                        const qrX = width - (150 * scale) - (380 * scale);
                        const qrY = height - (520 * scale); [cite_start]/* [cite: 192] */
                        ctx.fillStyle = 'white';
                        ctx.fillRect(qrX - (20 * scale), qrY - (20 * scale), (380 * scale) + (40 * scale), (380 * scale) + (40 * scale)); [cite_start]/* [cite: 193] */
                        ctx.drawImage(img, qrX, qrY, 380 * scale, 380 * scale); [cite_start]/* [cite: 194] */
                        
                        ctx.font = `${30 * scale}px 'Roboto Mono'`; ctx.fillStyle = "rgba(255,255,255,0.4)";
                        ctx.textAlign = "center"; [cite_start]/* [cite: 195] */
                        ctx.fillText("Dual-Signed by Sadat Guardian Authority (Falcon-1024)", width / 2, height - 60 * scale);
                        resolve();
                    };
                    [cite_start]img.onerror = (err) => { /* [cite: 196] */
                        // Pass the error object to reject
                        reject(new Error("Failed to load generated JAB Code image."));
                    }; [cite_start]/* [cite: 197] */
                    img.src = jabCodeBase64;
                } catch (err) {
                     console.error("JAB Code Generation Error:", err);
                     ctx.fillStyle = 'red'; [cite_start]/* [cite: 198] */
                     ctx.font = `bold ${30 * scale}px 'Roboto Mono'`;
                     ctx.textAlign = 'center';
                     const centerX = width - (150 * scale) - (190 * scale); [cite_start]/* [cite: 199] */
                     const centerY = height - (330 * scale);
                     ctx.fillText("JAB CODE ERROR", centerX, centerY); [cite_start]/* [cite: 200] */
                     reject(err);
                }
            });
        [cite_start]} /* [cite: 201] */
    };
})();

// ===================================================================================
// APPLICATION INITIALIZATION
// ===================================================================================
async function main() {
    Utils.updateStatus(DOMElements.keyGenStatus, '‚è≥ Loading Falcon-1024 Crypto Module...', 'info');
    [cite_start]try { /* [cite: 202] */
        state.falconApi = await pqcSignFalcon1024();
        Utils.updateStatus(DOMElements.keyGenStatus, '‚úÖ Modules loaded. Please generate or import keys to begin.', 'success'); [cite_start]/* [cite: 203] */
        Utils.log("All cryptographic modules initialized successfully.", 'success');
    [cite_start]} catch (e) { /* [cite: 204] */
        Utils.log(`Critical Error: Could not load required modules: ${e.message}`, 'error');
        Utils.updateStatus(DOMElements.keyGenStatus, `‚ùå Critical Error: Could not load modules. See console for details.`, 'error'); [cite_start]/* [cite: 205] */
        alert("Error: Failed to load a required cryptographic module. The application cannot run.");
        return; [cite_start]/* [cite: 207] */
    }
    
    DOMElements.generateKeysButton.addEventListener('click', UIHandlers.handleGenerateAndExportKeys);
    DOMElements.importPublicKey.addEventListener('change', UIHandlers.handleImportPublicKey);
    DOMElements.fileKeyInput.addEventListener('change', UIHandlers.handleFileKeyInput);
    DOMElements.passwordKeyInput.addEventListener('input', UIHandlers.handlePasswordKeyInput);
    DOMElements.visualKeyInput.addEventListener('change', UIHandlers.handleVisualKeyInput);
    DOMElements.reconstructKeyButton.addEventListener('click', UIHandlers.handleReconstructKey);
    DOMElements.createNoteButton.addEventListener('click', BanknoteLogic.handleCreateAndSignNotes); [cite_start]/* [cite: 208] */
    DOMElements.downloadBatchButton.addEventListener('click', BanknoteLogic.handleDownloadBatch);
    DOMElements.validatorInput.addEventListener('change', BanknoteLogic.handleFileSelectForValidation);
    
    DOMElements.downloadQrButton.addEventListener('click', () => {
        const img = DOMElements.qrDisplay.querySelector('img');
        if (img && img.src) {
            const a = document.createElement('a');
            a.href = img.src; a.download = 'Sadat-VISUAL-KEY.png';
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }
    });
[cite_start]} /* [cite: 209] */

main();
</script>
</body>
</html>
