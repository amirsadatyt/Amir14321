<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Aura Wallet (Pinata Ledger)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap');
        :root { --primary-color: #4b6cb7; --secondary-color: #182848; --danger-color: #d9534f; --light-gray: #f0f2f5; --dark-gray: #6c757d; }
        body { font-family: 'Vazirmatn', sans-serif; background-color: var(--light-gray); display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .view { display: none; }
        .view.active { display: block; }
        .card { background-color: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 380px; text-align: center; border-top: 5px solid var(--primary-color); }
        input, textarea { width: calc(100% - 22px); padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; text-align: center; font-family: 'Vazirmatn', sans-serif; }
        textarea { resize: vertical; height: 80px; }
        button { width: 100%; padding: 12px; background: linear-gradient(90deg, var(--primary-color), var(--secondary-color)); color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; transition: all 0.2s; margin-top: 10px;}
        button:hover { opacity: 0.9; transform: translateY(-2px); }
        button:disabled { background: #999; cursor: not-allowed; transform: translateY(0); }
        .back-button { background: var(--dark-gray); }
        .logout-button { background: var(--danger-color); }
        .link-button { background: none; border: none; color: var(--primary-color); text-decoration: underline; cursor: pointer; padding: 5px; width: auto; }
        .status-box { font-weight: bold; min-height: 20px; margin-top: 10px; word-wrap: break-word; }
        .error { color: #d93025; } .success { color: #1e8e3e; } .info { color: #007bff; }
        .seed-phrase-box { padding: 15px; border: 1px dashed var(--danger-color); border-radius: 8px; margin: 20px 0; background-color: #fff8f8; color: #333; font-size: 18px; letter-spacing: 1px; text-align: left; direction: ltr; }
        #qr-display-box img { margin: 15px auto; display: block; border: 5px solid #eee; border-radius: 5px; }
        label.qr-upload-label { cursor: pointer; display: block; margin: 15px; padding: 10px; border: 2px dashed #ccc; border-radius: 8px; }
        label.qr-upload-label:hover { background-color: #f9f9f9; }
        input[type="file"] { display: none; }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid var(--primary-color); width: 20px; height: 20px; animation: spin 1s linear infinite; margin: 10px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="onboarding-view" class="view active"><div class="card"><h1>کیف پول Aura</h1><p>نسل جدید امنیت و کنترل دارایی</p><button id="go-to-create-wallet">ساخت کیف پول جدید</button><button id="go-to-restore-wallet" class="back-button">بازیابی کیف پول</button></div></div>
    <div id="create-wallet-view" class="view"><div class="card"><h2>انتخاب رمز عبور</h2><p>یک رمز عبور قوی برای رمزنگاری کیف پول خود انتخاب کنید. این رمز قابل بازیابی نیست.</p><input type="password" id="create-password-input" placeholder="رمز عبور"><input type="password" id="confirm-password-input" placeholder="تکرار رمز عبور"><div class="loader" id="create-loader"></div><button id="create-wallet-button">ساخت کیف پول</button><div id="create-status" class="status-box"></div><button class="back-button" id="back-from-create">بازگشت</button></div></div>
    <div id="seed-phrase-view" class="view"><div class="card"><h2>عبارت بازیابی شما</h2><p class="error">این ۱۲ کلمه را در یک جای امن و آفلاین یادداشت کنید. این تنها راه بازیابی کیف پول شماست.</p><div id="seed-phrase-display" class="seed-phrase-box"></div><button id="seed-phrase-confirm-button">متوجه شدم، مرا به کیف پولم ببر</button></div></div>
    <div id="restore-wallet-view" class="view"><div class="card"><h2>بازیابی کیف پول</h2><p>عبارت بازیابی ۱۲ کلمه‌ای خود را وارد کنید.</p><textarea id="restore-seed-input" placeholder="کلمات را با فاصله وارد کنید..."></textarea><p>یک رمز عبور جدید برای این دستگاه انتخاب کنید.</p><input type="password" id="restore-password-input" placeholder="رمز عبور جدید"><div class="loader" id="restore-loader"></div><button id="restore-wallet-button">بازیابی</button><div id="restore-status" class="status-box"></div><button class="back-button" id="back-from-restore">بازگشت</button></div></div>
    <div id="login-view" class="view"><div class="card"><h1>باز کردن کیف پول</h1><p>برای رمزگشایی کیف پول، رمز عبور خود را وارد کنید.</p><input type="password" id="login-password-input" placeholder="رمز عبور"><div class="loader" id="login-loader"></div><button id="login-button">ورود</button><div id="login-status" class="status-box"></div><p style="margin-top:20px;">می‌خواهید از کیف پول دیگری استفاده کنید؟ <button class="link-button" id="reset-app-button">پاک کردن همه چیز و شروع مجدد</button></p></div></div>

    <div id="wallet-view" class="view"><div class="card"><h2>کیف پول شما</h2><p>موجودی:</p><h1 id="balance-display">$0.00</h1><p id="network-status" style="font-size: 12px; color: #1e8e3e;">لجر: Pinata IPFS</p><button id="show-charge-view-button">شارژ با اسکناس</button><button id="show-send-view-button">ارسال وجه</button><button id="show-receive-view-button">دریافت وجه</button><button id="logout-button" class="logout-button">خروج (قفل کردن کیف پول)</button></div></div>

    <div id="charge-view" class="view"><div class="card"><h2>شارژ کیف پول</h2><div><h3>مرحله ۱: بارگذاری کلید عمومی بانک</h3><label for="public-key-input" class="qr-upload-label">آپلود فایل کلید عمومی (.json)</label><input type="file" id="public-key-input" accept=".json"><div id="key-status" class="status-box"></div></div><div><h3>مرحله ۲: اسکن اسکناس دیجیتال</h3><label for="banknote-image-input" class="qr-upload-label" id="banknote-upload-label">آپلود تصویر اسکناس</label><input type="file" id="banknote-image-input" accept="image/*" disabled><div id="validation-status" class="status-box"></div></div><div id="charge-confirmation" style="display:none; margin-top: 20px;"><p>اعتبارسنجی موفق! مبلغ: <b id="validated-amount"></b></p><button id="confirm-charge-button">افزودن به موجودی</button></div><button class="back-button" id="back-from-charge">بازگشت</button></div></div>

    <div id="send-scan-view" class="view"><div class="card"><h2>ارسال وجه</h2><label class="qr-upload-label" for="scan-request-input">برای پرداخت، کد QR درخواست وجه را آپلود کنید</label><input type="file" id="scan-request-input" accept="image/*"><div id="scan-request-status" class="status-box"></div><button class="back-button" onclick="showView('wallet-view')">بازگشت</button></div></div>
    <div id="send-confirmation-view" class="view"><div class="card"><h2>تایید پرداخت</h2><p>شما در حال ارسال مبلغ زیر هستید:</p><h1 id="confirm-payment-amount" style="color: var(--primary-color);"></h1><p>به آدرس:</p><p id="confirm-payment-address" style="word-wrap: break-word; font-size: 14px;"></p><button id="confirm-payment-btn">تایید و ایجاد کد متقابل</button><button class="back-button" id="cancel-payment-btn">انصراف</button></div></div>
    
    <div id="receive-options-view" class="view"><div class="card"><h2>دریافت وجه</h2><p>یک گزینه را انتخاب کنید:</p><button id="request-payment-btn">درخواست مبلغ مشخص (ایجاد QR)</button><button id="claim-payment-btn" class="back-button">اسکن کد فرستنده برای دریافت وجه</button><button class="back-button" onclick="showView('wallet-view')">بازگشت</button></div></div>
    <div id="request-amount-view" class="view"><div class="card"><h2>مبلغ درخواستی</h2><p>مبلغی که می‌خواهید از پرداخت‌کننده دریافت کنید را وارد نمایید.</p><input type="number" id="request-amount-input" placeholder="مبلغ"><button id="generate-request-qr-btn">ساخت کد QR درخواست</button><div id="request-status" class="status-box"></div><button class="back-button" onclick="showView('receive-options-view')">بازگشت</button></div></div>
    <div id="claim-payment-view" class="view"><div class="card"><h2>دریافت وجه (نهایی‌سازی)</h2><label class="qr-upload-label" for="scan-proposal-input">کد QR که فرستنده به شما نشان می‌دهد را اسکن کنید</label><input type="file" id="scan-proposal-input" accept="image/*"><div id="proposal-status" class="status-box"></div><button class="back-button" onclick="showView('receive-options-view')">بازگشت</button></div></div>

    <div id="qr-display-view" class="view"><div class="card"><h2 id="qr-display-title"></h2><p id="qr-display-instruction"></p><div id="qr-display-box"></div><label id="scan-receipt-label" class="qr-upload-label" for="scan-receipt-input" style="display: none;">برای نهایی کردن، کد QR رسید را اسکن کنید</label><input type="file" id="scan-receipt-input" accept="image/*"><div id="qr-status" class="status-box"></div><button class="back-button" id="back-from-qr-display">بازگشت به کیف پول</button></div></div>

    <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    
    <script type="module">
        import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@6.13.1/dist/ethers.min.js";
        import pqcSignFalcon1024 from './pqc-sign-falcon-1024.min.js';
        import { shake256 } from 'https://cdn.skypack.dev/js-sha3';

        // CORE & LEDGER LOGIC (Unchanged)
        const CoreLogic = (() => { const Constants={VALIDATION_PREFIX:"SADAT_V2_PART",MAX_IMAGE_DIMENSION:2e3,NUM_QR_CODES:9},Utils={arrayBufferToBase64:b=>btoa(String.fromCharCode(...new Uint8Array(b))),base64ToUint8Array:s=>{const t=atob(s),e=new Uint8Array(t.length);for(let r=0;r<t.length;r++)e[r]=t.charCodeAt(r);return e},hexToUint8Array:h=>new Uint8Array(h.match(/.{1,2}/g).map(b=>parseInt(b,16))),preprocessImage:d=>new Promise((r,e)=>{const t=new Image;t.onload=()=>{const e=document.createElement("canvas");e.width=t.width,e.height=t.height;e.getContext("2d",{alpha:!1}).filter="grayscale(1) contrast(2.5) brightness(1.1)",e.getContext("2d").drawImage(t,0,0),r(e.toDataURL("image/jpeg"))},t.onerror=e,t.src=d}),resizeImage:(f,m)=>new Promise((r,e)=>{const t=new FileReader;t.onload=t=>{const e=new Image;e.onload=()=>{const t=document.createElement("canvas");let{width:o,height:a}=e;o>a?o>m&&(a*=m/o,o=m):a>m&&(o*=m/a,a=m),t.width=o,t.height=a,t.getContext("2d").drawImage(e,0,0,o,a),r(t.toDataURL("image/jpeg"))},e.onerror=e,e.src=t.target.result},t.onerror=e,t.readAsDataURL(f)})},Crypto={hashMessageForSigning:m=>Utils.hexToUint8Array(shake256(m,1536)),verifySignature:async(s,d,p,a)=>{const h=Crypto.hashMessageForSigning(d);return a.verify(s,h,p)}},Banknote={getStandardizedDataForSigning:d=>JSON.stringify({timestamp:d.timestamp,serial:d.serial},["timestamp","serial"]),getStandardizedDataForMasterSig:d=>{const t={ephemeralPublicKey:Utils.arrayBufferToBase64(d.ephemeralPublicKey),signatureOne:Utils.arrayBufferToBase64(d.signatureOne)};return JSON.stringify(t,Object.keys(t).sort())},parsePayload:b64=>{const c=Utils.base64ToUint8Array(b64),j=pako.inflate(c,{to:"string"}),p=JSON.parse(j);return{amount:p.a,serial:p.s,timestamp:p.t,ephemeralPublicKey:Utils.base64ToUint8Array(p.epk),signatureOne:Utils.base64ToUint8Array(p.s1),signatureTwo:Utils.base64ToUint8Array(p.s2)}},getLayout:w=>{const s=790,c=w/s;return{qrSize:Math.round(250*c),xSpacing:Math.round(20*c),ySpacing:Math.round(20*c)}},decodeQrGrid:async(imgData,statusEl)=>{const l=Banknote.getLayout(imgData.width),parts={},c=document.createElement("canvas"),x=c.getContext("2d");let count=0;c.width=imgData.width,c.height=imgData.height,x.putImageData(imgData,0,0);for(let i=0;i<Constants.NUM_QR_CODES;i++){statusEl.innerHTML=`<span class="info">در حال اسکن بخش ${i+1}/${Constants.NUM_QR_CODES}...</span>`,await new Promise(r=>setTimeout(r,5));const row=Math.floor(i/3),col=i%3,rX=col*(l.qrSize+l.xSpacing),rY=row*(l.qrSize+l.ySpacing),d=x.getImageData(rX,rY,l.qrSize,l.qrSize),code=jsQR(d.data,d.width,d.height);if(code&&code.data.startsWith(Constants.VALIDATION_PREFIX)){const m=code.data.substring(Constants.VALIDATION_PREFIX.length).match(/^(\d+)\/(\d+):(.*)$/s);if(m){const pN=parseInt(m[1],10);parts[pN]||(parts[pN]=m[3],count++)}}}if(count<Constants.NUM_QR_CODES)throw new Error(`اسکن ناموفق بود. ${count}/${Constants.NUM_QR_CODES} بخش پیدا شد.`);let payload="";for(let i=1;i<=Constants.NUM_QR_CODES;i++)payload+=parts[i];return payload}};return{Constants,Utils,Crypto,Banknote}})();
        const PinataLedger = (() => { const SUPABASE_FUNCTION_URL = 'https://hoppdalxbmktxexylbkl.supabase.co/functions/v1/quick-responder'; const handleApiError = async (response) => { const rawText = await response.text(); console.error("SERVER ERROR:", { status: response.status, statusText: response.statusText, body: rawText }); try { return (JSON.parse(rawText)).error || rawText; } catch { return rawText; } }; return { recordSpentIdentifier: async (identifier, type) => { try { const response = await fetch(SUPABASE_FUNCTION_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ identifier, type }) }); if (!response.ok) throw new Error(await handleApiError(response)); console.log('Identifier recorded. IPFS Hash:', (await response.json()).ipfsHash); return true; } catch (error) { alert(`خطای بحرانی: امکان ثبت در لجر عمومی وجود ندارد. دلیل: ${error.message}`); return false; } }, hasBeenSpent: async (identifier) => { try { const url = new URL(SUPABASE_FUNCTION_URL); url.searchParams.append('identifier', identifier); const response = await fetch(url.toString(), { method: 'GET' }); if (!response.ok) throw new Error(await handleApiError(response)); return (await response.json()).spent; } catch (error) { alert(`خطای بحرانی: امکان خواندن از لجر عمومی وجود ندارد. دلیل: ${error.message}`); return true; } } }; })();

        // WALLET LOGIC (Unchanged)
        const AppConstants = { MAX_LOGIN_ATTEMPTS: 5, LOGIN_LOCKOUT_PERIOD: 30000 };
        let state = { wallet: null, masterPublicKey: null, userStore: null, falconApi: null, failedLoginAttempts: 0, isLockedOut: false };
        const WalletLogic = { createWallet: (password) => { const wallet = ethers.Wallet.createRandom(); const mnemonic = wallet.mnemonic.phrase; const encryptedJson = wallet.encryptSync(password); const userStore = { publicKey: wallet.publicKey, address: wallet.address, encryptedJson: encryptedJson, chain: [{ hash: ethers.id("GENESIS_BLOCK"), type: 'creation', timestamp: Date.now() }] }; localStorage.setItem('aura_user_store', JSON.stringify(userStore)); state.userStore = userStore; state.wallet = wallet; return { mnemonic }; }, restoreWallet: async (mnemonic, password) => { try { const wallet = ethers.Wallet.fromPhrase(mnemonic); const encryptedJson = wallet.encryptSync(password); const userStore = { publicKey: wallet.publicKey, address: wallet.address, encryptedJson: encryptedJson, chain: [{ hash: ethers.id("GENESIS_BLOCK"), type: 'creation', timestamp: Date.now() }] }; localStorage.setItem('aura_user_store', JSON.stringify(userStore)); state.userStore = userStore; state.wallet = wallet; return true; } catch (e) { console.error("Restore failed:", e); return false; } }, login: async (password) => { const userStoreJson = localStorage.getItem('aura_user_store'); if (!userStoreJson) return null; try { const reloadedUserStore = JSON.parse(userStoreJson); const wallet = await ethers.Wallet.fromEncryptedJson(reloadedUserStore.encryptedJson, password); state.userStore = reloadedUserStore; state.wallet = wallet; state.failedLoginAttempts = 0; return true; } catch (e) { console.error("Login failed:", e); state.failedLoginAttempts++; return false; } }, logout: () => { state.wallet = null; state.userStore = null; }, getLastTransaction: () => state.userStore.chain[state.userStore.chain.length - 1], addToChain: (txData) => { const prevTx = WalletLogic.getLastTransaction(); const newTx = { ...txData, prevHash: prevTx.hash, timestamp: Date.now() }; newTx.hash = ethers.solidityPackedKeccak256(['string', 'uint256', 'string', 'string', 'string'], [newTx.type, newTx.amount || 0, newTx.from || '', newTx.to || '', newTx.prevHash]); state.userStore.chain.push(newTx); localStorage.setItem('aura_user_store', JSON.stringify(state.userStore)); return newTx; }, calculateBalance: () => { if (!state.userStore) return 0.0; return state.userStore.chain.reduce((balance, tx) => { if (tx.status !== 'completed') return balance; if (tx.type === 'charge' || tx.type === 'receive') return balance + (tx.amount || 0); if (tx.type === 'send') return balance - (tx.amount || 0); return balance; }, 0); }, createProposal: async (amount, toAddress) => { const proposalTx = WalletLogic.addToChain({ type: 'send', amount: amount, from: state.wallet.address, to: toAddress, status: 'pending' }); const proposal = { type: 'AURA_PROPOSAL', senderAddress: state.wallet.address, senderPublicKey: state.wallet.publicKey, txHash: proposalTx.hash, amount: amount }; proposal.signature = await state.wallet.signMessage(JSON.stringify(proposal)); return proposal; }, createReceipt: async (proposal) => { const receiptTx = WalletLogic.addToChain({ type: 'receive', amount: proposal.amount, from: proposal.senderAddress, to: state.wallet.address, status: 'completed', linkedTxHash: proposal.txHash }); const receipt = { type: 'AURA_RECEIPT', receiverAddress: state.wallet.address, txHash: receiptTx.hash, linkedTxHash: proposal.txHash }; receipt.signature = await state.wallet.signMessage(JSON.stringify(receipt)); return receipt; }, verifyAndFinalize: async (receipt) => { const senderTxIndex = state.userStore.chain.findIndex(tx => tx.hash === receipt.linkedTxHash); if (senderTxIndex === -1 || state.userStore.chain[senderTxIndex].status === 'completed') throw new Error("تراکنش ارسال مرتبط یافت نشد یا قبلا تکمیل شده است."); const signerAddress = ethers.verifyMessage(JSON.stringify(receipt), receipt.signature); const success = await PinataLedger.recordSpentIdentifier(receipt.linkedTxHash, 'transaction'); if (!success) throw new Error("امکان نهایی کردن تراکنش در لجر عمومی وجود ندارد."); state.userStore.chain[senderTxIndex].status = 'completed'; localStorage.setItem('aura_user_store', JSON.stringify(state.userStore)); return true; } };

        // UI & EVENT HANDLING
        function resetViewInputs(viewId) { const view = document.getElementById(viewId); if (!view) return; view.querySelectorAll('input, textarea').forEach(input => { if (input.type !== 'file') input.value = ''; }); const statusBox = view.querySelector('.status-box'); if (statusBox) statusBox.innerHTML = ''; }
        function resetChargeView() { resetViewInputs('charge-view'); document.getElementById('banknote-image-input').disabled = true; document.getElementById('public-key-input').value = ''; document.getElementById('charge-confirmation').style.display = 'none'; const confirmBtn = document.getElementById('confirm-charge-button'); confirmBtn.disabled = false; confirmBtn.removeAttribute('data-amount'); confirmBtn.removeAttribute('data-serial'); }
        function showView(id) { document.querySelectorAll('.view').forEach(v => v.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        function updateBalanceDisplay() { const balance = WalletLogic.calculateBalance(); document.getElementById('balance-display').textContent = `$${balance.toFixed(2)}`; }
        function generateQrCode(data, containerId) { const container = document.getElementById(containerId); container.innerHTML = ''; const qr = qrcode(0, 'L'); qr.addData(JSON.stringify(data)); qr.make(); container.innerHTML = qr.createImgTag(6, 10); }
        async function decodeQrFromFile(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = e => { const image = new Image(); image.onload = () => { const canvas = document.createElement('canvas'); canvas.width = image.width; canvas.height = image.height; const ctx = canvas.getContext('2d'); ctx.drawImage(image, 0, 0); const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height); const code = jsQR(imageData.data, imageData.width, imageData.height); if (code) { try { resolve(JSON.parse(code.data)); } catch { reject(new Error("کد QR حاوی اطلاعات نامعتبر است.")); } } else { reject(new Error("کد QR یافت نشد یا نامعتبر است.")); } }; image.src = e.target.result; }; reader.readAsDataURL(file); }); }
        
        async function initializeApp() { try { state.falconApi = await pqcSignFalcon1024(); } catch (e) { alert(`خطای بحرانی در راه‌اندازی ماژول رمزنگاری: ${e.message}`); return; } if (localStorage.getItem('aura_user_store')) { showView('login-view'); } else { showView('onboarding-view'); } setupEventListeners(); }

        function setupEventListeners() {
            // --- Navigation ---
            document.getElementById('go-to-create-wallet').addEventListener('click', () => showView('create-wallet-view'));
            document.getElementById('go-to-restore-wallet').addEventListener('click', () => showView('restore-wallet-view'));
            document.getElementById('back-from-create').addEventListener('click', () => { resetViewInputs('create-wallet-view'); showView('onboarding-view'); });
            document.getElementById('back-from-restore').addEventListener('click', () => { resetViewInputs('restore-wallet-view'); showView('onboarding-view'); });
            document.getElementById('back-from-charge').addEventListener('click', () => showView('wallet-view'));
            document.getElementById('back-from-qr-display').addEventListener('click', () => showView('wallet-view'));
            document.getElementById('cancel-payment-btn').addEventListener('click', () => showView('send-scan-view'));

            // --- Wallet Creation & Login ---
            document.getElementById('create-wallet-button').addEventListener('click', () => { const pass = document.getElementById('create-password-input').value, confirmPass = document.getElementById('confirm-password-input').value, statusEl = document.getElementById('create-status'); statusEl.textContent = ''; if (pass.length < 8) { statusEl.innerHTML = '<span class="error">رمز عبور باید حداقل ۸ کاراکتر باشد.</span>'; return; } if (pass !== confirmPass) { statusEl.innerHTML = '<span class="error">رمزهای عبور مطابقت ندارند.</span>'; return; } setTimeout(() => { const { mnemonic } = WalletLogic.createWallet(pass); document.getElementById('seed-phrase-display').textContent = mnemonic; showView('seed-phrase-view'); }, 50); });
            document.getElementById('seed-phrase-confirm-button').addEventListener('click', () => { updateBalanceDisplay(); showView('wallet-view'); document.getElementById('seed-phrase-display').textContent = ''; resetViewInputs('create-wallet-view'); });
            document.getElementById('restore-wallet-button').addEventListener('click', async () => { const mnemonic = document.getElementById('restore-seed-input').value.trim(), pass = document.getElementById('restore-password-input').value.trim(), statusEl = document.getElementById('restore-status'); statusEl.textContent = ''; if (mnemonic.split(' ').length !== 12) { statusEl.innerHTML = '<span class="error">عبارت بازیابی باید ۱۲ کلمه باشد.</span>'; return; } if (pass.length < 8) { statusEl.innerHTML = '<span class="error">رمز عبور باید حداقل ۸ کاراکتر باشد.</span>'; return; } const success = await WalletLogic.restoreWallet(mnemonic, pass); if (success) { updateBalanceDisplay(); showView('wallet-view'); } else { statusEl.innerHTML = '<span class="error">بازیابی ناموفق. عبارت نامعتبر است.</span>'; } resetViewInputs('restore-wallet-view'); });
            document.getElementById('login-button').addEventListener('click', async () => { if(state.isLockedOut) return; const pass=document.getElementById('login-password-input').value, statusEl=document.getElementById('login-status'), button=document.getElementById('login-button'); button.disabled=true; const success=await WalletLogic.login(pass); if(success){updateBalanceDisplay();showView('wallet-view');resetViewInputs('login-view');}else{if(state.failedLoginAttempts>=AppConstants.MAX_LOGIN_ATTEMPTS){state.isLockedOut=true;statusEl.innerHTML=`<span class="error">تلاش‌های ناموفق بیش از حد. لطفا ۳۰ ثانیه صبر کنید.</span>`;setTimeout(()=>{state.isLockedOut=false;state.failedLoginAttempts=0;statusEl.textContent='';button.disabled=false;},AppConstants.LOGIN_LOCKOUT_PERIOD);}else{statusEl.innerHTML=`<span class="error">رمز عبور نامعتبر. (${AppConstants.MAX_LOGIN_ATTEMPTS - state.failedLoginAttempts} تلاش باقی مانده)</span>`;}} if(!state.isLockedOut) button.disabled=false;});
            document.getElementById('logout-button').addEventListener('click', () => { WalletLogic.logout(); showView('login-view'); });
            document.getElementById('reset-app-button').addEventListener('click', () => { if (confirm('آیا مطمئنید؟ تمام اطلاعات کیف پول از این مرورگر پاک خواهد شد.')) { localStorage.removeItem('aura_user_store'); location.reload(); } });

            // --- Wallet Actions ---
            document.getElementById('show-charge-view-button').addEventListener('click', () => { resetChargeView(); showView('charge-view'); });
            document.getElementById('show-send-view-button').addEventListener('click', () => { resetViewInputs('send-scan-view'); showView('send-scan-view'); });
            document.getElementById('show-receive-view-button').addEventListener('click', () => showView('receive-options-view'));

            // --- Receive Flow Event Listeners ---
            document.getElementById('request-payment-btn').addEventListener('click', () => { resetViewInputs('request-amount-view'); showView('request-amount-view'); });
            document.getElementById('claim-payment-btn').addEventListener('click', () => { resetViewInputs('claim-payment-view'); showView('claim-payment-view'); });
            document.getElementById('generate-request-qr-btn').addEventListener('click', () => {
                const amount = parseFloat(document.getElementById('request-amount-input').value);
                const statusEl = document.getElementById('request-status');
                if (isNaN(amount) || amount <= 0) {
                    statusEl.innerHTML = '<span class="error">لطفاً یک مبلغ معتبر وارد کنید.</span>';
                    return;
                }
                const requestPayload = {
                    type: 'AURA_PAYMENT_REQUEST',
                    receiverAddress: state.wallet.address,
                    amount: amount
                };
                generateQrCode(requestPayload, 'qr-display-box');
                document.getElementById('qr-display-title').textContent = 'کد QR درخواست پرداخت';
                document.getElementById('qr-display-instruction').textContent = 'این کد را به پرداخت‌کننده نشان دهید تا اسکن کند.';
                document.getElementById('scan-receipt-label').style.display = 'none';
                document.getElementById('qr-status').innerHTML = '';
                showView('qr-display-view');
            });
            
            // --- Send Flow Event Listeners ---
            document.getElementById('scan-request-input').addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const statusEl = document.getElementById('scan-request-status');
                try {
                    statusEl.innerHTML = '<span class="info">در حال پردازش کد QR...</span>';
                    const data = await decodeQrFromFile(file);
                    if (data.type !== 'AURA_PAYMENT_REQUEST' || !data.amount || !data.receiverAddress) {
                        throw new Error('این یک کد QR درخواست پرداخت معتبر نیست.');
                    }
                    document.getElementById('confirm-payment-amount').textContent = `$${data.amount.toFixed(2)}`;
                    document.getElementById('confirm-payment-address').textContent = data.receiverAddress;
                    const confirmBtn = document.getElementById('confirm-payment-btn');
                    confirmBtn.dataset.amount = data.amount;
                    confirmBtn.dataset.address = data.receiverAddress;
                    showView('send-confirmation-view');
                } catch (err) {
                    statusEl.innerHTML = `<span class="error">خطا: ${err.message}</span>`;
                } finally {
                    event.target.value = '';
                }
            });
            document.getElementById('confirm-payment-btn').addEventListener('click', async (event) => {
                const button = event.target;
                const amount = parseFloat(button.dataset.amount);
                const address = button.dataset.address;
                if(amount > WalletLogic.calculateBalance()) {
                    alert('موجودی کافی نیست.');
                    return;
                }

                const proposal = await WalletLogic.createProposal(amount, address);
                generateQrCode(proposal, 'qr-display-box');
                document.getElementById('qr-display-title').textContent = 'تایید تراکنش';
                document.getElementById('qr-display-instruction').textContent = 'تراکنش آماده شد. از گیرنده بخواهید این کد را برای دریافت وجه اسکن کند.';
                document.getElementById('scan-receipt-label').style.display = 'block';
                document.getElementById('qr-status').innerHTML = '';
                showView('qr-display-view');
            });

            // --- Finalization (Claiming and Receipt Scanning) ---
            document.getElementById('scan-proposal-input').addEventListener('change', async (event) => {
                 const file = event.target.files[0];
                 if (!file) return;
                 const statusEl = document.getElementById('proposal-status');
                 try {
                    statusEl.innerHTML = '<span class="info">کد شناسایی شد. در حال تایید...</span>';
                    const proposal = await decodeQrFromFile(file);
                    if (proposal.type !== 'AURA_PROPOSAL') throw new Error('این یک کد تراکنش معتبر نیست.');
                    const message = JSON.stringify({ ...proposal, signature: undefined });
                    const signerAddress = ethers.verifyMessage(message, proposal.signature);
                    if (signerAddress !== proposal.senderAddress) throw new Error("امضای فرستنده نامعتبر است.");
                    if (await PinataLedger.hasBeenSpent(proposal.txHash)) throw new Error('این تراکنش قبلاً پردازش شده است.');
                    statusEl.innerHTML = '<span class="info">تراکنش معتبر است. در حال ساخت رسید...</span>';
                    const receipt = await WalletLogic.createReceipt(proposal);
                    generateQrCode(receipt, 'qr-display-box');
                    document.getElementById('qr-display-title').textContent = 'ارائه رسید به فرستنده';
                    document.getElementById('qr-display-instruction').textContent = 'این کد رسید را به فرستنده نشان دهید تا تراکنش را نهایی کند.';
                    document.getElementById('scan-receipt-label').style.display = 'none';
                    showView('qr-display-view');
                    updateBalanceDisplay();
                } catch (err) { statusEl.innerHTML = `<span class="error">خطا: ${err.message}</span>`; } finally { event.target.value = ''; }
            });
            document.getElementById('scan-receipt-input').addEventListener('change', async (event) => {
                 const file = event.target.files[0];
                 if (!file) return;
                 const statusEl = document.getElementById('qr-status');
                 try {
                    statusEl.innerHTML = '<span class="info">در حال پردازش رسید...</span>';
                    const receipt = await decodeQrFromFile(file);
                    if (receipt.type !== 'AURA_RECEIPT') throw new Error('این یک کد QR رسید معتبر نیست.');
                    await WalletLogic.verifyAndFinalize(receipt);
                    statusEl.innerHTML = '<span class="success">تراکنش با موفقیت نهایی شد!</span>';
                    updateBalanceDisplay();
                    setTimeout(() => showView('wallet-view'), 2000);
                } catch (err) { statusEl.innerHTML = `<span class="error">خطا: ${err.message}</span>`; } finally { event.target.value = ''; }
            });

            // --- Banknote Charging (Unchanged) ---
            document.getElementById('public-key-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (!file) return; const keyStatus = document.getElementById('key-status'); keyStatus.innerHTML = '<span class="info">در حال پردازش کلید...</span>'; document.getElementById('banknote-image-input').disabled = true; state.masterPublicKey = null; try { const keyData = JSON.parse(await file.text()); if (!keyData.masterPublicKey) throw new Error("فایل JSON فاقد 'masterPublicKey' است."); state.masterPublicKey = CoreLogic.Utils.base64ToUint8Array(keyData.masterPublicKey); keyStatus.innerHTML = '<span class="success">کلید عمومی با موفقیت بارگذاری شد.</span>'; document.getElementById('banknote-image-input').disabled = false; } catch (err) { keyStatus.innerHTML = `<span class="error">خطا: ${err.message}</span>`; } });
            document.getElementById('banknote-image-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (!file) return; const statusEl = document.getElementById('validation-status'); const confirmSection = document.getElementById('charge-confirmation'); confirmSection.style.display = 'none'; if (!state.masterPublicKey) { statusEl.innerHTML = '<span class="error">لطفا ابتدا کلید عمومی بانک را بارگذاری کنید.</span>'; return; } statusEl.innerHTML = '<span class="info">در حال آماده‌سازی تصویر...</span>'; try { const resizedDataUrl = await CoreLogic.Utils.resizeImage(file, CoreLogic.Constants.MAX_IMAGE_DIMENSION); const processedDataUrl = await CoreLogic.Utils.preprocessImage(resizedDataUrl); const imageData = await new Promise((res, rej) => { const i = new Image(); i.onload = () => { const c = document.createElement('canvas'); c.width = i.width; c.height = i.height; const x = c.getContext('2d'); x.drawImage(i, 0, 0); res(x.getImageData(0, 0, i.width, i.height)); }; i.onerror = rej; i.src = processedDataUrl; }); const payload = await CoreLogic.Banknote.decodeQrGrid(imageData, statusEl); statusEl.innerHTML = '<span class="info">اسکن کامل شد. در حال تایید امضاها و بررسی لجر عمومی...</span>'; const banknoteData = CoreLogic.Banknote.parsePayload(payload); if (await PinataLedger.hasBeenSpent(banknoteData.serial)) { throw new Error("این اسکناس قبلاً طبق لجر عمومی خرج شده است."); } const isSigOneValid = await CoreLogic.Crypto.verifySignature(banknoteData.signatureOne, CoreLogic.Banknote.getStandardizedDataForSigning(banknoteData), banknoteData.ephemeralPublicKey, state.falconApi); if (!isSigOneValid) throw new Error("اعتبارسنجی امضا (داخلی) ناموفق بود."); const isSigTwoValid = await CoreLogic.Crypto.verifySignature(banknoteData.signatureTwo, CoreLogic.Banknote.getStandardizedDataForMasterSig(banknoteData), state.masterPublicKey, state.falconApi); if (!isSigTwoValid) throw new Error("اعتبارسنجی امضا (صادرکننده) ناموفق بود."); statusEl.innerHTML = '<span class="success">اسکناس معتبر است!</span>'; document.getElementById('validated-amount').textContent = `$${banknoteData.amount.toFixed(2)}`; const confirmBtn = document.getElementById('confirm-charge-button'); confirmBtn.dataset.amount = banknoteData.amount; confirmBtn.dataset.serial = banknoteData.serial; confirmSection.style.display = 'block'; } catch (err) { statusEl.innerHTML = `<span class="error">اعتبارسنجی ناموفق: ${err.message}</span>`; } finally { event.target.value = ''; } });
            document.getElementById('confirm-charge-button').addEventListener('click', async (event) => { const button = event.target; button.disabled = true; const amount = parseFloat(button.dataset.amount); const serial = button.dataset.serial; if (isNaN(amount) || !serial) { alert("خطایی رخ داد. لطفا دوباره اسکن کنید."); showView('wallet-view'); return; } const success = await PinataLedger.recordSpentIdentifier(serial, 'banknote'); if (!success) { showView('wallet-view'); return; } WalletLogic.addToChain({ type: 'charge', amount: amount, serial: serial, status: 'completed' }); updateBalanceDisplay(); alert(`$${amount.toFixed(2)} با موفقیت اضافه شد.`); showView('wallet-view'); });
        }
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
