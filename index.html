<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sadat Digital Banknote - USER WALLET</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Roboto+Mono:wght@700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
</head>
<style>
    :root { --primary-font: 'Poppins', 'Segoe UI', sans-serif; --mono-font: 'Roboto Mono', monospace; --dark-bg: #1a101a; --medium-bg: #2e1a2e; --light-bg: #3e2a3e; --accent-color-1: #00e676; --accent-color-2: #40c4ff; --text-color: #e0e0e0; --text-muted: #a0a0c0; --success-color: #00e676; --error-color: #ff5252; --info-color: #40c4ff; --warning-color: #ffab40; --border-color: rgba(0, 230, 118, 0.2); }
    body { margin: 0; font-family: var(--primary-font); background-color: var(--dark-bg); color: var(--text-color); text-align: center; padding: 24px; }
    .container { max-width: 800px; margin: 0 auto; background: rgba(46, 26, 46, 0.7); backdrop-filter: blur(12px); padding: 24px; border-radius: 24px; border: 1px solid var(--border-color); }
    h1 { font-size: 2.5rem; font-weight: 600; color: #fff; margin: 0 0 8px 0; background: linear-gradient(90deg, var(--accent-color-1), var(--accent-color-2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    button, label.button { padding: 14px 22px; font-size: 16px; border-radius: 12px; margin: 8px 5px; border: 1px solid var(--border-color); background: var(--medium-bg); color: #fff; transition: all 0.3s ease; cursor: pointer; outline: none; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
    button.primary { font-weight: 600; background: linear-gradient(90deg, var(--accent-color-1), var(--accent-color-2)); border: none; }
    button:hover, label.button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 230, 118, 0.2); }
    .section { background: rgba(26, 16, 26, 0.5); padding: 20px; margin-top: 30px; border-radius: 16px; border: 1px solid var(--border-color); }
    h2 { font-size: 1.5rem; margin-top: 0; }
    .status-box { margin-top: 20px; font-size: 14px; min-height: 50px; line-height: 1.6; text-align: left; background: var(--dark-bg); padding: 15px 20px; border-radius: 12px; white-space: pre-wrap; font-family: var(--mono-font); border: 1px solid var(--border-color); }
    .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.85); align-items: center; justify-content: center; flex-direction: column; }
    .modal-content { background-color: var(--medium-bg); padding: 30px; border: 1px solid var(--border-color); width: 90%; max-width: 500px; border-radius: 16px; text-align: center; }
    #qr-display { margin: 20px auto; background: white; padding: 15px; border-radius: 8px; width: fit-content; }
    .hidden { display: none; }
    .valid { color: var(--success-color); } .invalid { color: var(--error-color); } .info { color: var(--info-color); } .warning { color: var(--warning-color); }
    #video-scanner { display: none; width: 100%; max-width: 400px; border-radius: 8px; margin: 15px auto; border: 1px solid var(--border-color); }
</style>
<body>
<div class="container">
    <h1>User Wallet</h1>
    <p>SADAT DIGITAL BANKNOTE</p>

    <div class="section" id="wallet-setup">
        <h2>Wallet Setup</h2>
        <label for="load-note-image" class="button">1. Load Banknote Image (.png)</label>
        <input type="file" id="load-note-image" class="hidden" accept="image/png">
        <label for="load-spend-key" class="button">2. Load Spend Key (.json)</label>
        <input type="file" id="load-spend-key" class="hidden" accept="application/json">
        <div id="setup-status" class="status-box warning">‚ö†Ô∏è Please load a banknote and its corresponding spend key.</div>
    </div>

    <div class="section hidden" id="wallet-main">
        <h2>Banknote Details</h2>
        <p>Serial: <strong id="note-serial"></strong></p>
        <p style="font-size: 2rem; font-family: var(--mono-font);">Amount: <strong id="note-amount"></strong></p>
        <hr style="border-color: var(--border-color); margin: 20px 0;">
        <button id="send-btn" class="primary">üí∏ Send</button>
        <button id="receive-btn" class="primary">üí∞ Receive</button>
        <div id="tx-status" class="status-box info">‚ÑπÔ∏è Ready to transact.</div>
    </div>
</div>

<div id="tx-modal" class="modal">
    <div class="modal-content">
        <h2 id="modal-title"></h2>
        <p id="modal-instruction"></p>
        
        <video id="video-scanner" playsinline></video>
        <div id="qr-display"></div>

        <div id="modal-input-area"></div>
        <div id="modal-actions" style="margin-top: 20px;"></div>

        <button id="modal-cancel-btn" style="margin-top: 15px;">Cancel</button>
    </div>
</div>

<script type="module">
// --- DEPENDENCIES (Keep these locally for full offline use) ---
import pqcSignFalcon1024 from './pqc-sign-falcon-1024.min.js';
import { shake256, sha3_256 } from 'https://cdn.skypack.dev/js-sha3';

// --- Global State ---
const state = {
    falconApi: null,
    noteData: null,
    spendPrivateKey: null,
    videoStream: null,
};

// --- CONSTANTS ---
const Constants = {
    VALIDATION_PREFIX: "SADAT_V3_PART",
    NUM_QR_CODES: 9
};

// --- DOM Elements ---
const DOMElements = {
    loadNoteImage: document.getElementById('load-note-image'),
    loadSpendKey: document.getElementById('load-spend-key'),
    setupStatus: document.getElementById('setup-status'),
    walletSetup: document.getElementById('wallet-setup'),
    walletMain: document.getElementById('wallet-main'),
    noteSerial: document.getElementById('note-serial'),
    noteAmount: document.getElementById('note-amount'),
    sendBtn: document.getElementById('send-btn'),
    receiveBtn: document.getElementById('receive-btn'),
    txStatus: document.getElementById('tx-status'),
    txModal: document.getElementById('tx-modal'),
    modalTitle: document.getElementById('modal-title'),
    modalInstruction: document.getElementById('modal-instruction'),
    qrDisplay: document.getElementById('qr-display'),
    modalInputArea: document.getElementById('modal-input-area'),
    modalActions: document.getElementById('modal-actions'),
    modalCancelBtn: document.getElementById('modal-cancel-btn'),
    videoScanner: document.getElementById('video-scanner'),
};

// --- Utility and Crypto Functions ---
const Utils = {
    arrayBufferToBase64: (buffer) => btoa(String.fromCharCode(...new Uint8Array(buffer))),
    base64ToUint8Array: (base64) => Uint8Array.from(atob(base64), c => c.charCodeAt(0)),
    hexToUint8Array: (hex) => new Uint8Array(hex.match(/.{1,2}/g).map(byte => parseInt(byte, 16))),
    updateStatus: (element, message, type = 'info') => {
        element.innerHTML = `<span class="${type}">${message}</span>`;
    },
    async createQrCodeImage(payload) {
        const qr = qrcode(0, 'M');
        qr.addData(payload);
        qr.make();
        const dataUrl = qr.createDataURL(8, 4); // Creates a PNG image data URL
        const img = new Image();
        img.src = dataUrl;
        await new Promise(resolve => { img.onload = resolve; });
        return {img, dataUrl};
    },
    async startQrScanner(onQrCode) {
        if (state.videoStream) {
            state.videoStream.getTracks().forEach(track => track.stop());
        }
        try {
            DOMElements.videoScanner.style.display = 'block';
            state.videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            DOMElements.videoScanner.srcObject = state.videoStream;
            DOMElements.videoScanner.play();

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d', { willReadFrequently: true });
            
            const scan = () => {
                if (DOMElements.videoScanner.readyState === DOMElements.videoScanner.HAVE_ENOUGH_DATA) {
                    canvas.width = DOMElements.videoScanner.videoWidth;
                    canvas.height = DOMElements.videoScanner.videoHeight;
                    ctx.drawImage(DOMElements.videoScanner, 0, 0, canvas.width, canvas.height);
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const code = jsQR(imageData.data, imageData.width, imageData.height);
                    if (code) {
                        onQrCode(code.data);
                        this.stopQrScanner();
                        return;
                    }
                }
                if (state.videoStream) {
                    requestAnimationFrame(scan);
                }
            };
            requestAnimationFrame(scan);
        } catch (err) {
            alert("Error accessing camera. Please ensure you have given permission and are using a secure (HTTPS) connection. " + err.message);
            this.stopQrScanner();
        }
    },
    stopQrScanner() {
        if (state.videoStream) {
            state.videoStream.getTracks().forEach(track => track.stop());
            state.videoStream = null;
        }
        DOMElements.videoScanner.style.display = 'none';
        DOMElements.videoScanner.srcObject = null;
    },
    decodeQrCodeFromImage(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (event) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = img.width; canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);
                if (code) resolve(code.data); else reject(new Error("QR Code not found in image."));
            };
            img.onerror = () => reject(new Error("Could not load image file."));
            img.src = event.target.result;
        };
        reader.onerror = () => reject(new Error("Failed to read file."));
        reader.readAsDataURL(file);
      });
    }
};

const BankCrypto = (() => {
    function hash(message) { return new Uint8Array(sha3_256.arrayBuffer(message)); }
    function hashForSigning(message) { return Utils.hexToUint8Array(shake256(message, 1536)); }

    return {
        hash,
        generateNewKeyPair: () => state.falconApi.keypair(),
        signData: async (data, privateKey) => {
            const dataHash = hashForSigning(data);
            const { signature } = await state.falconApi.sign(dataHash, privateKey);
            return signature;
        },
        verifySignature: (signature, data, publicKey) => {
            const dataHash = hashForSigning(data);
            return state.falconApi.verify(signature, dataHash, publicKey);
        },
    };
})();

const Wallet = (() => {

    async function loadNote() {
        try {
            const file = DOMElements.loadNoteImage.files[0];
            if (!file) return;

            const banknoteImage = new Image();
            banknoteImage.src = URL.createObjectURL(file);
            await new Promise((resolve, reject) => {
                banknoteImage.onload = resolve;
                banknoteImage.onerror = reject;
            });

            const canvas = document.createElement('canvas');
            canvas.width = banknoteImage.width;
            canvas.height = banknoteImage.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(banknoteImage, 0, 0);

            const qrSize = 250, xSpacing = 20, ySpacing = 20;
            const grid = {
                startX: Math.round((canvas.width - ((qrSize * 3) + (xSpacing * 2))) / 2),
                startY: Math.round((canvas.height - ((qrSize * 3) + (ySpacing * 2))) / 2)
            };
            
            const receivedParts = {};
            let foundCount = 0;
            for (let i = 0; i < Constants.NUM_QR_CODES; i++) {
                const row = Math.floor(i / 3), col = i % 3;
                const regionX = grid.startX + col * (qrSize + xSpacing);
                const regionY = grid.startY + row * (qrSize + ySpacing);
                const imageData = ctx.getImageData(regionX, regionY, qrSize, qrSize);
                const code = jsQR(imageData.data, imageData.width, imageData.height);
                if (code && code.data.startsWith(Constants.VALIDATION_PREFIX)) {
                    const match = code.data.substring(Constants.VALIDATION_PREFIX.length).match(/^(\d+)\/(\d+):(.*)$/s);
                    if (match) {
                        receivedParts[parseInt(match[1], 10)] = match[3];
                        foundCount++;
                    }
                }
            }
             if (foundCount < Constants.NUM_QR_CODES) throw new Error("Could not read all QR codes from banknote.");

            let fullPayloadString = '';
            for (let i = 1; i <= Constants.NUM_QR_CODES; i++) {
                fullPayloadString += receivedParts[i];
            }
            
            const compressedData = Utils.base64ToUint8Array(fullPayloadString);
            const jsonString = pako.inflate(compressedData, { to: 'string' });
            state.noteData = JSON.parse(jsonString);

            checkReadyState();

        } catch (e) {
            Utils.updateStatus(DOMElements.setupStatus, `‚ùå Error loading banknote: ${e.message}`, 'error');
            state.noteData = null;
        }
    }

    async function loadKey() {
        try {
            const file = DOMElements.loadSpendKey.files[0];
            if (!file) return;
            const keyData = JSON.parse(await file.text());
            if (state.noteData && state.noteData.serial !== keyData.serial) {
                throw new Error("Spend Key does not match the loaded banknote serial.");
            }
            state.spendPrivateKey = Utils.base64ToUint8Array(keyData.spendPrivateKey_b64);
            checkReadyState();
        } catch(e) {
            Utils.updateStatus(DOMElements.setupStatus, `‚ùå Error loading key: ${e.message}`, 'error');
            state.spendPrivateKey = null;
        }
    }

    function checkReadyState() {
        let noteLoaded = !!state.noteData;
        let keyLoaded = !!state.spendPrivateKey;
        Utils.updateStatus(DOMElements.setupStatus, `Banknote Loaded: ${noteLoaded ? '‚úÖ' : '‚ùå'}\nSpend Key Loaded: ${keyLoaded ? '‚úÖ' : '‚ùå'}`, noteLoaded && keyLoaded ? 'success' : 'warning');
        
        if (noteLoaded && keyLoaded) {
            DOMElements.walletSetup.classList.add('hidden');
            DOMElements.walletMain.classList.remove('hidden');
            DOMElements.noteSerial.textContent = state.noteData.serial;
            DOMElements.noteAmount.textContent = state.noteData.amount.toLocaleString('en-US');
        }
    }

    // --- RECEIVE FLOW ---
    async function startReceive() {
        DOMElements.modalTitle.textContent = "Receive Payment";
        DOMElements.modalInstruction.textContent = "Show this QR code to the sender to initiate the transaction.";
        DOMElements.qrDisplay.innerHTML = '';
        DOMElements.modalInputArea.innerHTML = '';
        DOMElements.modalActions.innerHTML = '';
        DOMElements.txModal.style.display = 'flex';

        const challengeNonce = crypto.randomUUID();
        const challengePayload = JSON.stringify({ nonce: challengeNonce });

        const {img, dataUrl} = await Utils.createQrCodeImage(challengePayload);
        DOMElements.qrDisplay.appendChild(img);

        DOMElements.modalActions.innerHTML = `
            <button id="download-qr-btn">üì• Download QR (.png)</button>
            <button id="nfc-receive-btn" title="Feature coming soon">NFC üì°</button>
            <button id="bt-receive-btn" title="Feature coming soon">Bluetooth üîµ</button>
        `;
        document.getElementById('download-qr-btn').onclick = () => {
            const a = document.createElement('a');
            a.href = dataUrl;
            a.download = `sadat-receive-qr-${Date.now()}.png`;
            a.click();
        };
        
        DOMElements.modalInputArea.innerHTML = `<hr><p>After the sender scans your code, scan the transfer QR code they provide to complete the transaction:</p>
            <button id="scan-transfer-btn" class="primary">üì∑ Scan Transfer QR</button>
            <label for="upload-transfer-qr" class="button">üì§ or Upload QR Image</label>
            <input type="file" id="upload-transfer-qr" class="hidden" accept="image/png">`;

        document.getElementById('scan-transfer-btn').onclick = () => {
             Utils.startQrScanner(data => completeReceive(data, challengeNonce));
        };
        document.getElementById('upload-transfer-qr').onchange = async (e) => {
            try {
                const data = await Utils.decodeQrCodeFromImage(e.target.files[0]);
                completeReceive(data, challengeNonce);
            } catch (err) {
                alert(`‚ùå QR Decode Failed: ${err.message}`);
            }
        };
    }
    
    async function completeReceive(transferQrData, challengeNonce) {
        try {
            const transferData = JSON.parse(transferQrData);

            if (transferData.nonce !== challengeNonce) {
                throw new Error("Nonce mismatch! This transaction is for someone else or is outdated.");
            }

            const currentSpendPublicKey = Utils.base64ToUint8Array(state.noteData.spendPublicKey_b64);
            const signedData = JSON.stringify({ transfer: true, nonce: transferData.nonce });
            const signature = Utils.base64ToUint8Array(transferData.signature_b64);
            const isSignatureValid = await BankCrypto.verifySignature(signature, signedData, currentSpendPublicKey);

            if (!isSignatureValid) {
                throw new Error("Invalid sender signature!");
            }
            
            // NOTE: This is a simplified prototype step.
            const newSpendKey_b64 = transferData.newSpendPrivateKey_b64; 
            if (!newSpendKey_b64) throw new Error("New spend key was not received from the sender.");

            state.noteData.spendPublicKey_b64 = transferData.newSpendPublicKey_b64;
            state.noteData.history = state.noteData.history || [];
            state.noteData.history.push({ timestamp: Date.now(), nonce: transferData.nonce });
            state.spendPrivateKey = Utils.base64ToUint8Array(newSpendKey_b64);

            alert("‚úÖ Transaction successful! You are now the owner of the banknote. You would now save the new banknote data.");
            resetWallet();

        } catch(err) {
            alert(`‚ùå Transaction Failed: ${err.message}`);
        } finally {
            closeModal();
        }
    }

    // --- SEND FLOW ---
    async function startSend() {
        DOMElements.modalTitle.textContent = "Send Payment";
        DOMElements.modalInstruction.textContent = "Scan the recipient's QR code to begin.";
        DOMElements.qrDisplay.innerHTML = '';
        DOMElements.modalInputArea.innerHTML = '';
        DOMElements.modalActions.innerHTML = `
            <button id="scan-challenge-btn" class="primary">üì∑ Scan Recipient's QR</button>
            <label for="upload-challenge-qr" class="button">üì§ or Upload QR Image</label>
            <input type="file" id="upload-challenge-qr" class="hidden" accept="image/png">
            <button id="nfc-send-btn" title="Feature coming soon">NFC üì°</button>
            <button id="bt-send-btn" title="Feature coming soon">Bluetooth üîµ</button>
        `;
        DOMElements.txModal.style.display = 'flex';

        document.getElementById('scan-challenge-btn').onclick = () => {
            Utils.startQrScanner(data => completeSend(data));
        };
        document.getElementById('upload-challenge-qr').onchange = async (e) => {
            try {
                const data = await Utils.decodeQrCodeFromImage(e.target.files[0]);
                completeSend(data);
            } catch (err) {
                alert(`‚ùå QR Decode Failed: ${err.message}`);
            }
        };
    }

    async function completeSend(challengeQrData) {
        try {
            const challengeData = JSON.parse(challengeQrData);
            const nonce = challengeData.nonce;
            if (!nonce) throw new Error("Invalid challenge QR: missing nonce.");

            const newSpendKeyPair = await BankCrypto.generateNewKeyPair();
            const signedData = JSON.stringify({ transfer: true, nonce: nonce });
            const signature = await BankCrypto.signData(signedData, state.spendPrivateKey);
            
            const transferPayload = {
                nonce: nonce,
                signature_b64: Utils.arrayBufferToBase64(signature),
                newSpendPublicKey_b64: Utils.arrayBufferToBase64(newSpendKeyPair.publicKey),
                // INNOVATION: For this prototype, the private key is sent directly.
                // In a real system, this MUST be encrypted for the recipient.
                newSpendPrivateKey_b64: Utils.arrayBufferToBase64(newSpendKeyPair.privateKey),
            };

            DOMElements.modalInstruction.textContent = "Have the recipient scan this QR code to complete the transfer.";
            DOMElements.modalActions.innerHTML = ''; // Clear action buttons
            const {img, dataUrl} = await Utils.createQrCodeImage(JSON.stringify(transferPayload));
            DOMElements.qrDisplay.innerHTML = '';
            DOMElements.qrDisplay.appendChild(img);
            DOMElements.modalInputArea.innerHTML = `<button id="download-final-qr-btn">üì• Download Transfer QR (.png)</button>`;
            document.getElementById('download-final-qr-btn').onclick = () => {
                const a = document.createElement('a');
                a.href = dataUrl;
                a.download = `sadat-transfer-qr-${Date.now()}.png`;
                a.click();
            };
            
            alert("Transfer QR code has been generated. Once the recipient scans it, you will no longer own this banknote.");
            resetWalletOnSuccess(); 

        } catch (err) {
            alert(`‚ùå Transaction Failed: ${err.message}`);
            closeModal();
        }
    }
    
    function closeModal() {
        Utils.stopQrScanner();
        DOMElements.txModal.style.display = 'none';
    }

    function resetWallet() {
        state.noteData = null;
        state.spendPrivateKey = null;
        DOMElements.walletMain.classList.add('hidden');
        DOMElements.walletSetup.classList.remove('hidden');
        Utils.updateStatus(DOMElements.setupStatus, `‚ö†Ô∏è Please load a banknote and its corresponding spend key.`, 'warning');
        DOMElements.loadNoteImage.value = '';
        DOMElements.loadSpendKey.value = '';
    }
    
    function resetWalletOnSuccess() {
        state.noteData = null;
        state.spendPrivateKey = null;
        DOMElements.walletMain.classList.add('hidden');
        DOMElements.walletSetup.classList.remove('hidden');
        Utils.updateStatus(DOMElements.setupStatus, `‚úÖ Banknote sent. Your wallet is now empty.`, 'success');
        DOMElements.loadNoteImage.value = '';
        DOMElements.loadSpendKey.value = '';
    }

    return { loadNote, loadKey, startReceive, startSend, resetWallet };
})();

// --- Main Application Setup ---
async function main() {
    Utils.updateStatus(DOMElements.setupStatus, '‚è≥ Loading Falcon-1024 Cryptography Module...', 'info');
    try {
        // You MUST host this .js file on your server or use a valid CDN.
        // For local testing, place it in the same folder as your index.html
        state.falconApi = await pqcSignFalcon1024();
        Utils.updateStatus(DOMElements.setupStatus, '‚úÖ Wallet ready. Please load banknote.', 'success');
    } catch (e) {
        Utils.updateStatus(DOMElements.setupStatus, `‚ùå Critical Error: Could not load crypto modules. Ensure you are running this from a web server (https://).`, 'error');
        console.error(e);
        return;
    }

    DOMElements.loadNoteImage.addEventListener('change', Wallet.loadNote);
    DOMElements.loadSpendKey.addEventListener('change', Wallet.loadKey);
    DOMElements.sendBtn.addEventListener('click', Wallet.startSend);
    DOMElements.receiveBtn.addEventListener('click', Wallet.startReceive);
    DOMElements.modalCancelBtn.addEventListener('click', () => {
        closeModal();
        // If wallet was reset pending a send, finalize the reset view
        if (!state.noteData) Wallet.resetWallet();
    });
    
    function closeModal() {
        Utils.stopQrScanner();
        DOMElements.txModal.style.display = 'none';
    }
}

main();
</script>
</body>
</html>
