<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <title>Sadat Digital Banknote - 3-QR System</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-font: 'Poppins', 'Segoe UI', sans-serif;
            --mono-font: 'Roboto Mono', monospace;
            --dark-bg: #10101a;
            --medium-bg: #1a1a2e;
            --light-bg: #2a2a3e;
            --accent-color-1: #e040fb;
            --accent-color-2: #7c4dff;
            --text-color: #e0e0e0;
            --text-muted: #a0a0c0;
            --success-color: #00e676;
            --error-color: #ff5252;
            --info-color: #40c4ff;
            --warning-color: #ffab40;
            --border-color: rgba(124, 77, 255, 0.2);
        }
        body { margin: 0; font-family: var(--primary-font); background-color: var(--dark-bg); background-image: radial-gradient(at 0% 0%, hsla(253, 100%, 15%, 0.3) 0px, transparent 50%), radial-gradient(at 100% 100%, hsla(263, 100%, 20%, 0.3) 0px, transparent 50%); color: var(--text-color); text-align: center; padding: 24px; }
        .container { max-width: 1200px; margin: 0 auto; background: rgba(26, 26, 46, 0.7); backdrop-filter: blur(12px); padding: 24px; border-radius: 24px; border: 1px solid var(--border-color); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2); }
        .header { border-bottom: 1px solid var(--border-color); padding-bottom: 16px; margin-bottom: 24px; }
        h1 { font-size: 2.5rem; font-weight: 600; color: #fff; margin: 0 0 8px 0; letter-spacing: 1px; background: linear-gradient(90deg, var(--accent-color-1), var(--accent-color-2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .header p { font-size: 1rem; color: var(--text-muted); margin: 0; }
        canvas#noteCanvas { border-radius: 16px; margin-top: 24px; background: #050508; cursor: default; box-shadow: 0 0 50px rgba(124, 77, 255, 0.15); width: 100%; max-width: 1200px; height: auto; border: 1px solid var(--border-color); }
        input, button, label { padding: 14px 22px; font-size: 16px; font-family: var(--primary-font); border-radius: 12px; margin: 8px 5px; border: 1px solid var(--border-color); background: var(--medium-bg); color: #fff; transition: all 0.3s ease; cursor: pointer; outline: none; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        input[type="number"], input[type="password"] { font-family: var(--mono-font); font-weight: 700; text-align: center; width: 150px; }
        input:focus { border-color: var(--accent-color-2); box-shadow: 0 0 15px rgba(124, 77, 255, 0.5); }
        button:not([disabled]), label.button:not([disabled]) { font-weight: 600; background: linear-gradient(90deg, var(--accent-color-1), var(--accent-color-2)); border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        button.sub-button, label.button.sub-button { background: var(--light-bg); border: 1px solid var(--border-color); }
        button[disabled], label.button[disabled] { cursor: not-allowed; opacity: 0.5; background: var(--light-bg); border: 1px solid var(--border-color); }
        button:hover:not([disabled]), label.button:hover:not([disabled]) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(124, 77, 255, 0.4); }
        .section { background: rgba(16, 16, 26, 0.5); padding: 20px; margin-top: 30px; border-radius: 16px; border: 1px solid var(--border-color); }
        h2 { font-size: 1.5rem; color: var(--text-color); margin-top: 0; margin-bottom: 20px; font-weight: 600; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .controls-grid { display: flex; justify-content: center; align-items: center; flex-wrap: wrap; gap: 16px; }
        .status-box { margin-top: 20px; font-size: 13px; font-weight: normal; min-height: 50px; line-height: 1.6; text-align: left; background: var(--dark-bg); padding: 15px 20px; border-radius: 12px; white-space: pre-wrap; font-family: var(--mono-font); border: 1px solid var(--border-color); transition: all 0.3s ease; }
        .valid { color: var(--success-color); } .invalid { color: var(--error-color); } .info { color: var(--info-color); } .warning { color: var(--warning-color); }
        code { background: var(--medium-bg); padding: 2px 6px; border-radius: 4px; font-size: 1em; }
        .input-label { font-size: 0.9rem; color: var(--text-muted); margin-right: -10px; }
        .modal { position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; }
        .modal-content { background-color: var(--medium-bg); padding: 30px; border: 1px solid var(--border-color); width: 80%; max-width: 500px; border-radius: 16px; text-align: center; }
        #qr-display { margin: 20px auto; background: white; padding: 15px; border-radius: 8px; width: fit-content; }
        #qr-display canvas { max-width: 100%; height: auto; }
        .pill { background-color: var(--border-color); color: var(--accent-color-1); padding: 5px 15px; border-radius: 20px; font-size: 14px; font-weight: 600; margin: 5px; display: inline-block; }
    </style>
</head>
<body>
<div class="container">
    <div class="header"><h1>Sadat Digital Banknote</h1><p>A Quantum-Resistant, Offline, Dual-Signature & <strong>3-QR-Code</strong> Digital Currency System.</p></div>
    <div class="section"><h2><span class="pill">Step 1</span> Guardian Setup: Create Master Keys</h2><div class="controls-grid"><button id="generate-keys-button">üîë Generate Master Key Pair</button><label for="import-public-key" class="button sub-button"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg> Load Public Key</label><input type="file" id="import-public-key" accept=".json" style="display: none;"></div><div id="key-gen-status" class="status-box"><span class="info">‚ÑπÔ∏è Welcome, Guardian. Generate a new Master Key Pair to begin your financial ecosystem. This process is fully offline and secure.</span></div></div>
    <div class="section"><h2><span class="pill">Step 2</span> Activate System: Reconstruct Private Key</h2><p style="color: var(--text-muted); font-size: 0.9em; max-width: 700px; margin: -10px auto 20px auto;">To create banknotes, you must prove your identity by solving the "Three-Piece Puzzle". This ensures maximum security.</p><div class="controls-grid"><label for="file-key-input" class="button sub-button">1. Upload File Key</label><input type="file" id="file-key-input" accept=".json" style="display:none;" /><input type="password" id="password-key-input" placeholder="2. Enter Password Key"><label for="visual-key-input" class="button sub-button">3. Upload Visual Key (QR)</label><input type="file" id="visual-key-input" accept="image/png, image/jpeg" style="display:none;" /></div><button id="reconstruct-key-button" disabled style="margin-top: 20px;">üîì Activate Master Private Key</button><div id="key-reconstruction-status" class="status-box"><span class="warning">‚ö†Ô∏è Master Private Key is INACTIVE. Solve the puzzle to activate.</span></div></div>
    <div class="section"><h2><span class="pill">Step 3</span> Create Wealth: Generate Banknotes</h2><div class="controls-grid"><span class="input-label">Amount:</span><input type="number" id="amount-input" value="50000"><span class="input-label">Quantity:</span><input type="number" id="quantity-input" value="1" min="1" max="100"><button id="create-note-button" disabled>üé® Create & Display Banknote</button><button id="download-batch-button" disabled>üì• Download Batch</button></div><div id="banknote-status" class="status-box">Use the controls above to create and sign new banknotes.</div><canvas id="noteCanvas" width="1200" height="533"></canvas></div>
    <div class="section" id="validator-section"><h2><span class="pill">Step 4</span> Verify Authenticity</h2><p style="color: var(--text-muted); font-size: 0.9em; max-width: 700px; margin: -10px auto 20px auto;">To verify a banknote, upload a clear picture of the <strong>entire banknote</strong>. The system will find and validate all three QR Codes.</p><label for="validator-input" class="button"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 15 17 10"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg> Select Banknote Image for Validation</label><input type="file" id="validator-input" accept="image/png, image/jpeg" style="display: none;"><div id="validation-result" class="status-box">Awaiting banknote for validation...</div></div>
</div>
<div id="qr-modal" class="modal"><div class="modal-content"><h2 id="qr-modal-title">Your Visual Key</h2><p>Print this QR Code or save the image file and store it in a secure physical location. It is the third piece of your Master Key puzzle.</p><div id="qr-display"></div><button id="download-qr-button" style="margin-top: 15px;">üíæ Download QR Code</button><button onclick="document.getElementById('qr-modal').style.display='none'">Close</button></div></div>

<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

<script type="module">
// --- DEPENDENCIES ---
// The QR libraries are now loaded from the CDN scripts above.
// The `pqc-sign...` file is still loaded locally.
import pqcSignFalcon1024 from './pqc-sign-falcon-1024.min.js';
import { shake256 } from 'https://cdn.skypack.dev/js-sha3';

// --- The rest of your JavaScript code remains the same ---
const state={falconApi:null,masterPublicKey:null,masterPrivateKey:null,puzzlePieces:{fileKey:null,passwordKey:null,visualKey:null}};const Constants={FALCON_PUBKEY_SIZE:1793,EPOCH:(new Date("2024-01-01T00:00:00Z")).getTime(),VALIDATION_PREFIX:"SADAT_V2_PART"};const DOMElements={generateKeysButton:document.getElementById("generate-keys-button"),importPublicKey:document.getElementById("import-public-key"),keyGenStatus:document.getElementById("key-gen-status"),fileKeyInput:document.getElementById("file-key-input"),passwordKeyInput:document.getElementById("password-key-input"),visualKeyInput:document.getElementById("visual-key-input"),reconstructKeyButton:document.getElementById("reconstruct-key-button"),keyReconstructionStatus:document.getElementById("key-reconstruction-status"),amountInput:document.getElementById("amount-input"),quantityInput:document.getElementById("quantity-input"),createNoteButton:document.getElementById("create-note-button"),downloadBatchButton:document.getElementById("download-batch-button"),noteCanvas:document.getElementById("noteCanvas"),banknoteStatus:document.getElementById("banknote-status"),validatorInput:document.getElementById("validator-input"),validationResult:document.getElementById("validation-result"),qrModal:document.getElementById("qr-modal"),qrDisplay:document.getElementById("qr-display"),qrModalTitle:document.getElementById("qr-modal-title"),downloadQrButton:document.getElementById("download-qr-button")};
const Utils={arrayBufferToBase64:e=>btoa(String.fromCharCode(...new Uint8Array(e))),base64ToUint8Array:e=>{const t=atob(e),r=t.length,o=new Uint8Array(r);for(let e=0;e<r;e++)o[e]=t.charCodeAt(e);return o},hexToUint8Array:e=>new Uint8Array(e.match(/.{1,2}/g).map(e=>parseInt(e,16))),downloadFile:(e,t,r)=>{const o=new Blob([e],{type:r}),n=URL.createObjectURL(o),s=document.createElement("a");s.href=n,s.download=t,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(n)},updateStatus:(e,t,r="info")=>{e.innerHTML=`<span class="${r}">${t}</span>`},log:(e,t="info")=>{const r={info:"‚ÑπÔ∏è",success:"‚úÖ",warning:"‚ö†Ô∏è",error:"‚ùå"}[t];console.log(`[Sadat System] ${r} ${e}`)},async createQrCanvas(e,t,r="#ffffff",o="#000000"){const n=document.createElement("div");return n.style.position="absolute",n.style.top="-9999px",document.body.appendChild(n),new QRCode(n,{text:e,width:t,height:t,colorDark:o,colorLight:r,correctLevel:QRCode.CorrectLevel.L}),new Promise(e=>{setTimeout(()=>{const o=n.querySelector("canvas");if("transparent"===r){const r=o.getContext("2d"),n=r.getImageData(0,0,t,t),s=n.data;for(let e=0;e<s.length;e+=4)255===s[e]&&255===s[e+1]&&255===s[e+2]&&(s[e+3]=0);r.putImageData(n,0,0)}document.body.removeChild(n),e(o)},50)})}};
const BankCrypto=function(){const e="AES-GCM";async function t(t,r){const o=new TextEncoder().encode(t),n=await crypto.subtle.importKey("raw",o,{name:"PBKDF2"},!1,["deriveKey"]);return await crypto.subtle.deriveKey({name:"PBKDF2",salt:r,iterations:1e5,hash:"SHA-256"},n,{name:e,length:256},!1,["encrypt","decrypt"])}function r(e){return Utils.hexToUint8Array(shake256(e,1536))}return{async generateNewKeyPair(){if(!state.falconApi)throw new Error("Falcon API not initialized.");return state.falconApi.keypair()},async signData(e,t){if(!t||!state.falconApi)throw new Error("Signing prerequisites not met.");const o=r(e);return(await state.falconApi.sign(o,t)).signature},async verifySignature(e,t,o){if(!o||!state.falconApi)throw new Error("Verification prerequisites not met.");const n=r(t);return state.falconApi.verify(e,n,o)},async encryptMasterKey(r,o,n){const s=crypto.getRandomValues(new Uint8Array(16)),a=crypto.getRandomValues(new Uint8Array(12)),i=await t(n,s),l=await crypto.subtle.encrypt({name:e,iv:a},i,r),c=JSON.stringify({encryptedKey:Utils.arrayBufferToBase64(l),salt:Utils.arrayBufferToBase64(s),iv:Utils.arrayBufferToBase64(a)}),d=crypto.getRandomValues(new Uint8Array(16)),u=crypto.getRandomValues(new Uint8Array(12)),p=await t(o,d),y=await crypto.subtle.encrypt({name:e,iv:u},p,new TextEncoder().encode(c));return{fileKey:{cipherText:Utils.arrayBufferToBase64(y),salt:Utils.arrayBufferToBase64(d),iv:Utils.arrayBufferToBase64(u)}}},async reconstructMasterKey(r,o,n){const s=Utils.base64ToUint8Array(r.salt),a=Utils.base64ToUint8Array(r.iv),i=Utils.base64ToUint8Array(r.cipherText),l=await t(o,s),c=await crypto.subtle.decrypt({name:e,iv:a},l,i),d=JSON.parse(new TextDecoder().decode(c)),u=Utils.base64ToUint8Array(d.salt),p=Utils.base64ToUint8Array(d.iv),y=Utils.base64ToUint8Array(d.encryptedKey),m=await t(n,u),g=await crypto.subtle.decrypt({name:e,iv:p},m,y);return new Uint8Array(g)}}}();
const UIHandlers=function(){function e(){const{fileKey:e,passwordKey:t,visualKey:r}=state.puzzlePieces;let o="";o+=e?'<span class="valid">‚úÖ File Key loaded.</span>\n':'<span class="invalid">‚ùå File Key NOT loaded.</span>\n',o+=t?'<span class="valid">‚úÖ Password Key entered.</span>\n':'<span class="invalid">‚ùå Password Key NOT entered.</span>\n',o+=r?'<span class="valid">‚úÖ Visual Key scanned.</span>\n':'<span class="invalid">‚ùå Visual Key NOT scanned.</span>\n',DOMElements.keyReconstructionStatus.innerHTML=o;const n=e&&t&&r;DOMElements.reconstructKeyButton.disabled=!n,n&&Utils.updateStatus(DOMElements.keyReconstructionStatus,"‚ö†Ô∏è All puzzle pieces provided. Click 'Activate' to unlock your private key.","warning")}async function t(e){return new Promise((t,r)=>{const o=new FileReader;o.onload=e=>{const n=new Image;n.onload=()=>{const e=document.createElement("canvas");e.width=n.width,e.height=n.height;const o=e.getContext("2d");o.drawImage(n,0,0,n.width,n.height);const s=o.getImageData(0,0,n.width,n.height),a=jsQR(s.data,s.width,s.height);a?t(a.data):r(new Error("No QR code found in the image."))},n.onerror=()=>r(new Error("Could not load image file.")),n.src=e.target.result},o.onerror=()=>r(new Error("Could not read file.")),o.readAsDataURL(e)})}return{handleGenerateAndExportKeys:async()=>{const e=prompt("Enter a strong password. This will be your 'Password Key' (Piece 2/3).");if(!e)return void Utils.updateStatus(DOMElements.keyGenStatus,"‚ùå Key generation cancelled. Password is required.","error");Utils.updateStatus(DOMElements.keyGenStatus,"‚è≥ Generating new Falcon-1024 key pair...","info");try{const t=await BankCrypto.generateNewKeyPair();state.masterPublicKey=t.publicKey,Utils.log("New Master Key Pair generated.","success"),Utils.updateStatus(DOMElements.keyGenStatus,"‚è≥ Creating puzzle pieces and encrypting private key...","info");const r=crypto.randomUUID(),{fileKey:o}=await BankCrypto.encryptMasterKey(t.privateKey,e,r),n=Utils.arrayBufferToBase64(t.publicKey);Utils.downloadFile(JSON.stringify({masterPublicKey:n},null,2),"Sadat-MASTER-PUBLIC-KEY.json","application/json"),Utils.downloadFile(JSON.stringify(o,null,2),"Sadat-FILE-KEY.json","application/json"),DOMElements.qrModalTitle.innerText="Your Visual Key (Piece 3/3)",DOMElements.qrDisplay.innerHTML="";const s=await Utils.createQrCanvas(r,256,"#ffffff");DOMElements.qrDisplay.appendChild(s),DOMElements.qrModal.style.display="flex",Utils.updateStatus(DOMElements.keyGenStatus,"‚úÖ New key pair generated!\n- MASTER-PUBLIC-KEY.json (share this)\n- FILE-KEY.json (keep this on a USB)\n- Password (memorize this)\n- Visual Key QR Code (print and secure this)\nThe new Public Key is now active for validation.","success")}catch(e){Utils.log(`Key generation failed: ${e.message}`,"error"),Utils.updateStatus(DOMElements.keyGenStatus,`‚ùå Failed to generate keys: ${e.message}`,"error")}},handleImportPublicKey:async e=>{const t=e.target.files[0];if(t)try{const r=JSON.parse(await t.text());if(!r.masterPublicKey)throw new Error("Invalid public key file format.");state.masterPublicKey=Utils.base64ToUint8Array(r.masterPublicKey),Utils.updateStatus(DOMElements.keyGenStatus,"‚úÖ Public key imported. Ready to validate banknotes.","success"),DOMElements.validatorInput.disabled=!1}catch(e){Utils.updateStatus(DOMElements.keyGenStatus,`‚ùå Error importing public key: ${e.message}`,"error")}finally{e.target.value=""}},handleFileKeyInput:async t=>{const r=t.target.files[0];if(r)try{state.puzzlePieces.fileKey=JSON.parse(await r.text()),Utils.log("File Key loaded.","success")}catch(t){state.puzzlePieces.fileKey=null,Utils.log(`Failed to load File Key: ${t.message}`,"error")}finally{e(),t.target.value=""}},handlePasswordKeyInput:t=>{state.puzzlePieces.passwordKey=t.target.value||null,e()},handleVisualKeyInput:async r=>{const o=r.target.files[0];if(o)try{const e=await t(o);state.puzzlePieces.visualKey=e,Utils.log("Visual Key loaded from QR code.","success")}catch(e){state.puzzlePieces.visualKey=null,Utils.log(`Error decoding QR Code: ${e.message}`,"error")}finally{e(),r.target.value=""}},handleReconstructKey:async()=>{const{fileKey:e,passwordKey:t,visualKey:r}=state.puzzlePieces;if(!e||!t||!r)return void Utils.updateStatus(DOMElements.keyReconstructionStatus,"‚ùå All three puzzle pieces are required.","error");Utils.updateStatus(DOMElements.keyReconstructionStatus,"‚è≥ Reconstructing Master Private Key...","info");try{state.masterPrivateKey=await BankCrypto.reconstructMasterKey(e,t,r);const o=new TextEncoder().encode("test"),n=await BankCrypto.signData(o,state.masterPrivateKey),s=await BankCrypto.verifySignature(n,o,state.masterPublicKey);if(!s)throw new Error("Key reconstruction failed self-test. The provided pieces do not match the active public key.");Utils.updateStatus(DOMElements.keyReconstructionStatus,"‚úÖ Master Private Key ACTIVE. You can now create banknotes.","success"),DOMElements.createNoteButton.disabled=!1,DOMElements.downloadBatchButton.disabled=!1}catch(e){console.error(e),Utils.updateStatus(DOMElements.keyReconstructionStatus,`‚ùå Failed to reconstruct key. ${e.message}`,"error"),state.masterPrivateKey=null,DOMElements.createNoteButton.disabled=!0,DOMElements.downloadBatchButton.disabled=!0}}}}();
const BanknoteLogic=function(){const e=e=>JSON.stringify({timestamp:e.timestamp,serial:e.serial},["timestamp","serial"]),t=e=>{const t={ephemeralPublicKey:Utils.arrayBufferToBase64(e.ephemeralPublicKey),signatureOne:Utils.arrayBufferToBase64(e.signatureOne)};return JSON.stringify(t,Object.keys(t).sort())},r=async r=>{if(!state.masterPrivateKey)throw new Error("Master Private Key is not active.");const o=await BankCrypto.generateNewKeyPair(),n={amount:parseInt(r)||0,serial:Math.random().toString(36).substring(2,10).toUpperCase(),timestamp:Math.floor((Date.now()-Constants.EPOCH)/1e3),ephemeralPublicKey:o.publicKey,signatureOne:null,signatureTwo:null},s=e(n);n.signatureOne=await BankCrypto.signData(s,o.privateKey);const a=t(n);return n.signatureTwo=await BankCrypto.signData(a,state.masterPrivateKey),n},o=e=>{const t={a:e.amount,s:e.serial,t:e.timestamp,epk:Utils.arrayBufferToBase64(e.ephemeralPublicKey),s1:Utils.arrayBufferToBase64(e.signatureOne),s2:Utils.arrayBufferToBase64(e.signatureTwo)};return JSON.stringify(t)},n=e=>{const t=JSON.parse(e);return{amount:t.a,serial:t.s,timestamp:t.t,ephemeralPublicKey:Utils.base64ToUint8Array(t.epk),signatureOne:Utils.base64ToUint8Array(t.s1),signatureTwo:Utils.base64ToUint8Array(t.s2)}},s=async()=>{if(!state.masterPrivateKey)return void alert("Master Private Key is not active. Please activate it in Step 2.");Utils.updateStatus(DOMElements.banknoteStatus,"‚è≥ Creating and displaying banknote...","info");try{const e=await r(DOMElements.amountInput.value),t=o(e);await BanknoteDrawer.drawNoteOnCanvas(DOMElements.noteCanvas,e,t,1200,533),Utils.updateStatus(DOMElements.banknoteStatus,"‚úÖ New banknote designed. For security, the key has been cleared. Re-activate to create more.","success")}catch(e){Utils.updateStatus(DOMElements.banknoteStatus,`‚ùå Error: ${e.message}`,"error"),console.error(e)}finally{state.masterPrivateKey&&(state.masterPrivateKey=null,DOMElements.createNoteButton.disabled=!0,DOMElements.downloadBatchButton.disabled=!0,UIHandlers.handlePasswordKeyInput({target:{value:null}}),DOMElements.passwordKeyInput.value="",Utils.updateStatus(DOMElements.keyReconstructionStatus,"‚ö†Ô∏è Master Private Key is INACTIVE. For security, it has been cleared from memory. Solve the puzzle again to activate.","warning"),Utils.log("Key cleared for security after single note creation.","warning"))}},a=async()=>{if(!state.masterPrivateKey)return void alert("Master Private Key is not active. Please activate it in Step 2.");const e=parseInt(DOMElements.quantityInput.value)||1;if(Utils.updateStatus(DOMElements.banknoteStatus,`‚è≥ Preparing to create ${e} banknote(s)...`,"info"),e>1&&!window.showDirectoryPicker)Utils.log("Directory Picker API not available. Falling back to individual downloads.","warning"),alert("Your browser or security context does not support directory selection.\n\nThe banknotes will be downloaded individually to your default 'Downloads' folder.");try{const t=document.createElement("canvas");t.width=1200,t.height=533;const n=[],s=DOMElements.amountInput.value;Utils.updateStatus(DOMElements.banknoteStatus,`‚è≥ Generating ${e} banknote(s) in memory...`,"info");for(let a=0;a<e;a++){const e=await r(s),i=o(e);await BanknoteDrawer.drawNoteOnCanvas(t,e,i,1200,533);const l=await new Promise(e=>t.toBlob(e,"image/png"));n.push({blob:l,filename:`SADAT-NOTE-${e.serial}.png`}),a===e-1&&await BanknoteDrawer.drawNoteOnCanvas(DOMElements.noteCanvas,e,i,1200,533)}if(window.showDirectoryPicker&&e>1){Utils.updateStatus(DOMElements.banknoteStatus,"‚ÑπÔ∏è Please select a folder to save the banknotes.","info");const t=await window.showDirectoryPicker();Utils.updateStatus(DOMElements.banknoteStatus,`‚è≥ Saving ${e} notes to your selected folder...`,"info");for(const r of n){const e=await t.getFileHandle(r.filename,{create:!0}),o=await e.createWritable();await o.write(r.blob),await o.close()}Utils.updateStatus(DOMElements.banknoteStatus,`‚úÖ Saved ${e} notes to your selected folder.`,"success")}else Utils.updateStatus(DOMElements.banknoteStatus,`‚è≥ Downloading ${e} note(s) individually...`,"info"),n.forEach(e=>Utils.downloadFile(e.blob,e.filename,"image/png")),Utils.updateStatus(DOMElements.banknoteStatus,`‚úÖ Saved ${e} note(s). Check your downloads folder.`,"success")}catch(e){Utils.updateStatus(DOMElements.banknoteStatus,`‚ùå Operation cancelled or failed: ${e.message}`,"error"),console.error(e)}finally{state.masterPrivateKey=null,DOMElements.createNoteButton.disabled=!0,DOMElements.downloadBatchButton.disabled=!0,UIHandlers.handlePasswordKeyInput({target:{value:null}}),DOMElements.passwordKeyInput.value="",Utils.updateStatus(DOMElements.keyReconstructionStatus,"‚ö†Ô∏è Master Private Key is INACTIVE. For security, it has been cleared from memory. Solve the puzzle again to activate.","warning"),Utils.log("Key cleared for security after batch operation.","warning")}};async function i(e){return new Promise((t,r)=>{const o=new FileReader;o.onload=e=>{const n=new Image;n.onload=()=>{const e=document.createElement("canvas"),o=n.naturalWidth,s=n.naturalHeight,a=Math.min(1500/o,1500/s,1);e.width=o*a,e.height=s*a;const i=e.getContext("2d");i.drawImage(n,0,0,e.width,e.height);let l=i.getImageData(0,0,e.width,e.height);const c=[];for(;;){const e=jsQR(l.data,l.width,l.height,{inversionAttempts:"dontInvert"});if(!e)break;{c.push(e);const t=e.location;i.beginPath(),i.moveTo(t.topLeftCorner.x,t.topLeftCorner.y),i.lineTo(t.topRightCorner.x,t.topRightCorner.y),i.lineTo(t.bottomRightCorner.x,t.bottomRightCorner.y),i.lineTo(t.bottomLeftCorner.x,t.bottomLeftCorner.y),i.closePath(),i.fillStyle="black",i.fill(),l=i.getImageData(0,0,e.width,e.height)}}c.length>0?t(c):r(new Error("No QR codes found on the banknote image."))},n.onerror=()=>r(new Error("Could not load banknote image file.")),n.src=e.target.result},o.onerror=()=>r(new Error("Could not read file.")),o.readAsDataURL(e)})}return{handleCreateAndSignNotes:s,handleDownloadBatch:a,handleFileSelectForValidation:async r=>{const s=r.target.files[0];if(!s||!state.masterPublicKey)return void Utils.updateStatus(DOMElements.validationResult,"‚ùå Load a Master Public Key in Step 1 before validating.","error");const a=DOMElements.validationResult;Utils.updateStatus(a,"‚è≥ Reading banknote image... Please wait.","info");try{const r=await i(s);let c=`<span class="info">‚ÑπÔ∏è Found ${r.length} QR code(s). Assembling payload...</span>\n`;a.innerHTML=c;const d={};let u=0;for(const e of r)if(e.data.startsWith(Constants.VALIDATION_PREFIX)){const t=e.data.substring(Constants.VALIDATION_PREFIX.length),r=t.match(/^(\d)\/3:(.*)$/s);r&&(d[r[1]]=r[2],u++)}if(u<3)return void Utils.updateStatus(a,`‚ùå Incomplete banknote data. Found ${u}/3 essential QR codes. The banknote may be damaged or fake.`,"error");c+=`<span class="valid">‚úÖ Found all 3 parts. Reconstructing payload...</span>\n`,a.innerHTML=c;const p=d["1"]+d["2"]+d["3"],y=n(p);c+=`<span class="info">‚ÑπÔ∏è Verifying Ephemeral Signature (Sig 1)...</span>\n`,a.innerHTML=c;const m=e(y),g=await BankCrypto.verifySignature(y.signatureOne,m,y.ephemeralPublicKey);if(!g)return c+='<span class="invalid">‚ùå Ephemeral Signature (Sig 1) INVALID.</span>\n<hr><span>‚ùå VERDICT: FORGERY</span>',void(a.innerHTML=c);c+='<span class="valid">‚úÖ Ephemeral Signature (Sig 1) OK.</span>\n',c+=`<span class="info">‚ÑπÔ∏è Verifying Master Signature (Sig 2)...</span>\n`,a.innerHTML=c;const f=t(y),k=await BankCrypto.verifySignature(y.signatureTwo,f,state.masterPublicKey);if(!k)return c+='<span class="invalid">‚ùå Master Signature (Sig 2) INVALID.</span>\n<hr><span>‚ùå VERDICT: FORGERY (Not issued by this Guardian)</span>',void(a.innerHTML=c);c+='<span class="valid">‚úÖ Master Signature (Sig 2) OK.</span>\n<hr><span style="font-size:14px;font-weight:600;">‚úÖ VERDICT: BANKNOTE IS AUTHENTIC</span>',a.innerHTML=c}catch(e){Utils.updateStatus(a,`‚ùå Validation Error: ${e.message}.`,"error"),console.error(e)}finally{r.target.value=""}}}}();
const BanknoteDrawer=function(){const e=(e,t,r,o)=>r+(parseInt(e.substring(t,t+2),16)%(o-r+1));function t(t,r,o,n){t.save(),t.globalCompositeOperation="lighter",t.globalAlpha=.15;const s=`hsl(${e(r,4,0,360)}, 70%, 50%)`,a=`hsl(${e(r,6,0,360)}, 70%, 50%)`;for(let i=0;i<20;i++){t.strokeStyle=i%2==0?s:a,t.lineWidth=1+i%3,t.beginPath();let l=e(r,10+i,0,360),c=n*.3*e(r,30+i,50,100)/100;for(let e=0;e<o;e++){let r=n/2+Math.sin(e/80+l)*c;0===e?t.moveTo(e,r):t.lineTo(e,r)}t.stroke()}t.restore()}return{drawNoteOnCanvas:async(r,o,n,s,a)=>{const i=r.getContext("2d"),{amount:l,serial:c,signatureTwo:d}=o,u=s/1200,p=shake256(Utils.arrayBufferToBase64(d),256),y=i.createLinearGradient(0,0,0,a),m=e(p,0,0,360);y.addColorStop(0,`hsl(${m}, 50%, 6%)`),y.addColorStop(1,`hsl(${m}, 40%, 4%)`),i.fillStyle=y,i.fillRect(0,0,s,a),t(i,p,s,a);const g=n.length,f=Math.ceil(g/3),k=Math.ceil(g/3),v=n.substring(0,f),w=n.substring(f,f+k),b=n.substring(f+k),D=`${Constants.VALIDATION_PREFIX}1/3:${v}`,B=`${Constants.VALIDATION_PREFIX}2/3:${w}`,x=`${Constants.VALIDATION_PREFIX}3/3:${b}`,L=350*u,E=await Utils.createQrCanvas(D,L,"transparent"),C=await Utils.createQrCanvas(B,L,"transparent"),S=await Utils.createQrCanvas(x,L,"transparent");i.shadowColor="rgba(0,0,0,0.7)",i.shadowBlur=8*u,i.shadowOffsetX=2*u,i.shadowOffsetY=2*u,i.textAlign="left",i.font=`bold ${24*u}px 'Roboto Mono'`,i.fillStyle=`hsla(${m}, 100%, 80%, 0.9)`,i.fillText(c,40*u,50*u),i.textAlign="center",i.font=`bold ${32*u}px 'Roboto Mono'`,i.fillStyle="rgba(255,255,255,0.7)",i.fillText("SADAT DIGITAL RESERVE NOTE",s/2,a*.15),i.font=`bold ${90*u}px 'Roboto Mono'`,i.fillStyle="#EAEAEA",i.fillText(l.toLocaleString("en-US"),s/2,a*.35),i.shadowColor="transparent";const_ =a*.38,M=40*u,A=3*L+2*M,R=(s-A)/2,N=R,P=R+L+M,I=R+2*L+2*M;i.shadowColor="hsla(0, 0%, 0%, 0.5)",i.shadowBlur=15*u,i.fillStyle="white",i.globalAlpha=.95,i.fillRect(N,_,L,L),i.fillRect(P,_,L,L),i.fillRect(I,_,L,L),i.globalAlpha=1,i.drawImage(E,N,_),i.drawImage(C,P,_),i.drawImage(S,I,_),i.shadowColor="transparent",i.strokeStyle=`hsla(${m}, 50%, 30%, 0.8)`,i.lineWidth=2*u;const q=_+L/2;i.beginPath(),i.moveTo(N+L,q),i.lineTo(P,q),i.moveTo(P+L,q),i.lineTo(I,q),i.stroke()}}}();
async function main(){Utils.updateStatus(DOMElements.keyGenStatus,"‚è≥ Loading Falcon-1024 & QR Modules...","info");try{state.falconApi=await pqcSignFalcon1024(),Utils.updateStatus(DOMElements.keyGenStatus,"‚úÖ Modules loaded. Please generate or import keys to begin.","success"),Utils.log("All cryptographic and QR modules initialized successfully.","success")}catch(e){return Utils.log(`Critical Error: Could not load required modules: ${e.message}`,"error"),Utils.updateStatus(DOMElements.keyGenStatus,"‚ùå Critical Error: Could not load modules. See console for details.","error"),void alert("Error: Failed to load a required cryptographic module. The application cannot run.")}DOMElements.generateKeysButton.addEventListener("click",UIHandlers.handleGenerateAndExportKeys),DOMElements.importPublicKey.addEventListener("change",UIHandlers.handleImportPublicKey),DOMElements.fileKeyInput.addEventListener("change",UIHandlers.handleFileKeyInput),DOMElements.passwordKeyInput.addEventListener("input",UIHandlers.handlePasswordKeyInput),DOMElements.visualKeyInput.addEventListener("change",UIHandlers.handleVisualKeyInput),DOMElements.reconstructKeyButton.addEventListener("click",UIHandlers.handleReconstructKey),DOMElements.createNoteButton.addEventListener("click",BanknoteLogic.handleCreateAndSignNotes),DOMElements.downloadBatchButton.addEventListener("click",BanknoteLogic.handleDownloadBatch),DOMElements.validatorInput.addEventListener("change",BanknoteLogic.handleFileSelectForValidation),DOMElements.downloadQrButton.addEventListener("click",()=>{const e=DOMElements.qrDisplay.querySelector("canvas");if(e){const t=document.createElement("a");t.href=e.toDataURL("image/png"),t.download="Sadat-VISUAL-KEY.png",document.body.appendChild(t),t.click(),document.body.removeChild(t)}});const e=DOMElements.noteCanvas,t=e.getContext("2d"),r=t.createLinearGradient(0,0,0,e.height);r.addColorStop(0,"hsl(250, 50%, 6%)"),r.addColorStop(1,"hsl(260, 40%, 4%)"),t.fillStyle=r,t.fillRect(0,0,e.width,e.height),t.font="bold 30px 'Poppins'",t.textAlign="center",t.fillStyle="rgba(255,255,255,0.4)",t.fillText("Banknote design will appear here after creation",e.width/2,e.height/2)}main();
</script>
</body>
</html>
