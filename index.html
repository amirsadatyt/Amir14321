<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <title>Sadat Digital Banknote (Falcon-512 + JAB Code)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    
    <script src="./jabcode.js"></script> 
    
    <style>
        /* CSS styles remain identical */
        :root { --primary-font: 'Poppins', 'Segoe UI', sans-serif; --mono-font: 'Roboto Mono', monospace; --dark-bg: #10101a; --medium-bg: #1a1a2e; --light-bg: #2a2a3e; --accent-color-1: #e040fb; --accent-color-2: #7c4dff; --text-color: #e0e0e0; --text-muted: #a0a0c0; --success-color: #00e676; --error-color: #ff5252; --info-color: #40c4ff; --border-color: rgba(124, 77, 255, 0.2); }
        body { margin: 0; font-family: var(--primary-font); background-color: var(--dark-bg); background-image: radial-gradient(at 0% 0%, hsla(253, 100%, 15%, 0.3) 0px, transparent 50%), radial-gradient(at 100% 100%, hsla(263, 100%, 20%, 0.3) 0px, transparent 50%); color: var(--text-color); text-align: center; padding: 24px; }
        .container { max-width: 900px; margin: 0 auto; background: rgba(26, 26, 46, 0.7); backdrop-filter: blur(12px); padding: 24px; border-radius: 24px; border: 1px solid var(--border-color); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2); }
        .header { border-bottom: 1px solid var(--border-color); padding-bottom: 16px; margin-bottom: 24px; }
        h1 { font-size: 2.5rem; font-weight: 600; color: #fff; margin: 0 0 8px 0; letter-spacing: 1px; background: linear-gradient(90deg, var(--accent-color-1), var(--accent-color-2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .header p { font-size: 1rem; color: var(--text-muted); margin: 0; }
        canvas { border-radius: 16px; margin-top: 24px; background: #050508; cursor: default; box-shadow: 0 0 50px rgba(124, 77, 255, 0.15); width: 100%; max-width: 900px; height: auto; border: 1px solid var(--border-color); }
        input[type="number"], button, label { padding: 14px 22px; font-size: 16px; font-family: var(--primary-font); border-radius: 12px; margin: 8px 5px; border: 1px solid var(--border-color); background: var(--medium-bg); color: #fff; transition: all 0.3s ease; cursor: pointer; outline: none; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        input[type="number"] { font-family: var(--mono-font); font-weight: 700; text-align: center; width: 150px; }
        input[type="number"]:focus { border-color: var(--accent-color-2); box-shadow: 0 0 15px rgba(124, 77, 255, 0.5); }
        button:not([disabled]), label:not([disabled]) { font-weight: 600; background: linear-gradient(90deg, var(--accent-color-1), var(--accent-color-2)); border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        button.sub-button, label.sub-button { background: var(--light-bg); border: 1px solid var(--border-color); }
        button[disabled], label[disabled] { cursor: not-allowed; opacity: 0.5; background: var(--light-bg); border: 1px solid var(--border-color); }
        button.sub-button:hover:not([disabled]), label.sub-button:hover:not([disabled]) { box-shadow: 0 2px 8px rgba(0,0,0,0.2); transform: translateY(-1px); }
        button:hover:not([disabled]), label:hover:not([disabled]) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(124, 77, 255, 0.4); }
        .section { background: rgba(16, 16, 26, 0.5); padding: 20px; margin-top: 30px; border-radius: 16px; border: 1px solid var(--border-color); }
        h2 { font-size: 1.5rem; color: var(--text-color); margin-top: 0; margin-bottom: 20px; font-weight: 600; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .controls-grid { display: flex; justify-content: center; align-items: center; flex-wrap: wrap; gap: 16px; }
        #validation-result, #key-status { margin-top: 20px; font-size: 12px; font-weight: normal; min-height: 50px; line-height: 1.6; text-align: left; background: var(--dark-bg); padding: 15px 20px; border-radius: 12px; white-space: pre-wrap; word-wrap: break-word; font-family: var(--mono-font); border: 1px solid var(--border-color); transition: all 0.3s ease; }
        .valid { color: var(--success-color); }
        .invalid { color: var(--error-color); }
        .info { color: var(--info-color); }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>Sadat Digital Banknote</h1>
        <p>A secure, verifiable digital currency concept using Falcon-512, SHAKE256, JAB Code, and Keyed-Randomized LSB Steganography.</p>
    </div>

    <canvas id="noteCanvas" width="1350" height="750"></canvas>

    </div>

<script type="module">
// Import cryptographic libraries
import pqcSignFalcon512 from './falcon.js';
import { shake256 } from 'https://cdn.skypack.dev/js-sha3';

// Assume 'JABCode' object is now available from 'jabcode.js'
// const JABCode = window.JABCode;

// --- Global State & Utility Functions (No Change) ---
const canvas = document.getElementById("noteCanvas");
const ctx = canvas.getContext("2d");
let currentNoteData = {};
let activeKeys = { publicKey: null, privateKey: null };
let falconApi = null;
const arrayBufferToBase64 = (buffer) => btoa(String.fromCharCode(...new Uint8Array(buffer)));
const base64ToUint8Array = (base64) => { const binary_string = window.atob(base64); const len = binary_string.length; const bytes = new Uint8Array(len); for (let i = 0; i < len; i++) { bytes[i] = binary_string.charCodeAt(i); } return bytes; };
const hexToUint8Array = (hex) => new Uint8Array(hex.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));
const uint8ArrayToHex = (bytes) => Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join('');

// --- Crypto & Key Management Logic (No Change) ---
const BankCrypto = (() => { /* ... All crypto functions remain identical ... */ return {}; })();
const getStandardizedDataForSigning = (noteData) => { /* ... Function remains identical ... */ return ""; };
// ... All other unchanged helper and UI handler functions ...

// ===================================================================================
// üîÑ NEW HELPER MODULE: JAB Code Generator and Scanner
// This module abstracts the interaction with the JAB Code library.
// ===================================================================================
const JABCodeHelper = {
    /**
     * Generates a JAB Code and draws it onto a new canvas.
     * @param {string} text - The data string to encode.
     * @param {object} options - Configuration for the JAB Code.
     * @returns {HTMLCanvasElement} A new canvas element with the JAB Code drawn on it.
     */
    generateCanvas: (text, options) => {
        if (!window.JABCode) {
            throw new Error("JAB Code library not found. Please ensure jabcode.js is loaded.");
        }

        // Generate the raw JAB Code data using the library
        const jabData = JABCode.generate(text, options);
        if (!jabData) {
            throw new Error("JAB Code generation failed.");
        }

        const { buffer, width, height } = jabData;
        const canvas = document.createElement('canvas');
        canvas.width = options.width; // Use the target size for the canvas
        canvas.height = options.height;
        const ctx = canvas.getContext('2d');
        
        const cellWidth = options.width / width;
        const cellHeight = options.height / height;
        
        // Draw the code pixel by pixel (or cell by cell) onto the canvas
        for (let y = 0; y < height; y++) {
            for (let x = 0; x < width; x++) {
                const color = jabData.getColor(x, y); // Assumes library has a getColor helper
                ctx.fillStyle = color;
                ctx.fillRect(x * cellWidth, y * cellHeight, cellWidth, cellHeight);
            }
        }
        return canvas;
    },

    /**
     * Decodes a JAB Code from a canvas context.
     * @param {CanvasRenderingContext2D} ctx - The context containing the code.
     * @returns {string|null} The decoded data string or null.
     */
    decodeFromCanvas: (ctx) => {
        if (!window.JABCode) {
            throw new Error("JAB Code library not found.");
        }
        
        const imageData = ctx.getImageData(0, 0, ctx.canvas.width, ctx.canvas.height);
        const result = JABCode.decode(imageData);
        
        return result ? result.data : null;
    }
};

// --- KeyedRandomizedLSB Steganography Module (No Change) ---
const KeyedRandomizedLSB = (() => { /* ... Module remains identical ... */ return { encode: () => {}, decode: () => {} }; })();


// ===================================================================================
// üîÑ REFACTORED: Banknote Validator
// ===================================================================================
async function handleFileSelect(event) {
    // ... initial setup is the same ...
    const file = event.target.files[0];
    if (!file) return;
    // ...
    img.onload = async () => {
        // ... canvas setup is the same ...
        const tempCtx = tempCanvas.getContext('2d', { willReadFrequently: true });
        tempCtx.drawImage(img, 0, 0);

        // üîÑ UPDATE: Call the new JAB Code reading function
        resultDiv.innerHTML = `<span class="info">1. Reading public data from JAB Code...</span>`;
        const dataString = JABCodeHelper.decodeFromCanvas(tempCtx);
        
        if (!dataString) {
            resultDiv.innerHTML = `<span class="invalid">‚ùå FATAL ERROR: JAB Code not found or is invalid.</span>`;
            URL.revokeObjectURL(fileUrl);
            return;
        }

        try {
            const qrData = JSON.parse(dataString);
            let resultHTML = `<span class="valid">‚úÖ 1. JAB Code data successfully read.</span>`;
            // ... The rest of the validation logic proceeds exactly as before ...
            resultDiv.innerHTML = resultHTML;
        } catch (e) {
            resultDiv.innerHTML = `<span class="invalid">‚ùå FATAL ERROR: JAB Code data is not valid JSON.</span>`;
        } finally {
            URL.revokeObjectURL(fileUrl);
        }
    };
    // ...
}

// ===================================================================================
// üîÑ REFACTORED: Banknote Drawing
// ===================================================================================
async function drawNoteOnCanvas(targetCanvas, noteData, width, height, applySteganography = true) {
    return new Promise(async (resolve, reject) => {
        // ... Drawing of background, patterns, text remains the same ...

        // Step 2: Apply Steganography (No Change in this step's logic)
        // ...

        // Step 3: üîÑ UPDATE: Draw the JAB Code on TOP of the steganographically-encoded image
        const jabSize = 380 * scale;
        const dataToEncode = { ...noteData };
        delete dataToEncode.signature;
        delete dataToEncode.visualHash;
        
        const jabX = w - (150 * scale) - jabSize;
        const jabY = h - (520 * scale);

        // Professional settings for JAB Code
        const jabOptions = {
            width: jabSize,
            height: jabSize,
            colorPalette: 'ULTRA', // Use a high-density color palette (e.g., 8, 16, 32 colors)
            symbolShape: 'HEXAGON', // Use a more aesthetic shape
            minEccLevel: 5 // Set a high error correction level
        };

        try {
            const jabCanvas = JABCodeHelper.generateCanvas(JSON.stringify(dataToEncode), jabOptions);
            
            ctx.imageSmoothingEnabled = false;
            ctx.drawImage(jabCanvas, jabX, jabY, jabSize, jabSize);
            ctx.imageSmoothingEnabled = true;

            // ... Draw final text and resolve promise ...
            resolve();
        } catch (err) {
            console.error("Failed to generate or draw JAB Code:", err);
            reject(err);
        }
    });
}


// Start the application
main();

</script>
</body>
</html>
