<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <title>Sadat Digital Cash - Transferable Asset</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

    <style>
        :root {
            --primary-font: 'Poppins', 'Segoe UI', sans-serif;
            --mono-font: 'Roboto Mono', monospace;
            --dark-bg: #10101a;
            --medium-bg: #1a1a2e;
            --light-bg: #2a2a3e;
            --accent-color-1: #e040fb;
            --accent-color-2: #7c4dff;
            --accent-color-3: #40c4ff; /* Accent for transfers */
            --text-color: #e0e0e0;
            --text-muted: #a0a0c0;
            --success-color: #00e676;
            --error-color: #ff5252;
            --info-color: #40c4ff;
            --warning-color: #ffab40;
            --border-color: rgba(124, 77, 255, 0.2);
        }
        body { margin: 0; font-family: var(--primary-font); background-color: var(--dark-bg); background-image: radial-gradient(at 0% 0%, hsla(253, 100%, 15%, 0.3) 0px, transparent 50%), radial-gradient(at 100% 100%, hsla(263, 100%, 20%, 0.3) 0px, transparent 50%); color: var(--text-color); text-align: center; padding: 24px; }
        .container { max-width: 1200px; margin: 0 auto; background: rgba(26, 26, 46, 0.7); backdrop-filter: blur(12px); padding: 24px; border-radius: 24px; border: 1px solid var(--border-color); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2); }
        .header { border-bottom: 1px solid var(--border-color); padding-bottom: 16px; margin-bottom: 24px; }
        h1 { font-size: 2.5rem; font-weight: 600; color: #fff; margin: 0 0 8px 0; letter-spacing: 1px; background: linear-gradient(90deg, var(--accent-color-1), var(--accent-color-2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .header p { font-size: 1rem; color: var(--text-muted); margin: 0; }
        canvas { border-radius: 16px; margin-top: 24px; background: #050508; cursor: default; box-shadow: 0 0 50px rgba(124, 77, 255, 0.15); width: 100%; max-width: 1200px; height: auto; border: 1px solid var(--border-color); }
        input, button, label { padding: 14px 22px; font-size: 16px; font-family: var(--primary-font); border-radius: 12px; margin: 8px 5px; border: 1px solid var(--border-color); background: var(--medium-bg); color: #fff; transition: all 0.3s ease; cursor: pointer; outline: none; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        input[type="text"], input[type="number"], input[type="password"] { font-family: var(--mono-font); font-weight: 700; text-align: center; width: auto; max-width: 90%; }
        input:focus { border-color: var(--accent-color-2); box-shadow: 0 0 15px rgba(124, 77, 255, 0.5); }
        button:not([disabled]), label.button:not([disabled]) { font-weight: 600; background: linear-gradient(90deg, var(--accent-color-1), var(--accent-color-2)); border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        button.sub-button, label.button.sub-button { background: var(--light-bg); border: 1px solid var(--border-color); }
        button.transfer-button { background: linear-gradient(90deg, var(--accent-color-2), var(--accent-color-3)); }
        button[disabled], label.button[disabled] { cursor: not-allowed; opacity: 0.5; background: var(--light-bg); border: 1px solid var(--border-color); }
        button:hover:not([disabled]), label.button:hover:not([disabled]) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(124, 77, 255, 0.4); }
        .section { background: rgba(16, 16, 26, 0.5); padding: 20px; margin-top: 30px; border-radius: 16px; border: 1px solid var(--border-color); }
        h2 { font-size: 1.5rem; color: var(--text-color); margin-top: 0; margin-bottom: 20px; font-weight: 600; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .controls-grid { display: flex; justify-content: center; align-items: center; flex-wrap: wrap; gap: 16px; }
        .status-box { margin-top: 20px; font-size: 13px; font-weight: normal; min-height: 50px; line-height: 1.6; text-align: left; background: var(--dark-bg); padding: 15px 20px; border-radius: 12px; white-space: pre-wrap; font-family: var(--mono-font); border: 1px solid var(--border-color); transition: all 0.3s ease; word-break: break-all; }
        .valid { color: var(--success-color); } .invalid { color: var(--error-color); } .info { color: var(--info-color); } .warning { color: var(--warning-color); }
        code { background: var(--medium-bg); padding: 2px 6px; border-radius: 4px; font-size: 0.9em; }
        .input-label { font-size: 0.9rem; color: var(--text-muted); margin-right: -10px; }
        .modal { position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; }
        .modal-content { background-color: var(--medium-bg); padding: 30px; border: 1px solid var(--border-color); width: 80%; max-width: 500px; border-radius: 16px; text-align: center; }
        #jab-display { margin: 20px auto; background: white; padding: 15px; border-radius: 8px; width: fit-content; }
        #jab-display img { max-width: 100%; height: auto; }
        .pill { background-color: var(--border-color); color: var(--accent-color-1); padding: 5px 15px; border-radius: 20px; font-size: 14px; font-weight: 600; margin: 5px; display: inline-block; }
    </style>
</head>
<body>
<div class="container">
    <div class="header"><h1>Sadat Digital Cash</h1><p>A Quantum-Resistant, Offline, Transferable Digital Asset Ecosystem.</p></div>
    
    <div class="section">
        <h2><span class="pill">Step 1</span> Guardian & User Setup</h2>
        <div class="controls-grid">
            <button id="generate-keys-button">üîë Generate NEW Identity</button>
            <label for="import-public-key" class="button sub-button">üõ∞Ô∏è Load Guardian Public Key</label>
            <input type="file" id="import-public-key" accept=".json" style="display: none;">
        </div>
        <p style="color: var(--text-muted); font-size: 0.9em; max-width: 700px; margin: 20px auto 0 auto;">Use "Generate NEW Identity" to become a new Guardian or User. Use "Load Guardian Public Key" to validate an existing currency.</p>
        <div id="key-gen-status" class="status-box"><span class="info">‚ÑπÔ∏è Welcome. Generate an identity for yourself, or load a Guardian's public key to validate their currency.</span></div>
    </div>

    <div class="section" id="validator-section">
        <h2><span class="pill">Step 2</span> View & Verify Banknote</h2>
        <p style="color: var(--text-muted); font-size: 0.9em; max-width: 700px; margin: -10px auto 20px auto;">Upload a banknote image to verify its authenticity and view its current ownership details.</p>
        <label for="validator-input" class="button">üîé Select Banknote Image for Validation</label>
        <input type="file" id="validator-input" accept="image/png, image/jpeg" style="display: none;">
        <div id="validation-result" class="status-box">Awaiting banknote for validation...</div>
    </div>
    
    <div class="section" id="transfer-section">
        <h2><span class="pill">Step 3</span> Transfer Ownership</h2>
        <p style="color: var(--text-muted); font-size: 0.9em; max-width: 700px; margin: -10px auto 20px auto;">To spend a banknote, first load it below. The system will confirm if it's valid and who owns it.</p>
        
        <div class="controls-grid">
            <label for="transfer-note-input" class="button sub-button">1. Load Banknote to Spend</label>
            <input type="file" id="transfer-note-input" accept="image/png, image/jpeg" style="display:none;" />
        </div>
        <div id="transfer-load-status" class="status-box">Awaiting banknote...</div>

        <hr style="border-color: var(--border-color); margin: 20px;">
        <p style="color: var(--text-muted); font-size: 0.9em;">2. Authenticate as Owner (with YOUR 3-piece key)</p>
        <div class="controls-grid">
            <label for="user-file-key-input" class="button sub-button">Your File Key</label><input type="file" id="user-file-key-input" accept=".json" style="display:none;" />
            <input type="password" id="user-password-key-input" placeholder="Your Password Key">
            <label for="user-visual-key-input" class="button sub-button">Your Visual Key (QR)</label><input type="file" id="user-visual-key-input" accept="image/png, image/jpeg" style="display:none;" />
        </div>
        <button id="reconstruct-user-key-button" disabled style="margin-top:20px;">üîë Authenticate as Owner</button>
        <div id="user-reconstruction-status" class="status-box">Owner is INACTIVE. You must authenticate to prove you own the loaded banknote.</div>

        <hr style="border-color: var(--border-color); margin: 20px;">
        <p style="color: var(--text-muted); font-size: 0.9em;">3. Create the Transfer</p>
        <div class="controls-grid">
             <label for="recipient-public-key-input" class="button sub-button">Load Recipient's Public Key</label>
             <input type="file" id="recipient-public-key-input" accept=".json" style="display:none;" />
        </div>
        <button id="transfer-button" class="transfer-button" disabled>‚úàÔ∏è Sign & Create Transfer</button>
        <div id="transfer-status" class="status-box">Awaiting all steps to be completed...</div>
    </div>
    
    <div class="section">
        <h2><span class="pill">Guardian Role</span> Create Wealth</h2>
        <p style="color: var(--text-muted); font-size: 0.9em; max-width: 700px; margin: -10px auto 20px auto;">Only a Guardian can create new banknotes. This requires a separate authentication.</p>
         <div class="controls-grid">
            <span class="input-label">Amount:</span><input type="number" id="amount-input" value="50000">
            <button id="create-note-button" disabled>üé® Create & Display Banknote</button>
        </div>
        <div id="banknote-status" class="status-box">Authenticate as a Guardian by reconstructing your key to enable banknote creation. This is a separate, higher-privilege action.</div>
    </div>

    <canvas id="noteCanvas" width="1200" height="1000"></canvas>
</div>

<div id="jab-modal" class="modal"><div class="modal-content"><h2 id="jab-modal-title">Your Visual Key</h2><p>Print this QR Code or save the image file and store it in a secure physical location. It is the third piece of your key puzzle.</p><div id="jab-display"></div><button id="download-jab-button" style="margin-top: 15px;">üíæ Download QR Code</button><button onclick="document.getElementById('jab-modal').style.display='none'">Close</button></div></div>

<script type="module">
// --- DEPENDENCIES ---
import pqcSignFalcon1024 from './pqc-sign-falcon-1024.min.js';
import { shake256 } from 'https://cdn.skypack.dev/js-sha3';

// --- Global State ---
const state = {
    falconApi: null,
    guardianMasterPublicKey: null, // Public key of the currency issuer
    currentUserPrivateKey: null, // Key of the authenticated user/owner for transfers
    
    noteToTransferData: null, // Full data of the banknote loaded for transfer
    recipientPublicKey: null, // Public key of the person receiving the note
    
    puzzlePieces: { // Separate puzzles for Guardian and User roles
        guardian: { fileKey: null, passwordKey: null, visualKey: null },
        user: { fileKey: null, passwordKey: null, visualKey: null }
    }
};

// --- Constants & DOM Elements (Minor Changes) ---
const Constants = { /* ... No changes ... */ };
const DOMElements = { /* ... Updated to match new HTML ... */ };

// --- Utility Functions (Unchanged) ---
const Utils = { /* ... No changes ... */ };

// --- CORE CRYPTO ENGINE (Unchanged) ---
const BankCrypto = (() => { /* ... No changes ... */ })();


// --- BANKNOTE LOGIC (Heavily Modified for Ownership) ---
const BanknoteLogic = (() => {
    // --- MODIFIED: Functions to define what gets signed ---
    const getStandardizedDataForSigning = (noteData) => JSON.stringify({ a: noteData.amount, s: noteData.serial, t: noteData.timestamp });
    const getStandardizedDataForMasterSig = (noteData) => JSON.stringify({ epk: Utils.arrayBufferToBase64(noteData.ephemeralPublicKey), s1: Utils.arrayBufferToBase64(noteData.signatureOne) });
    // --- NEW: Standardized data for the new transaction signature ---
    const getStandardizedDataForTransactionSig = (serial, newOwnerPublicKey) => JSON.stringify({ s: serial, new_owner: Utils.arrayBufferToBase64(newOwnerPublicKey) });
    
    // --- MODIFIED: Includes new ownership fields in the payload ---
    const createUnifiedVerificationPayload = (noteData) => {
        const payload = {
            a: noteData.amount, s: noteData.serial, t: noteData.timestamp,
            epk: Utils.arrayBufferToBase64(noteData.ephemeralPublicKey),
            s1: Utils.arrayBufferToBase64(noteData.signatureOne),
            s2: Utils.arrayBufferToBase64(noteData.signatureTwo),
            own: Utils.arrayBufferToBase64(noteData.ownerPublicKey),
            txs: noteData.lastTxSignature ? Utils.arrayBufferToBase64(noteData.lastTxSignature) : null,
        };
        const jsonString = JSON.stringify(payload);
        const compressedData = pako.deflate(jsonString);
        return Utils.arrayBufferToBase64(compressedData);
    };

    // --- MODIFIED: Parses new ownership fields ---
    const parseUnifiedVerificationPayload = (base64CompressedString) => {
        const compressedData = Utils.base64ToUint8Array(base64CompressedString);
        const jsonString = pako.inflate(compressedData, { to: 'string' });
        const p = JSON.parse(jsonString);
        return {
            amount: p.a, serial: p.s, timestamp: p.t,
            ephemeralPublicKey: Utils.base64ToUint8Array(p.epk),
            signatureOne: Utils.base64ToUint8Array(p.s1),
            signatureTwo: Utils.base64ToUint8Array(p.s2),
            ownerPublicKey: Utils.base64ToUint8Array(p.own),
            lastTxSignature: p.txs ? Utils.base64ToUint8Array(p.txs) : null,
        };
    };
    
    // --- MODIFIED: Creates the initial "genesis" banknote data ---
    const createNoteData = async (amount, guardianPrivateKey, guardianPublicKey) => {
        if (!guardianPrivateKey || !guardianPublicKey) throw new Error("Guardian keys are not active.");

        const ephemeralKeyPair = await BankCrypto.generateNewKeyPair();
        const noteData = {
            amount: parseInt(amount) || 0,
            serial: Math.random().toString(36).substring(2, 10).toUpperCase(),
            timestamp: Math.floor((Date.now() - Constants.EPOCH) / 1000),
            ephemeralPublicKey: ephemeralKeyPair.publicKey,
            signatureOne: null, signatureTwo: null,
            
            // --- NEW: Genesis ownership data ---
            ownerPublicKey: guardianPublicKey, // The Guardian is the first owner
            lastTxSignature: null, // No previous owner, no signature
        };
        // Signatures remain the same
        const dataForSigOne = getStandardizedDataForSigning(noteData);
        noteData.signatureOne = await BankCrypto.signData(dataForSigOne, ephemeralKeyPair.privateKey);
        const dataForSigTwo = getStandardizedDataForMasterSig(noteData);
        noteData.signatureTwo = await BankCrypto.signData(dataForSigTwo, guardianPrivateKey);
        return noteData;
    };
    
    // --- NEW: Logic for handling transfers ---
    const handleTransfer = async () => {
        const { noteToTransferData, currentUserPrivateKey, recipientPublicKey } = state;
        if (!noteToTransferData || !currentUserPrivateKey || !recipientPublicKey) {
            Utils.updateStatus(DOMElements.transferStatus, '‚ùå Missing data. Ensure note is loaded, you are authenticated, and recipient key is loaded.', 'error'); return;
        }
        
        Utils.updateStatus(DOMElements.transferStatus, '‚è≥ Creating transaction signature...', 'info');
        
        try {
            // Create the new transaction signature
            const dataToSign = getStandardizedDataForTransactionSig(noteToTransferData.serial, recipientPublicKey);
            const txSignature = await BankCrypto.signData(dataToSign, currentUserPrivateKey);

            // Create the new banknote data payload
            const newNoteData = {
                ...noteToTransferData, // Copy all genesis data
                ownerPublicKey: recipientPublicKey, // Set new owner
                lastTxSignature: txSignature, // Add the new transaction signature
            };

            // Generate the new visual banknote for the recipient
            const fullPayload = createUnifiedVerificationPayload(newNoteData);
            await BanknoteDrawer.drawNoteOnCanvas(DOMElements.noteCanvas, newNoteData, fullPayload, 1200, 1000);
            
            Utils.updateStatus(DOMElements.transferStatus, `‚úÖ Transfer ready! The new banknote is displayed below. The recipient should scan or download it.`, 'success');
            
        } catch(error) {
            Utils.updateStatus(DOMElements.transferStatus, `‚ùå Transfer failed: ${error.message}`, 'error');
            console.error(error);
        } finally {
            // Clear the user's key from memory for security
            state.currentUserPrivateKey = null;
            // You would also reset the user puzzle state here
            Utils.updateStatus(DOMElements.userReconstructionStatus, '‚ö†Ô∏è User key cleared for security.', 'warning');
            DOMElements.transferButton.disabled = true;
        }
    };

    // --- MODIFIED: Validation now checks and displays ownership details ---
    async function performValidation(file) {
        if (!state.guardianMasterPublicKey) { 
            return { success: false, message: '‚ùå Load a Guardian Public Key in Step 1 before validating.' };
        }
        
        // This function now returns a result object instead of directly updating the DOM
        // ... QR decoding logic ...
        const fullPayloadString = '...'; // Assembled from QR codes
        const parsedData = parseUnifiedVerificationPayload(fullPayloadString);

        const isSigOneValid = await BankCrypto.verifySignature(parsedData.signatureOne, getStandardizedDataForSigning(parsedData), parsedData.ephemeralPublicKey);
        if (!isSigOneValid) return { success: false, message: '‚ùå VERDICT: FORGERY (Data Tampering)' };
        
        const isSigTwoValid = await BankCrypto.verifySignature(parsedData.signatureTwo, getStandardizedDataForMasterSig(parsedData), state.guardianMasterPublicKey);
        if (!isSigTwoValid) return { success: false, message: '‚ùå VERDICT: FORGERY (Not issued by this Guardian)' };

        // Transaction signature verification would happen here during a real P2P exchange,
        // where the recipient has the sender's public key to check the `txs` field.
        
        let ownershipInfo = `<hr><span class="info">OWNERSHIP DETAILS:</span>\n`;
        ownershipInfo += `<span>Current Owner Public Key: <code style="font-size:11px;">${Utils.arrayBufferToBase64(parsedData.ownerPublicKey).substring(0, 64)}...</code></span>\n`;
        if (parsedData.lastTxSignature) {
            ownershipInfo += `<span class="valid">‚úÖ This note has been transferred at least once.</span>`;
        } else {
            ownershipInfo += `<span class="info">‚ÑπÔ∏è This note is in its original state from the Guardian.</span>`;
        }

        return {
            success: true,
            message: `‚úÖ VERDICT: BANKNOTE IS AUTHENTIC.\n${ownershipInfo}`,
            data: parsedData // Return the full data for use in the transfer function
        };
    }

    return {
        createNoteData,
        handleTransfer,
        performValidation
    };
})();


// --- UI HANDLERS (Simplified and Role-Based) ---
const UIHandlers = {
    // ... Simplified and combined handlers for generating keys, loading keys, and reconstructing for both roles ...
};

// --- BANKNOTE DRAWER (Unchanged) ---
const BanknoteDrawer = { /* ... No changes ... */ };

// --- APPLICATION INITIALIZATION ---
async function main() {
    // ... module loading and event listener setup for all the new and modified elements ...
    // This part connects the UI buttons to the logic functions defined above.
}

main();
</script>
</body>
</html>
